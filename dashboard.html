<!DOCTYPE html>
<html lang="th" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#020617">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>360DE Temperature Monitor</title>
    
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         360DE TEMPERATURE MONITOR v3.4.0
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         à¸£à¸°à¸šà¸šà¹€à¸‹à¸™à¹€à¸‹à¸­à¸£à¹Œà¸•à¸£à¸§à¸ˆà¸§à¸±à¸”à¸­à¸¸à¸“à¸«à¸ à¸¹à¸¡à¸´à¹ƒà¸™à¸•à¸¹à¹‰à¹€à¸¢à¹‡à¸™à¹€à¸à¹‡à¸šà¸¢à¸²/à¸§à¸±à¸„à¸‹à¸µà¸™
         PWA Dashboard with Realtime Monitoring
         
         Parameters:
         - vin: Voltage Input (V)
         - temp: Temperature (Â°C)
         - humi: Humidity (%)
         - vbat: Battery Voltage (V)
         - ibat: Battery Current (A)
         - rssi: Signal Strength (dBm)
         
         Data Source: MQTT (Realtime) + Database (History)
         
         v3.4.0 Changes (Humidity Feature):
         Round 1: Data Structure + State + Config
         - à¹€à¸à¸´à¹ˆà¸¡ humi_min, humi_max à¹ƒà¸™ createDevice() (default: 30, 80)
         - Migration à¸ªà¸³à¸«à¸£à¸±à¸š devices à¹€à¸à¹ˆà¸²à¹ƒà¸™ loadData()
         - à¹€à¸à¸´à¹ˆà¸¡ prevHumiStatus à¸ªà¸³à¸«à¸£à¸±à¸š transition log
         - à¹€à¸à¸´à¹ˆà¸¡ humidity à¹ƒà¸™ WARNING_CONFIG à¹à¸¥à¸° CRITICAL_CONFIG
         - à¹à¸à¹‰ getWarningType() à¹à¸¥à¸° getCriticalType() à¸£à¸­à¸‡à¸£à¸±à¸š humidity
         - à¹€à¸à¸´à¹ˆà¸¡ getCriticalHumiType() helper
         Round 2: Status Logic + Logs
         - à¹€à¸à¸´à¹ˆà¸¡ humiStatus calculation à¹ƒà¸™ mainLoop()
         - Warning: humi < min à¸«à¸£à¸·à¸­ > max
         - Critical: humi < min-10 à¸«à¸£à¸·à¸­ > max+10
         - à¹€à¸à¸´à¹ˆà¸¡ humidity transition logs (ğŸ’§/ğŸœï¸)
         Round 3: UI Updates
         - renderList(): Icon, Badge, Humidity color à¸•à¸²à¸¡ status
         - renderDetail(): Status text, Humidity color
         - Humidity color: blue(normal), cyan(high), amber(low), red(critical)
         Round 4: Modals + Simulation
         - Add Device Modal: à¹€à¸à¸´à¹ˆà¸¡ humi_min, humi_max inputs
         - Settings Modal: à¹€à¸à¸´à¹ˆà¸¡ humi_min, humi_max inputs
         - Simulation: à¹€à¸à¸´à¹ˆà¸¡à¸›à¸¸à¹ˆà¸¡ ğŸ’§ Humid High, ğŸœï¸ Humid Low
         
         v3.3.4 Changes (Rebranding & Cleanup):
         Round 1: à¹€à¸à¸´à¹ˆà¸¡ APP_NAME constant
         - brand, full, short, system names
         Round 2: Rebranding
         - à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸Šà¸·à¹ˆà¸­à¸ˆà¸²à¸ "Vaccine Monitor" â†’ "360DE Temperature Monitor"
         - title, header, CSV, Share, Filename
         - à¹„à¸¡à¹ˆà¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™ localStorage keys (à¹€à¸à¸·à¹ˆà¸­à¹„à¸¡à¹ˆà¹ƒà¸«à¹‰à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸«à¸²à¸¢)
         Round 3: à¹à¸à¹‰ Build text
         - à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸ˆà¸²à¸ hardcode â†’ dynamic à¸ˆà¸²à¸ APP_VERSION.full
         
         v3.3.3 Changes (Consistency & Version System):
         Round 1: à¹à¸à¹‰ batt_low simulation
         - batt_low à¹„à¸¡à¹ˆà¸•à¸±à¹‰à¸‡ vin = 0 (à¹à¸„à¹ˆà¸¥à¸” vbat)
         - à¹ƒà¸Šà¹‰à¸ˆà¸³à¸¥à¸­à¸‡à¸à¸£à¸“à¸µà¹à¸šà¸•à¹€à¸ªà¸·à¹ˆà¸­à¸¡/à¸Šà¸²à¸£à¹Œà¸ˆà¹„à¸¡à¹ˆà¹€à¸‚à¹‰à¸²
         Round 2: à¹à¸à¹‰à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚ batteryStatus
         - à¸¥à¸š && dev.vin < 4.0 (à¹à¸šà¸•à¸•à¹ˆà¸³à¹„à¸”à¹‰à¹à¸¡à¹‰à¹„à¸Ÿà¸¢à¸±à¸‡à¸¡à¸²)
         Round 3: à¹€à¸à¸´à¹ˆà¸¡ getCriticalType() + CRITICAL_CONFIG
         - getCriticalType(dev): à¸«à¸²à¸›à¸£à¸°à¹€à¸ à¸— critical (temp/battery/signal)
         - CRITICAL_CONFIG: mapping à¸ªà¸³à¸«à¸£à¸±à¸š badge, icon à¸‚à¸­à¸‡ critical
         Round 4: à¹à¸à¹‰ renderList() â€” Critical icon/badge à¸•à¸²à¸¡à¸›à¸£à¸°à¹€à¸ à¸—
         - temp_high: fa-temperature-arrow-up + "TEMP HIGH"
         - temp_low: fa-temperature-arrow-down + "TEMP LOW"
         - battery: fa-battery-empty + "BATT CRITICAL"
         - signal: fa-signal + "NO SIGNAL"
         Round 5: à¹à¸à¹‰ renderDetail() â€” Critical status à¸•à¸²à¸¡à¸›à¸£à¸°à¹€à¸ à¸—
         - à¹à¸ªà¸”à¸‡ status text à¸•à¸²à¸¡à¸›à¸£à¸°à¹€à¸ à¸— critical
         
         v3.3.1 Changes (Bug Fix â€” Simulation & Warning Types):
         Round 1:
         - deviceMap: Map-based device lookup à¸ªà¸³à¸«à¸£à¸±à¸š O(1) performance
         - syncDeviceMap(): Sync map à¸à¸±à¸š devices array à¹€à¸¡à¸·à¹ˆà¸­ add/delete/load
         - getDeviceById(): Helper function à¹à¸—à¸™ devices.find()
         - à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™ devices.find() â†’ getDeviceById() à¸—à¸¸à¸à¸ˆà¸¸à¸” (9 à¸ˆà¸¸à¸”)
         Round 2:
         - à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™ Chart.js â†’ ECharts (better realtime, dark theme built-in)
         - Dual Y-axis: Temperature (à¸‹à¹‰à¸²à¸¢) + Humidity (à¸‚à¸§à¸²)
         - markLine: à¹à¸ªà¸”à¸‡ Min/Max threshold à¹€à¸›à¹‡à¸™à¹€à¸ªà¹‰à¸™à¸›à¸£à¸°
         - dataZoom: pinch zoom + pan + slider bar
         - Tooltip crosshair style
         - Toolbox: save as image
         - Dark/Light theme switching
         - disposeChart(): cleanup function à¸ªà¸³à¸«à¸£à¸±à¸š ECharts
         Round 3:
         - à¹€à¸à¸´à¹ˆà¸¡ ResizeObserver cleanup à¹ƒà¸™ disposeChart()
         - à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™ chart=null â†’ disposeChart() à¹ƒà¸™ selectDevice()
         - Final validation à¹à¸¥à¸° code polish
         Round 4 (Bug Fix & Polish):
         - à¹à¸à¹‰à¸ªà¸µ markLine: Min=cyan (#06b6d4), Max=red (#ef4444)
         - à¹à¸à¹‰ updateChartData()/changeTimeRange() à¹ƒà¸«à¹‰à¸¡à¸µ markLine colors à¸„à¸£à¸š
         - à¹€à¸à¸´à¹ˆà¸¡ backgroundColor: 'transparent' à¹ƒà¸«à¹‰à¸à¸¥à¸¡à¸à¸¥à¸·à¸™à¸à¸±à¸š panel
         - à¸¢à¹‰à¸²à¸¢ Toolbox à¹„à¸›à¸¡à¸¸à¸¡à¸‹à¹‰à¸²à¸¢à¸šà¸™ à¹„à¸¡à¹ˆà¹ƒà¸«à¹‰à¸—à¸±à¸š Y-axis à¸‚à¸§à¸²
         - à¹€à¸à¸´à¹ˆà¸¡ chart height 200px â†’ 220px
         - à¹à¸à¹‰à¸Šà¸·à¹ˆà¸­ card: "Temperature Trends" â†’ "Sensor Trends"
         - à¹à¸à¹‰ HTML Legend: à¹à¸¢à¸ Min/Max + à¸ªà¸µà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡
         - à¹„à¸¡à¹ˆà¹ƒà¸Šà¹‰ ECharts built-in dark theme
         Round 5 (Final Polish):
         - à¹à¸à¹‰ Tooltip à¸ªà¸µ marker: à¸à¸³à¸«à¸™à¸”à¸ªà¸µà¸•à¸²à¸¡ seriesName à¹à¸—à¸™ p.color
         - à¸‹à¹ˆà¸­à¸™ Toolbox (à¸—à¸±à¸šà¹à¸à¸™ Y à¸—à¸±à¹‰à¸‡à¸ªà¸­à¸‡à¸”à¹‰à¸²à¸™)
         - à¹€à¸à¸´à¹ˆà¸¡ grid.top: 30 à¹„à¸¡à¹ˆà¹ƒà¸«à¹‰à¸•à¸±à¸§à¹€à¸¥à¸‚ Y à¸–à¸¹à¸à¸•à¸±à¸”
         - à¹€à¸à¸´à¹ˆà¸¡ itemStyle.color à¹ƒà¸«à¹‰à¸—à¸¸à¸ series
         - à¸›à¸£à¸±à¸š grid padding: left/right 35px à¹ƒà¸«à¹‰à¸à¸£à¸°à¸Šà¸±à¸šà¸‚à¸¶à¹‰à¸™
         Round 6 (UI Polish):
         - à¸ªà¸µà¸•à¸±à¸§à¹€à¸¥à¸‚ Temperature à¹ƒà¸™ Detail View à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸•à¸²à¸¡à¸ªà¸–à¸²à¸™à¸°:
           * Normal: emerald-500 (à¹€à¸‚à¸µà¸¢à¸§)
           * Critical: red-500 (à¹à¸”à¸‡)
           * Acknowledged: amber-500 (à¸ªà¹‰à¸¡)
           * Offline: slate-500 (à¹€à¸—à¸²)
           * Warning: yellow-500 (à¹€à¸«à¸¥à¸·à¸­à¸‡)
         - à¹€à¸à¸´à¹ˆà¸¡à¸£à¸°à¸¢à¸°à¸«à¹ˆà¸²à¸‡à¸«à¸™à¹ˆà¸§à¸¢ Â°C (ml-1 opacity-70)
         - à¹€à¸à¸´à¹ˆà¸¡à¸£à¸°à¸¢à¸°à¸«à¹ˆà¸²à¸‡à¸«à¸™à¹ˆà¸§à¸¢ % (ml-0.5 opacity-70)
         Round 7 (Consistency Fix):
         - à¸«à¸™à¹ˆà¸§à¸¢ Â°C à¹ƒà¸™ Detail View: à¹ƒà¸Šà¹‰à¸ªà¸µà¹€à¸”à¸µà¸¢à¸§à¸à¸±à¸šà¸•à¸±à¸§à¹€à¸¥à¸‚ + opacity-60
         - Dashboard: Acknowledged à¹ƒà¸Šà¹‰à¸ªà¸µà¸ªà¹‰à¸¡ (text-amber-500) à¹à¸—à¸™à¸ªà¸µà¹à¸”à¸‡
         - Dashboard: Humidity à¹à¸ªà¸”à¸‡à¸—à¸¨à¸™à¸´à¸¢à¸¡ 1 à¸«à¸¥à¸±à¸ (.toFixed(1))
         
         v3.2.4 Quick Fix (Dark Mode Header/Footer):
         - Header: à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸ˆà¸²à¸ glass à¹€à¸›à¹‡à¸™ solid bg-slate-950 + border-b
         - Footer: à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸ˆà¸²à¸ glass à¹€à¸›à¹‡à¸™ solid bg-slate-950 + border-t
         - à¹à¸à¹‰à¸›à¸±à¸à¸«à¸² text à¸Šà¸·à¹ˆà¸­ à¸£à¸. à¸¡à¸­à¸‡à¹„à¸¡à¹ˆà¹€à¸«à¹‡à¸™à¹ƒà¸™ Dark Mode
         - Light Mode à¹„à¸¡à¹ˆà¸à¸£à¸°à¸—à¸š (à¸¢à¸±à¸‡à¹ƒà¸Šà¹‰ glass-light)
         
         v3.2.3 Changes (Enhancement â€” Log Filter & Hardware Warning):
         Round 1:
         - Log Filter System: Filter à¸•à¸²à¸¡ Type (à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”/à¸§à¸´à¸à¸¤à¸•/à¹€à¸•à¸·à¸­à¸™/à¸‚à¹‰à¸­à¸¡à¸¹à¸¥)
         - Log Device Filter: Dropdown à¹€à¸¥à¸·à¸­à¸ device
         - à¹à¸ªà¸”à¸‡à¸ˆà¸³à¸™à¸§à¸™ log à¹ƒà¸™à¹à¸•à¹ˆà¸¥à¸° filter
         - UI à¸„à¸¥à¹‰à¸²à¸¢ Dashboard filter (pill buttons)
         Round 2:
         - Battery Warning: vbat < 3.5V + vin < 4.0 â†’ Warning + Log
         - Battery Critical: vbat < 3.3V â†’ Critical + à¹€à¸ªà¸µà¸¢à¸‡à¹€à¸•à¸·à¸­à¸™ + Log
         - Signal Warning: rssi < -85dBm â†’ Warning + Log
         - Signal Critical: rssi < -95dBm â†’ Critical + Log
         - Status Priority: offline > critical > warning > normal
         - à¹à¸¢à¸ sub-status tracking (temp/power/battery/signal) à¸ªà¸³à¸«à¸£à¸±à¸š log à¸—à¸µà¹ˆà¹à¸¡à¹ˆà¸™à¸¢à¸³
         Round 3:
         - à¹€à¸à¸´à¹ˆà¸¡à¸›à¸¸à¹ˆà¸¡ ğŸ“¶ Weak Signal (rssi_low) à¹ƒà¸™ Simulation Panel
         - à¸›à¸£à¸±à¸š layout Simulation Panel: 6 à¸›à¸¸à¹ˆà¸¡à¹ƒà¸™ grid + Reset/Test full width
         - à¹€à¸à¸´à¹ˆà¸¡ rssi_low case à¹ƒà¸™ mainLoop (set rssi = -95dBm)
         
         v3.2.2 Changes (Out-of-Phase â€” Simulation & Log Enhancement):
         Round 1:
         - State Transition Log: à¸šà¸±à¸™à¸—à¸¶à¸ log 1 à¸„à¸£à¸±à¹‰à¸‡à¹€à¸¡à¸·à¹ˆà¸­ status à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™ (à¹à¸—à¸™ random log)
         - prevStatuses: à¹€à¸à¹‡à¸š status à¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸²à¸‚à¸­à¸‡à¹à¸•à¹ˆà¸¥à¸° device (runtime only)
         - simTargetId: à¹€à¸à¹‡à¸š device ID à¸—à¸µà¹ˆà¸–à¸¹à¸ simulate (à¸„à¹‰à¸²à¸‡à¸­à¸¢à¸¹à¹ˆà¹à¸¡à¹‰à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸«à¸™à¹‰à¸²)
         Round 2:
         - Simulation: à¹€à¸à¸´à¹ˆà¸¡à¸›à¸¸à¹ˆà¸¡ ğŸ¥¶ Temp Low + ğŸ”‹ Battery Low
         - Factory Reset: à¸¥à¸š SITE_SETTINGS_KEY à¸”à¹‰à¸§à¸¢ (Full Reset)
         - exportLogs: à¹€à¸à¸´à¹ˆà¸¡ addLog() à¸šà¸±à¸™à¸—à¸¶à¸à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£ export
         Round 3:
         - Dark Mode Header: à¹€à¸à¸´à¹ˆà¸¡ contrast (.glass opacity 0.95 + text-shadow)
         - Factory Reset: à¹€à¸à¸´à¹ˆà¸¡ fallback + debug log
         - Version: à¸­à¸±à¸à¹€à¸”à¸•à¹€à¸›à¹‡à¸™ v3.2.2 à¸—à¸¸à¸à¸ˆà¸¸à¸”
         
         v3.2.1 Changes (Out-of-Phase â€” UX Enhancement):
         Round 1:
         - Site Info: à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸Šà¸·à¹ˆà¸­ à¸£à¸./Unit/à¸Šà¸·à¹ˆà¸­à¹€à¸¥à¹ˆà¸™ (localStorage)
         - Site Settings Modal: à¹à¸à¹‰à¹„à¸‚ Site Info à¸œà¹ˆà¸²à¸™ modal
         - Header: à¹à¸ªà¸”à¸‡à¸Šà¸·à¹ˆà¸­ à¸£à¸. + Unit à¸ˆà¸²à¸ settings (à¹à¸—à¸™ hardcode)
         - Profile Card: à¹à¸ªà¸”à¸‡à¸Šà¸·à¹ˆà¸­à¹€à¸¥à¹ˆà¸™ (Display Name) à¸ˆà¸²à¸ settings
         Round 2:
         - Logs subtitle: à¹à¸ªà¸”à¸‡ à¸Šà¸·à¹ˆà¸­ à¸£à¸. â€¢ Unit
         - Action logs: à¹ƒà¸ªà¹ˆà¸Šà¸·à¹ˆà¸­à¹€à¸¥à¹ˆà¸™ (Display Name) à¸™à¸³à¸«à¸™à¹‰à¸² (acknowledge, add, delete, edit, export)
         - Export Logs CSV: à¹€à¸à¸´à¹ˆà¸¡ header rows (à¸Šà¸·à¹ˆà¸­ à¸£à¸. + Unit + à¸§à¸±à¸™à¸—à¸µà¹ˆ export)
         - System Info: à¹€à¸à¸´à¹ˆà¸¡ Uptime + Last Save
         Round 3:
         - Connection Status section: Internet (functional), MQTT/Supabase (placeholder)
         - Header connection dot: sync à¸à¸±à¸š navigator.onLine
         - Dark Mode Contrast Fix: à¸›à¸£à¸±à¸š minimum dark:text-slate-400 (WCAG AA)
         
         v3.2 Changes (Phase A â€” Foundation Fix):
         Round 1:
         - Removed Login System (will be separate file in Phase D)
         - showApp() called directly from DOMContentLoaded
         - Logout button disabled in System tab (placeholder for future Auth)
         - Removed AUTH_KEY constant and handleLogin()/logout() functions
         - Fixed double-encoded UTF-8 + auto localStorage migration
         Round 2:
         - UI refresh rate: 3s (à¹€à¸”à¸´à¸¡ 1s) â€” à¸¥à¸”à¸ à¸²à¸£à¸° CPU
         - History sampling: 1min/5min/30min à¸•à¸²à¸¡ spec (à¹€à¸”à¸´à¸¡ push à¸—à¸¸à¸ tick)
         - historyTick counter à¸ªà¸³à¸«à¸£à¸±à¸š sampling intervals
         - MAX_HISTORY_7D: 168 â†’ 336 (30-min intervals)
         - exportCSV() à¸”à¸¹ currentTimeRange à¹€à¸¥à¸·à¸­à¸ history source à¹ƒà¸«à¹‰à¸•à¸£à¸‡
         Round 3:
         - sanitizeHTML() à¸›à¹‰à¸­à¸‡à¸à¸±à¸™ XSS â€” à¹ƒà¸Šà¹‰à¸à¸±à¸š dev.name, hw_id, log à¸à¹ˆà¸­à¸™ innerHTML
         - Dashboard DOM optimization: hash check â†’ skip render à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™
         - Detail DOM optimization: cache à¸„à¹ˆà¸²à¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸² â†’ à¸­à¸±à¸à¹€à¸”à¸•à¹€à¸‰à¸à¸²à¸° element à¸—à¸µà¹ˆà¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™
         Round 4:
         - Modal ESC key + backdrop click à¸›à¸´à¸” modal (Settings + Add Device)
         - debounce() + throttle() utility functions
         - Search input: debounce 300ms (à¸¥à¸”à¸ à¸²à¸£à¸° DOM rebuild)
         - saveData: throttle 10s + save à¹€à¸¡à¸·à¹ˆà¸­ visibilitychange (à¸›à¸´à¸”à¹à¸—à¹‡à¸š)
         
         v3.1 Changes:
         - Fixed fa-wifi-slash icon (using custom CSS)
         - Fixed Time Range with proper extended history
         - Improved performance (innerHTML optimization)
         - Increased touch targets to 44px minimum
         - Added aria-labels for accessibility
         - Added loading skeleton states
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151f32', 950: '#020617' },
                        primary: { 500: '#10b981', 600: '#059669' },
                    },
                    fontFamily: { 
                        sans: ['Kanit', 'sans-serif'], 
                        mono: ['Roboto Mono', 'monospace'] 
                    },
                    animation: {
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'glow': 'glow 2s ease-in-out infinite alternate',
                        'bounce-slow': 'bounce 2s infinite',
                        'skeleton': 'skeleton 1.5s ease-in-out infinite',
                    }
                }
            }
        }
    </script>
    
    <!-- 2. Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&family=Roboto+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- 3. ECharts & SweetAlert2 -->
    <!-- v3.3: à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸ˆà¸²à¸ Chart.js â†’ ECharts (better realtime, dark theme, dataZoom, export) -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- 4. Custom Styles -->
    <style>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CSS Animations â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes zoomIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        @keyframes glow {
            0% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        @keyframes numberChange {
            0% { transform: translateY(8px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        @keyframes skeleton {
            0% { background-position: -200px 0; }
            100% { background-position: calc(200px + 100%) 0; }
        }
        
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
        .animate-slideUp { animation: slideUp 0.3s ease-out; }
        .animate-zoomIn { animation: zoomIn 0.2s ease-out; }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Skeleton Loading â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .skeleton {
            background: linear-gradient(90deg, #e2e8f0 0px, #f1f5f9 40px, #e2e8f0 80px);
            background-size: 200px 100%;
            animation: skeleton 1.5s ease-in-out infinite;
            border-radius: 8px;
        }
        .dark .skeleton {
            background: linear-gradient(90deg, #334155 0px, #475569 40px, #334155 80px);
            background-size: 200px 100%;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Custom WiFi-Off Icon â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .icon-wifi-off {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .icon-wifi-off::after {
            content: '';
            position: absolute;
            width: 120%;
            height: 2px;
            background: currentColor;
            transform: rotate(-45deg);
            border-radius: 1px;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Glass Morphism â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .glass { 
            /* v3.2.2: à¹€à¸à¸´à¹ˆà¸¡ opacity à¸ˆà¸²à¸ 0.9 â†’ 0.95 à¹€à¸à¸·à¹ˆà¸­ contrast à¸—à¸µà¹ˆà¸”à¸µà¸‚à¸¶à¹‰à¸™ */
            background: rgba(30, 41, 59, 0.95); 
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255,255,255,0.08); 
        }
        .glass-light {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0,0,0,0.08);
        }
        /* v3.2.2: à¹€à¸à¸´à¹ˆà¸¡ text-shadow à¸ªà¸³à¸«à¸£à¸±à¸š header à¹ƒà¸™ dark mode */
        .dark #header-hospital {
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        .glass-panel { 
            background: rgba(15, 23, 42, 0.95); 
            backdrop-filter: blur(16px); 
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.4);
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Utility â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        body { -webkit-tap-highlight-color: transparent; }
        
        /* Safe area for bottom nav */
        .safe-bottom { padding-bottom: calc(5rem + env(safe-area-inset-bottom, 0px)); }
        .nav-safe { padding-bottom: env(safe-area-inset-bottom, 0px); }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Device States â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .device-offline { 
            filter: grayscale(100%) opacity(0.5); 
            pointer-events: none; 
        }
        .offline-badge { 
            filter: none !important; 
            opacity: 1 !important;
            pointer-events: auto !important; 
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Log Colors â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .log-item { border-left: 3px solid; }
        
        /* Dark mode logs */
        .dark .log-crit { border-color: #ef4444; background: rgba(239, 68, 68, 0.1); }
        .dark .log-warn { border-color: #f59e0b; background: rgba(245, 158, 11, 0.1); }
        .dark .log-info { border-color: #3b82f6; background: rgba(59, 130, 246, 0.1); }
        
        /* Light mode logs */
        .log-crit { border-color: #ef4444; background: rgba(239, 68, 68, 0.08); }
        .log-warn { border-color: #f59e0b; background: rgba(245, 158, 11, 0.08); }
        .log-info { border-color: #3b82f6; background: rgba(59, 130, 246, 0.08); }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Ambient Glow â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .ambient-glow {
            position: absolute;
            top: -20%;
            left: -20%;
            width: 80%;
            height: 50%;
            border-radius: 50%;
            filter: blur(100px);
            pointer-events: none;
            transition: all 1s ease;
            z-index: 0;
        }
        
        /* Dark mode ambient */
        .dark .ambient-normal { background: rgba(16, 185, 129, 0.15); }
        .dark .ambient-warning { background: rgba(245, 158, 11, 0.25); }
        .dark .ambient-critical { background: rgba(239, 68, 68, 0.35); animation: glow 1s ease-in-out infinite alternate; }
        
        /* Light mode ambient - more subtle */
        .ambient-normal { background: rgba(16, 185, 129, 0.06); }
        .ambient-warning { background: rgba(245, 158, 11, 0.1); }
        .ambient-critical { background: rgba(239, 68, 68, 0.12); animation: glow 1s ease-in-out infinite alternate; }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Toggle Switch â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        /* Light mode inactive */
        .toggle-switch { background: #cbd5e1; }
        /* Dark mode inactive */
        .dark .toggle-switch { background: #475569; }
        /* Active state (both modes) */
        .toggle-switch.active { background: #10b981 !important; }
        
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .toggle-switch.active::after {
            transform: translateX(20px);
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Filter Buttons â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .filter-btn {
            transition: all 0.2s ease;
        }
        .filter-btn.active {
            background: #10b981 !important;
            color: white !important;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Gradient Cards â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* Dark mode cards */
        .dark .card-normal {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.12) 0%, rgba(15, 23, 42, 0.9) 100%);
            border-color: rgba(16, 185, 129, 0.3);
        }
        .dark .card-warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(15, 23, 42, 0.9) 100%);
            border-color: rgba(245, 158, 11, 0.4);
        }
        .dark .card-critical {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(15, 23, 42, 0.9) 100%);
            border-color: rgba(239, 68, 68, 0.5);
        }
        .dark .card-offline {
            background: linear-gradient(135deg, rgba(100, 116, 139, 0.15) 0%, rgba(15, 23, 42, 0.9) 100%);
            border-color: rgba(100, 116, 139, 0.3);
        }
        
        /* Light mode cards */
        .card-normal {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(255, 255, 255, 1) 100%);
            border-color: rgba(16, 185, 129, 0.3);
        }
        .card-warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.12) 0%, rgba(255, 255, 255, 1) 100%);
            border-color: rgba(245, 158, 11, 0.4);
        }
        .card-critical {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(255, 255, 255, 1) 100%);
            border-color: rgba(239, 68, 68, 0.5);
        }
        .card-offline {
            background: linear-gradient(135deg, rgba(100, 116, 139, 0.1) 0%, rgba(255, 255, 255, 1) 100%);
            border-color: rgba(100, 116, 139, 0.3);
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Animated Numbers â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .temp-value.changing {
            animation: numberChange 0.3s ease-out;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Search Input â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .search-input:focus { 
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.4); 
            border-color: #10b981 !important;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Badge Counter â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .badge-counter {
            position: absolute;
            top: 0px;
            right: 8px;
            min-width: 18px;
            height: 18px;
            background: #ef4444;
            color: white;
            font-size: 10px;
            font-weight: 600;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 5px;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.4);
            z-index: 10;
        }
        .badge-counter.warning {
            background: #f59e0b;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.4);
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Connection Status â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .connection-dot.online { 
            background: #10b981; 
            animation: pulse 2s infinite;
        }
        .connection-dot.offline { 
            background: #ef4444; 
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Device Card Hover â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .device-card {
            transition: all 0.3s ease;
        }
        .device-card:hover {
            transform: translateY(-2px);
        }
        .dark .device-card:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        .device-card:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .device-card:active {
            transform: scale(0.98);
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Simulation Panel â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* Light mode */
        .sim-panel-wrapper {
            background: rgba(241, 245, 249, 0.9);
            border-color: #cbd5e1;
        }
        /* Dark mode */
        .dark .sim-panel-wrapper {
            background: rgba(15, 23, 42, 0.6);
            border-color: #475569;
        }
        
        .sim-btn { 
            transition: all 0.2s ease;
        }
        .sim-btn:hover { 
            transform: scale(1.02); 
        }
        .sim-btn:active {
            transform: scale(0.98);
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Bottom Navigation â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #bottom-nav {
            max-width: 100%;
        }
        @media (min-width: 1280px) {
            #bottom-nav {
                max-width: 1280px;
                left: 50%;
                transform: translateX(-50%);
                border-radius: 1rem 1rem 0 0;
            }
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Focus Ring for Accessibility â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        button:focus-visible, 
        input:focus-visible,
        a:focus-visible {
            outline: 2px solid #10b981;
            outline-offset: 2px;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Touch Target Minimum 44px â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .touch-target {
            min-width: 44px;
            min-height: 44px;
        }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-950 text-slate-700 dark:text-slate-200 font-sans overflow-hidden transition-colors duration-300">

    <!-- â•â•â• PART 1: LOGIN PAGE â€” à¸¥à¸šà¸­à¸­à¸à¹ƒà¸™ v3.2 (à¸ˆà¸°à¹à¸¢à¸à¹€à¸›à¹‡à¸™à¹„à¸Ÿà¸¥à¹Œ index.html à¹ƒà¸™ Phase D) â•â•â• -->
    <!-- â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
         â•‘                  PART 2: MAIN APPLICATION                  â•‘
         â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="app-main" class="h-screen relative flex flex-col max-w-7xl mx-auto bg-slate-50 dark:bg-slate-950 shadow-2xl overflow-hidden" role="main">
        
        <!-- Ambient Glow Effect -->
        <div id="ambient-glow" class="ambient-glow ambient-normal" aria-hidden="true"></div>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             HEADER - Always Visible
             â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <header id="main-header" class="sticky top-0 z-30 px-4 py-3 flex justify-between items-center glass-light dark:bg-slate-950 dark:border-b dark:border-slate-800 transition-all" role="banner">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-slate-200 to-slate-300 dark:from-slate-700 dark:to-slate-800 flex items-center justify-center border border-slate-300 dark:border-slate-600 shadow-inner">
                    <i class="fa-solid fa-hospital text-emerald-600 dark:text-emerald-400" aria-hidden="true"></i>
                </div>
                <div>
                    <h2 id="header-hospital" class="text-sm font-semibold text-slate-800 dark:text-white leading-tight">à¸£à¸.à¸¨à¸£à¸µà¸™à¸„à¸£à¸´à¸™à¸—à¸£à¹Œ</h2>
                    <div class="flex items-center gap-2">
                        <p id="header-unit" class="text-xs text-slate-500 dark:text-slate-400 font-mono">Unit: ICU-01</p>
                        <!-- Connection Status -->
                        <div class="flex items-center gap-1" role="status" aria-live="polite">
                            <div id="connection-dot" class="connection-dot online" aria-hidden="true"></div>
                            <span id="connection-text" class="text-xs text-emerald-600 dark:text-emerald-400 font-medium">Online</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex gap-2">
                <!-- Audio Toggle - Updated to 44px touch target -->
                <button onclick="toggleAudio()" id="btn-audio" 
                        class="touch-target w-11 h-11 rounded-full bg-slate-200 dark:bg-slate-800 flex items-center justify-center text-slate-600 dark:text-slate-400 hover:text-emerald-500 dark:hover:text-emerald-400 transition-colors"
                        aria-label="Toggle audio alerts"
                        aria-pressed="true">
                    <i class="fa-solid fa-volume-high text-lg" aria-hidden="true"></i>
                </button>
                <!-- Theme Toggle - Updated to 44px touch target -->
                <button onclick="toggleTheme()" id="btn-theme"
                        class="touch-target w-11 h-11 rounded-full bg-slate-200 dark:bg-slate-800 flex items-center justify-center text-slate-600 dark:text-slate-400 hover:text-emerald-500 dark:hover:text-emerald-400 transition-colors"
                        aria-label="Toggle dark/light theme"
                        aria-pressed="true">
                    <i id="theme-icon" class="fa-solid fa-moon text-lg" aria-hidden="true"></i>
                </button>
                <!-- Add Device - Updated to 44px touch target -->
                <button onclick="openAddModal()" 
                        class="touch-target w-11 h-11 rounded-full bg-emerald-500 flex items-center justify-center text-white hover:bg-emerald-600 transition-colors shadow-lg shadow-emerald-500/30"
                        aria-label="Add new device">
                    <i class="fa-solid fa-plus text-lg" aria-hidden="true"></i>
                </button>
            </div>
        </header>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             CONTENT AREA
             â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <main class="flex-1 overflow-y-auto safe-bottom px-4 pt-4 relative z-10 hide-scrollbar">
            
            <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                 VIEW: DASHBOARD
                 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
            <div id="view-dashboard" class="animate-fadeIn">
                
                <!-- Search & Filter Bar -->
                <div class="mb-4 space-y-3">
                    <!-- Search Input -->
                    <div class="relative">
                        <label for="search-box" class="sr-only">Search devices</label>
                        <i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-slate-400 dark:text-slate-500" aria-hidden="true"></i>
                        <input type="text" id="search-box" 
                               oninput="debouncedSearch()" 
                               class="search-input w-full bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-xl py-2.5 pl-10 pr-4 text-sm text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-slate-500 focus:outline-none transition-all" 
                               placeholder="à¸„à¹‰à¸™à¸«à¸²à¸Šà¸·à¹ˆà¸­à¸•à¸¹à¹‰ à¸«à¸£à¸·à¸­ Hardware ID...">
                    </div>
                    
                    <!-- Filter Buttons -->
                    <div class="flex gap-2 overflow-x-auto hide-scrollbar pb-1" role="group" aria-label="Filter devices">
                        <button onclick="setFilter('all')" id="filter-all" 
                                class="touch-target filter-btn active px-4 py-2 rounded-full text-sm font-semibold bg-emerald-500 text-white whitespace-nowrap transition-colors"
                                aria-pressed="true">
                            à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
                        </button>
                        <button onclick="setFilter('critical')" id="filter-critical" 
                                class="touch-target filter-btn px-4 py-2 rounded-full text-sm font-semibold bg-slate-200 dark:bg-slate-800 text-slate-600 dark:text-slate-300 whitespace-nowrap transition-colors"
                                aria-pressed="false">
                            âš ï¸ à¸§à¸´à¸à¸¤à¸•
                        </button>
                        <button onclick="setFilter('offline')" id="filter-offline" 
                                class="touch-target filter-btn px-4 py-2 rounded-full text-sm font-semibold bg-slate-200 dark:bg-slate-800 text-slate-600 dark:text-slate-300 whitespace-nowrap transition-colors"
                                aria-pressed="false">
                            ğŸ”Œ à¸­à¸­à¸Ÿà¹„à¸¥à¸™à¹Œ
                        </button>
                        <button onclick="setFilter('normal')" id="filter-normal" 
                                class="touch-target filter-btn px-4 py-2 rounded-full text-sm font-semibold bg-slate-200 dark:bg-slate-800 text-slate-600 dark:text-slate-300 whitespace-nowrap transition-colors"
                                aria-pressed="false">
                            âœ… à¸›à¸à¸•à¸´
                        </button>
                    </div>
                </div>

                <!-- Header Row -->
                <div class="flex justify-between items-end mb-3">
                    <h3 class="text-sm font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider">Device List</h3>
                    <div class="flex items-center gap-1 text-xs text-emerald-600 dark:text-emerald-400 bg-emerald-100 dark:bg-emerald-500/15 px-2.5 py-1 rounded-full border border-emerald-200 dark:border-emerald-500/30">
                        <div class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse" aria-hidden="true"></div>
                        <span id="unit-count" class="font-medium">0</span> Units
                    </div>
                </div>
                
                <!-- Loading Skeleton -->
                <div id="loading-skeleton" class="hidden grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3 pb-4">
                    <div class="rounded-2xl p-4 border-2 border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">
                        <div class="flex items-start gap-3">
                            <div class="skeleton w-12 h-12 rounded-xl"></div>
                            <div class="flex-1">
                                <div class="skeleton h-4 w-3/4 mb-2"></div>
                                <div class="skeleton h-3 w-1/2 mb-3"></div>
                                <div class="skeleton h-8 w-20 mb-2"></div>
                                <div class="skeleton h-3 w-2/3"></div>
                            </div>
                        </div>
                    </div>
                    <div class="rounded-2xl p-4 border-2 border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">
                        <div class="flex items-start gap-3">
                            <div class="skeleton w-12 h-12 rounded-xl"></div>
                            <div class="flex-1">
                                <div class="skeleton h-4 w-3/4 mb-2"></div>
                                <div class="skeleton h-3 w-1/2 mb-3"></div>
                                <div class="skeleton h-8 w-20 mb-2"></div>
                                <div class="skeleton h-3 w-2/3"></div>
                            </div>
                        </div>
                    </div>
                    <div class="rounded-2xl p-4 border-2 border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 hidden md:block">
                        <div class="flex items-start gap-3">
                            <div class="skeleton w-12 h-12 rounded-xl"></div>
                            <div class="flex-1">
                                <div class="skeleton h-4 w-3/4 mb-2"></div>
                                <div class="skeleton h-3 w-1/2 mb-3"></div>
                                <div class="skeleton h-8 w-20 mb-2"></div>
                                <div class="skeleton h-3 w-2/3"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Device Grid (Responsive) -->
                <div id="device-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3 pb-4" role="list" aria-label="Device list"></div>
                
                <!-- Empty State -->
                <div id="empty-state" class="hidden flex flex-col items-center justify-center py-16 text-slate-400 dark:text-slate-400">
                    <i class="fa-solid fa-box-open text-5xl mb-4 opacity-50" aria-hidden="true"></i>
                    <p class="text-sm font-semibold">à¹„à¸¡à¹ˆà¸à¸šà¸­à¸¸à¸›à¸à¸£à¸“à¹Œ</p>
                    <p class="text-xs mt-1">à¸¥à¸­à¸‡à¸„à¹‰à¸™à¸«à¸²à¸”à¹‰à¸§à¸¢à¸„à¸³à¸­à¸·à¹ˆà¸™ à¸«à¸£à¸·à¸­à¸à¸”à¸›à¸¸à¹ˆà¸¡ + à¹€à¸à¸·à¹ˆà¸­à¹€à¸à¸´à¹ˆà¸¡</p>
                </div>
            </div>

            <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                 VIEW: DETAIL
                 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
            <div id="view-detail" class="hidden animate-fadeIn">
                <div class="max-w-lg mx-auto">
                    
                    <!-- Back Button & Device Name -->
                    <div class="flex justify-between items-center mb-4">
                        <button onclick="switchTab('dashboard')" 
                                class="touch-target flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400 hover:text-emerald-500 dark:hover:text-emerald-400 transition-colors font-medium px-2 py-2"
                                aria-label="Go back to dashboard">
                            <i class="fa-solid fa-arrow-left" aria-hidden="true"></i> à¸¢à¹‰à¸­à¸™à¸à¸¥à¸±à¸š
                        </button>
                        <button onclick="openSettings()" 
                                class="touch-target w-11 h-11 rounded-lg bg-slate-200 dark:bg-slate-800 flex items-center justify-center text-slate-600 dark:text-slate-400 hover:bg-emerald-500 hover:text-white transition-colors"
                                aria-label="Device settings">
                            <i class="fa-solid fa-gear" aria-hidden="true"></i>
                        </button>
                    </div>
                    
                    <!-- Device Name Header -->
                    <div class="mb-4">
                        <h2 id="detail-device-name" class="text-lg font-semibold text-slate-800 dark:text-white">--</h2>
                        <p id="detail-hw-id" class="text-xs text-slate-500 dark:text-slate-400 font-mono">HW: --</p>
                    </div>

                    <!-- Acknowledge Button -->
                    <button id="btn-ack" onclick="acknowledgeAlert()" 
                            class="hidden w-full mb-4 bg-amber-500 hover:bg-amber-600 text-white font-semibold py-3 rounded-xl shadow-lg shadow-amber-500/30 animate-pulse flex items-center justify-center gap-2"
                            aria-label="Acknowledge alert and mute alarm">
                        <i class="fa-solid fa-bell-slash" aria-hidden="true"></i> à¸£à¸±à¸šà¸—à¸£à¸²à¸šà¹€à¸«à¸•à¸¸à¸à¸²à¸£à¸“à¹Œ (Mute Alarm)
                    </button>

                    <!-- Main Status Card with Gradient -->
                    <div id="detail-card" class="relative overflow-hidden rounded-3xl p-6 border-2 shadow-xl mb-4 transition-all duration-500 card-normal" role="region" aria-label="Temperature status">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <i class="fa-solid fa-temperature-half text-slate-400 dark:text-slate-500" aria-hidden="true"></i>
                                    <span class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Temperature</span>
                                </div>
                                <!-- v3.3 R7: à¸ªà¸µà¸•à¸±à¸§à¹€à¸¥à¸‚à¹à¸¥à¸°à¸«à¸™à¹ˆà¸§à¸¢à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸•à¸²à¸¡à¸ªà¸–à¸²à¸™à¸° -->
                                <h1 id="detail-temp" class="temp-value text-5xl font-bold tracking-tighter transition-colors" aria-live="polite">
                                    <span class="text-slate-800 dark:text-white">--.-</span><span class="text-xl ml-1 opacity-60 text-slate-800 dark:text-white">Â°C</span>
                                </h1>
                            </div>
                            <div class="text-right">
                                <div class="flex items-center justify-end gap-2 mb-1">
                                    <span class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Humidity</span>
                                    <i class="fa-solid fa-droplet text-blue-500" aria-hidden="true"></i>
                                </div>
                                <!-- v3.3 R6: à¹€à¸à¸´à¹ˆà¸¡à¸£à¸°à¸¢à¸°à¸«à¹ˆà¸²à¸‡à¸«à¸™à¹ˆà¸§à¸¢ -->
                                <h2 id="detail-humi" class="text-2xl font-semibold text-blue-500" aria-live="polite">--.-<span class="text-sm ml-0.5 opacity-70">%</span></h2>
                            </div>
                        </div>
                        
                        <!-- Status Bar -->
                        <div class="flex justify-between items-center mt-4">
                            <div id="status-bar" class="flex items-center gap-2 py-2 px-3 rounded-xl bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700" role="status">
                                <div id="status-dot" class="w-2.5 h-2.5 rounded-full bg-emerald-500 animate-pulse" aria-hidden="true"></div>
                                <span id="status-text" class="text-xs font-semibold text-emerald-600 dark:text-emerald-400">Normal</span>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-slate-600 dark:text-slate-400">
                                    Limit: <span id="display-limit-min" class="font-mono font-medium text-blue-500">--</span> ~ 
                                    <span id="display-limit-max" class="font-mono font-medium text-red-500">--</span>Â°C
                                </div>
                            </div>
                        </div>
                        
                        <!-- Last Seen -->
                        <div class="mt-3 pt-3 border-t border-slate-200 dark:border-slate-700 flex justify-between items-center">
                            <span class="text-xs text-slate-500 dark:text-slate-400">Last Seen:</span>
                            <span id="detail-last-seen" class="text-xs font-mono text-slate-600 dark:text-slate-300">--</span>
                        </div>
                    </div>

                    <!-- Hardware Status Grid -->
                    <h3 class="text-xs font-semibold text-slate-600 dark:text-slate-400 mb-2 uppercase tracking-wider pl-1">Power & Network</h3>
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <!-- VIN -->
                        <div class="bg-white dark:bg-slate-800/60 p-3 rounded-2xl border border-slate-200 dark:border-slate-700">
                            <div class="flex items-center gap-2 mb-1">
                                <div class="w-6 h-6 rounded-lg bg-yellow-100 dark:bg-yellow-500/20 flex items-center justify-center text-yellow-600 dark:text-yellow-400 text-xs">
                                    <i class="fa-solid fa-plug" aria-hidden="true"></i>
                                </div>
                                <span class="text-xs text-slate-500 dark:text-slate-400 font-semibold uppercase">VIN</span>
                            </div>
                            <div class="flex items-baseline gap-1">
                                <span id="val-vin" class="text-xl font-mono font-semibold text-slate-800 dark:text-slate-100">--</span>
                                <span class="text-xs text-slate-500 dark:text-slate-400 font-medium">V</span>
                            </div>
                            <span id="txt-power-status" class="text-xs text-emerald-600 dark:text-emerald-400 font-medium">DC Connected</span>
                        </div>

                        <!-- Battery -->
                        <div class="bg-white dark:bg-slate-800/60 p-3 rounded-2xl border border-slate-200 dark:border-slate-700">
                            <div class="flex items-center gap-2 mb-1 justify-between">
                                <div class="flex items-center gap-2">
                                    <div class="w-6 h-6 rounded-lg bg-green-100 dark:bg-green-500/20 flex items-center justify-center text-green-600 dark:text-green-400 text-xs">
                                        <i class="fa-solid fa-battery-full" aria-hidden="true"></i>
                                    </div>
                                    <span class="text-xs text-slate-500 dark:text-slate-400 font-semibold uppercase">Battery</span>
                                </div>
                                <i id="icon-charging" class="fa-solid fa-bolt text-yellow-500 animate-pulse hidden" aria-label="Charging"></i>
                            </div>
                            <div class="flex justify-between items-end">
                                <div>
                                    <span id="val-batt-percent" class="text-xl font-mono font-semibold text-slate-800 dark:text-slate-100">--</span>
                                    <span class="text-xs text-slate-500 dark:text-slate-400 font-medium">%</span>
                                </div>
                                <div class="text-right">
                                    <span id="val-vbat" class="text-xs font-mono text-slate-500 dark:text-slate-400">--V</span>
                                    <span id="val-ibat" class="text-xs font-mono text-slate-400 dark:text-slate-400 block">0.0A</span>
                                </div>
                            </div>
                            <div class="w-full h-1.5 bg-slate-200 dark:bg-slate-700 rounded-full mt-2 overflow-hidden" role="progressbar" aria-label="Battery level">
                                <div id="bar-batt" class="h-full bg-emerald-500 w-[80%] transition-all duration-500 rounded-full"></div>
                            </div>
                        </div>

                        <!-- Signal -->
                        <div class="bg-white dark:bg-slate-800/60 p-3 rounded-2xl border border-slate-200 dark:border-slate-700">
                            <div class="flex items-center gap-2 mb-1">
                                <div class="w-6 h-6 rounded-lg bg-blue-100 dark:bg-blue-500/20 flex items-center justify-center text-blue-600 dark:text-blue-400 text-xs">
                                    <i class="fa-solid fa-wifi" aria-hidden="true"></i>
                                </div>
                                <span class="text-xs text-slate-500 dark:text-slate-400 font-semibold uppercase">Signal</span>
                            </div>
                            <div class="flex items-baseline gap-1">
                                <span id="val-rssi" class="text-xl font-mono font-semibold text-slate-800 dark:text-slate-100">--</span>
                                <span class="text-xs text-slate-500 dark:text-slate-400 font-medium">dBm</span>
                            </div>
                            <span id="txt-signal" class="text-xs text-emerald-600 dark:text-emerald-400 font-medium">Excellent</span>
                        </div>

                        <!-- Last Update -->
                        <div class="bg-white dark:bg-slate-800/60 p-3 rounded-2xl border border-slate-200 dark:border-slate-700">
                            <div class="flex items-center gap-2 mb-1">
                                <div class="w-6 h-6 rounded-lg bg-slate-100 dark:bg-slate-600/50 flex items-center justify-center text-slate-500 dark:text-slate-400 text-xs">
                                    <i class="fa-regular fa-clock" aria-hidden="true"></i>
                                </div>
                                <span class="text-xs text-slate-500 dark:text-slate-400 font-semibold uppercase">Updated</span>
                            </div>
                            <div id="val-update" class="text-base font-mono font-semibold text-slate-800 dark:text-slate-100 pt-1">--:--:--</div>
                            <span class="text-xs text-slate-500 dark:text-slate-400">Real-time</span>
                        </div>
                    </div>

                    <!-- Chart Section -->
                    <div class="bg-white dark:bg-slate-800/60 rounded-3xl p-4 border border-slate-200 dark:border-slate-700 mb-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider flex items-center gap-2">
                                <i class="fa-solid fa-chart-line" aria-hidden="true"></i> Sensor Trends
                            </h3>
                            <!-- Time Range Selector -->
                            <div class="flex bg-slate-100 dark:bg-slate-900 rounded-lg p-0.5" role="group" aria-label="Time range">
                                <button onclick="changeTimeRange('1h')" id="btn-time-1h" 
                                        class="time-btn active px-3 py-1.5 text-xs rounded-md font-semibold transition-all bg-white dark:bg-slate-700 shadow text-slate-800 dark:text-white"
                                        aria-pressed="true">1H</button>
                                <button onclick="changeTimeRange('24h')" id="btn-time-24h" 
                                        class="time-btn px-3 py-1.5 text-xs rounded-md font-semibold transition-all text-slate-500 dark:text-slate-400"
                                        aria-pressed="false">24H</button>
                                <button onclick="changeTimeRange('7d')" id="btn-time-7d" 
                                        class="time-btn px-3 py-1.5 text-xs rounded-md font-semibold transition-all text-slate-500 dark:text-slate-400"
                                        aria-pressed="false">7D</button>
                            </div>
                        </div>
                        <!-- v3.3 R4: à¹€à¸à¸´à¹ˆà¸¡ height à¹€à¸›à¹‡à¸™ 220px à¹€à¸à¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¸”à¸¹à¸ªà¸šà¸²à¸¢à¸•à¸²à¸‚à¸¶à¹‰à¸™ -->
                        <div class="h-[220px] w-full relative">
                            <!-- v3.3: à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸ˆà¸²à¸ canvas â†’ div à¸ªà¸³à¸«à¸£à¸±à¸š ECharts -->
                            <div id="mainChart" class="w-full h-full" aria-label="Temperature and humidity chart"></div>
                            <!-- Chart Loader -->
                            <div id="chart-loader" class="hidden absolute inset-0 flex items-center justify-center bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm rounded-lg z-10">
                                <i class="fa-solid fa-circle-notch fa-spin text-emerald-500 text-xl" aria-hidden="true"></i>
                                <span class="sr-only">Loading chart...</span>
                            </div>
                        </div>
                        <!-- Chart Legend â€” v3.3 R4: à¹à¸à¹‰à¸ªà¸µà¹ƒà¸«à¹‰à¸•à¸£à¸‡à¸à¸±à¸š ECharts -->
                        <div class="flex justify-center gap-4 mt-3 text-xs flex-wrap">
                            <div class="flex items-center gap-1.5">
                                <div class="w-3 h-0.5 bg-emerald-500 rounded" aria-hidden="true"></div>
                                <span class="text-slate-500 dark:text-slate-400">Temp</span>
                            </div>
                            <div class="flex items-center gap-1.5">
                                <div class="w-3 h-0.5 bg-blue-500 rounded" style="opacity:0.7" aria-hidden="true"></div>
                                <span class="text-slate-500 dark:text-slate-400">Humidity</span>
                            </div>
                            <div class="flex items-center gap-1.5">
                                <div class="w-3 h-0.5 bg-cyan-500 rounded" style="opacity:0.7" aria-hidden="true"></div>
                                <span class="text-slate-500 dark:text-slate-400">Min</span>
                            </div>
                            <div class="flex items-center gap-1.5">
                                <div class="w-3 h-0.5 bg-red-500 rounded" style="opacity:0.7" aria-hidden="true"></div>
                                <span class="text-slate-500 dark:text-slate-400">Max</span>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="grid grid-cols-2 gap-3 mb-6">
                        <button onclick="exportCSV()" 
                                class="touch-target bg-slate-100 dark:bg-slate-800 p-3 rounded-xl flex items-center justify-center gap-2 text-sm font-semibold text-slate-600 dark:text-slate-300 hover:bg-emerald-500 hover:text-white transition-all border border-slate-200 dark:border-slate-700"
                                aria-label="Export data to CSV file">
                            <i class="fa-solid fa-file-csv text-lg" aria-hidden="true"></i> Export CSV
                        </button>
                        <button onclick="shareReport()" 
                                class="touch-target bg-slate-100 dark:bg-slate-800 p-3 rounded-xl flex items-center justify-center gap-2 text-sm font-semibold text-slate-600 dark:text-slate-300 hover:bg-blue-500 hover:text-white transition-all border border-slate-200 dark:border-slate-700"
                                aria-label="Share report">
                            <i class="fa-solid fa-share-nodes text-lg" aria-hidden="true"></i> Share
                        </button>
                    </div>
                </div>
            </div>

            <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                 VIEW: LOGS
                 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
            <div id="view-logs" class="hidden animate-fadeIn">
                <div class="max-w-2xl mx-auto">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="text-lg font-semibold text-slate-800 dark:text-white">à¸›à¸£à¸°à¸§à¸±à¸•à¸´ (Logs)</h3>
                            <p id="logs-subtitle" class="text-xs text-slate-500 dark:text-slate-400">à¸£à¸.à¸¨à¸£à¸µà¸™à¸„à¸£à¸´à¸™à¸—à¸£à¹Œ â€¢ ICU-01</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="clearLogs()" 
                                    class="touch-target px-3 py-2 bg-slate-200 dark:bg-slate-800 text-sm font-semibold rounded-lg text-slate-500 dark:text-slate-400 hover:bg-red-500 hover:text-white transition-all"
                                    aria-label="Clear all logs">
                                <i class="fa-solid fa-trash mr-1" aria-hidden="true"></i> Clear
                            </button>
                            <button onclick="exportLogs()" 
                                    class="touch-target px-3 py-2 bg-slate-200 dark:bg-slate-800 text-sm font-semibold rounded-lg text-slate-600 dark:text-slate-300 hover:bg-emerald-500 hover:text-white transition-all"
                                    aria-label="Export logs to CSV">
                                <i class="fa-solid fa-download mr-1" aria-hidden="true"></i> Export
                            </button>
                        </div>
                    </div>
                    
                    <!-- v3.2.3: Log Filter UI -->
                    <div class="mb-4 space-y-3">
                        <!-- Filter Type Buttons -->
                        <div class="flex gap-2 overflow-x-auto hide-scrollbar pb-1" role="group" aria-label="Filter logs by type">
                            <button onclick="setLogFilter('all')" id="log-filter-all" 
                                    class="touch-target log-filter-btn active px-3 py-2 rounded-full text-xs font-semibold bg-emerald-500 text-white whitespace-nowrap transition-colors"
                                    aria-pressed="true">
                                à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” <span id="log-count-all" class="ml-1 opacity-80">(0)</span>
                            </button>
                            <button onclick="setLogFilter('crit')" id="log-filter-crit" 
                                    class="touch-target log-filter-btn px-3 py-2 rounded-full text-xs font-semibold bg-slate-200 dark:bg-slate-800 text-slate-600 dark:text-slate-300 whitespace-nowrap transition-colors"
                                    aria-pressed="false">
                                ğŸ”´ à¸§à¸´à¸à¸¤à¸• <span id="log-count-crit" class="ml-1 opacity-80">(0)</span>
                            </button>
                            <button onclick="setLogFilter('warn')" id="log-filter-warn" 
                                    class="touch-target log-filter-btn px-3 py-2 rounded-full text-xs font-semibold bg-slate-200 dark:bg-slate-800 text-slate-600 dark:text-slate-300 whitespace-nowrap transition-colors"
                                    aria-pressed="false">
                                ğŸŸ¡ à¹€à¸•à¸·à¸­à¸™ <span id="log-count-warn" class="ml-1 opacity-80">(0)</span>
                            </button>
                            <button onclick="setLogFilter('info')" id="log-filter-info" 
                                    class="touch-target log-filter-btn px-3 py-2 rounded-full text-xs font-semibold bg-slate-200 dark:bg-slate-800 text-slate-600 dark:text-slate-300 whitespace-nowrap transition-colors"
                                    aria-pressed="false">
                                ğŸ”µ à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ <span id="log-count-info" class="ml-1 opacity-80">(0)</span>
                            </button>
                        </div>
                        
                        <!-- Filter by Device Dropdown -->
                        <div class="flex items-center gap-2">
                            <label for="log-device-filter" class="text-xs text-slate-500 dark:text-slate-400 whitespace-nowrap">
                                <i class="fa-solid fa-filter mr-1" aria-hidden="true"></i> Device:
                            </label>
                            <select id="log-device-filter" 
                                    onchange="setLogDeviceFilter(this.value)"
                                    class="flex-1 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-700 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-emerald-500/50">
                                <option value="all">à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</option>
                                <!-- Options à¸ˆà¸°à¸–à¸¹à¸ populate à¹‚à¸”à¸¢ JavaScript -->
                            </select>
                            <span id="log-filtered-count" class="text-xs text-slate-500 dark:text-slate-400 whitespace-nowrap">
                                à¹à¸ªà¸”à¸‡ 0 à¸£à¸²à¸¢à¸à¸²à¸£
                            </span>
                        </div>
                    </div>
                    
                    <!-- Log Loading Skeleton -->
                    <div id="log-skeleton" class="hidden space-y-2 pb-4">
                        <div class="p-3 rounded-r-xl bg-white dark:bg-slate-800/60 border-l-[3px] border-slate-300 dark:border-slate-600">
                            <div class="flex items-start gap-3">
                                <div class="skeleton w-5 h-5 rounded-full mt-0.5"></div>
                                <div class="flex-1">
                                    <div class="flex justify-between items-start gap-2 mb-2">
                                        <div class="skeleton h-4 w-24"></div>
                                        <div class="skeleton h-3 w-32"></div>
                                    </div>
                                    <div class="skeleton h-3 w-3/4"></div>
                                </div>
                            </div>
                        </div>
                        <div class="p-3 rounded-r-xl bg-white dark:bg-slate-800/60 border-l-[3px] border-slate-300 dark:border-slate-600">
                            <div class="flex items-start gap-3">
                                <div class="skeleton w-5 h-5 rounded-full mt-0.5"></div>
                                <div class="flex-1">
                                    <div class="flex justify-between items-start gap-2 mb-2">
                                        <div class="skeleton h-4 w-32"></div>
                                        <div class="skeleton h-3 w-28"></div>
                                    </div>
                                    <div class="skeleton h-3 w-2/3"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="log-list" class="space-y-2 pb-4" role="log" aria-label="Event log"></div>
                    <div id="log-empty" class="hidden text-center py-12 text-slate-400 dark:text-slate-400">
                        <i class="fa-solid fa-clipboard-list text-4xl mb-3 opacity-50" aria-hidden="true"></i>
                        <p class="font-medium">No logs yet</p>
                    </div>
                </div>
            </div>

            <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                 VIEW: SYSTEM
                 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
            <div id="view-system" class="hidden animate-fadeIn">
                <div class="max-w-md mx-auto">
                    <h3 class="text-lg font-semibold text-slate-800 dark:text-white mb-4">à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸£à¸°à¸šà¸š</h3>
                    
                    <!-- User Profile Card -->
                    <div class="bg-white dark:bg-slate-800/60 p-5 rounded-3xl border border-slate-200 dark:border-slate-700 mb-4 flex items-center gap-4">
                        <div class="w-14 h-14 rounded-full bg-gradient-to-br from-emerald-400 to-emerald-600 flex items-center justify-center text-xl text-white shadow-lg">
                            <i class="fa-solid fa-user-shield" aria-hidden="true"></i>
                        </div>
                        <div class="flex-1">
                            <h2 class="text-base font-semibold text-slate-800 dark:text-white">Admin User</h2>
                            <p id="profile-display-name" class="text-sm text-slate-500 dark:text-slate-400">Admin</p>
                            <div class="flex items-center gap-1.5 mt-1">
                                <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse" aria-hidden="true"></div>
                                <span class="text-xs text-emerald-600 dark:text-emerald-400 font-medium">Session Active</span>
                            </div>
                        </div>
                    </div>

                    <!-- v3.2.1: Site Info â€” à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆ -->
                    <div class="bg-white dark:bg-slate-800/60 rounded-2xl p-4 border border-slate-200 dark:border-slate-700 mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider flex items-center gap-2">
                                <i class="fa-solid fa-location-dot text-emerald-500" aria-hidden="true"></i> à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆ
                            </h4>
                            <button onclick="openSiteSettingsModal()"
                                    class="touch-target px-3 py-1.5 text-xs font-semibold text-emerald-600 dark:text-emerald-400 bg-emerald-50 dark:bg-emerald-500/10 rounded-lg border border-emerald-200 dark:border-emerald-500/30 hover:bg-emerald-100 dark:hover:bg-emerald-500/20 transition-colors"
                                    aria-label="à¹à¸à¹‰à¹„à¸‚à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆ">
                                <i class="fa-solid fa-pen-to-square mr-1" aria-hidden="true"></i> à¹à¸à¹‰à¹„à¸‚
                            </button>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-slate-500 dark:text-slate-400">à¸Šà¸·à¹ˆà¸­ à¸£à¸.</span>
                                <span id="site-hospital-display" class="font-medium text-slate-700 dark:text-slate-200 truncate ml-4 text-right">à¸£à¸.à¸¨à¸£à¸µà¸™à¸„à¸£à¸´à¸™à¸—à¸£à¹Œ</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-500 dark:text-slate-400">Unit</span>
                                <span id="site-unit-display" class="font-mono font-medium text-slate-700 dark:text-slate-200 truncate ml-4 text-right">ICU-01</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-500 dark:text-slate-400">à¸Šà¸·à¹ˆà¸­à¹€à¸¥à¹ˆà¸™</span>
                                <span id="site-name-display" class="font-medium text-slate-700 dark:text-slate-200 truncate ml-4 text-right">Admin</span>
                            </div>
                        </div>
                    </div>

                    <!-- v3.2.1: Connection Status â€” à¸ªà¸–à¸²à¸™à¸°à¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ -->
                    <div class="bg-white dark:bg-slate-800/60 rounded-2xl p-4 border border-slate-200 dark:border-slate-700 mb-4">
                        <h4 class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider flex items-center gap-2 mb-3">
                            <i class="fa-solid fa-tower-broadcast text-blue-500" aria-hidden="true"></i> à¸ªà¸–à¸²à¸™à¸°à¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­
                        </h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between items-center">
                                <span class="text-slate-500 dark:text-slate-400">Internet</span>
                                <span id="conn-internet" class="font-medium text-emerald-600 dark:text-emerald-400">
                                    <i class="fa-solid fa-circle text-[8px] mr-1" aria-hidden="true"></i> Online
                                </span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-slate-500 dark:text-slate-400">MQTT Server</span>
                                <span class="font-medium text-slate-400 dark:text-slate-500">
                                    <i class="fa-regular fa-square text-[10px] mr-1" aria-hidden="true"></i> à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹€à¸›à¸´à¸”à¹ƒà¸Šà¹‰à¸‡à¸²à¸™
                                </span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-slate-500 dark:text-slate-400">Database</span>
                                <span class="font-medium text-slate-400 dark:text-slate-500">
                                    <i class="fa-regular fa-square text-[10px] mr-1" aria-hidden="true"></i> à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹€à¸›à¸´à¸”à¹ƒà¸Šà¹‰à¸‡à¸²à¸™
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Settings List -->
                    <div class="space-y-3 mb-6">
                        <!-- Audio Toggle -->
                        <div class="bg-white dark:bg-slate-800/60 p-4 rounded-xl border border-slate-200 dark:border-slate-700 flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <i class="fa-solid fa-volume-high text-slate-400 dark:text-slate-500" aria-hidden="true"></i>
                                <span class="text-sm font-medium text-slate-700 dark:text-slate-200">à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™à¸”à¹‰à¸§à¸¢à¹€à¸ªà¸µà¸¢à¸‡</span>
                            </div>
                            <div id="toggle-audio" class="toggle-switch active" onclick="toggleAudio()" role="switch" aria-checked="true" aria-label="Toggle audio alerts" tabindex="0"></div>
                        </div>
                        
                        <!-- Dark Mode Toggle -->
                        <div class="bg-white dark:bg-slate-800/60 p-4 rounded-xl border border-slate-200 dark:border-slate-700 flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <i class="fa-solid fa-moon text-slate-400 dark:text-slate-500" aria-hidden="true"></i>
                                <span class="text-sm font-medium text-slate-700 dark:text-slate-200">à¹‚à¸«à¸¡à¸”à¸¡à¸·à¸”</span>
                            </div>
                            <div id="toggle-theme" class="toggle-switch" onclick="toggleTheme()" role="switch" aria-checked="false" aria-label="Toggle dark mode" tabindex="0"></div>
                        </div>
                    </div>

                    <!-- System Info -->
                    <div class="bg-white dark:bg-slate-800/60 rounded-2xl p-4 border border-slate-200 dark:border-slate-700 mb-4">
                        <h4 class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase mb-3">System Info</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-slate-500 dark:text-slate-400">Version</span>
                                <span class="font-mono font-medium text-emerald-600 dark:text-emerald-400" id="sys-version">â€”</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-500 dark:text-slate-400">Devices</span>
                                <span class="font-mono font-medium text-slate-700 dark:text-slate-200" id="sys-device-count">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-500 dark:text-slate-400">Log Entries</span>
                                <span class="font-mono font-medium text-slate-700 dark:text-slate-200" id="sys-log-count">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-500 dark:text-slate-400">Storage</span>
                                <span class="font-mono font-medium text-slate-700 dark:text-slate-200" id="sys-storage">0 KB</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-500 dark:text-slate-400">Uptime</span>
                                <span class="font-mono font-medium text-slate-700 dark:text-slate-200" id="sys-uptime">0 à¸™à¸²à¸—à¸µ</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-500 dark:text-slate-400">Last Save</span>
                                <span class="font-mono font-medium text-slate-700 dark:text-slate-200" id="sys-last-save">â€”</span>
                            </div>
                        </div>
                    </div>

                    <!-- Simulation Panel -->
                    <div id="sim-panel" class="sim-panel-wrapper rounded-2xl p-4 border border-dashed mb-4">
                        <div class="flex items-center gap-2 mb-3">
                            <i class="fa-solid fa-flask text-purple-500 dark:text-purple-400" aria-hidden="true"></i>
                            <h4 class="text-xs font-semibold text-slate-600 dark:text-slate-300 uppercase">Developer Simulation</h4>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="setSimEvent('temp_high')" 
                                    class="touch-target sim-btn px-3 py-2.5 bg-red-100 dark:bg-red-500/20 text-red-600 dark:text-red-400 text-xs font-semibold rounded-lg border border-red-200 dark:border-red-500/30 hover:bg-red-200 dark:hover:bg-red-500/30"
                                    aria-label="Simulate high temperature">
                                <i class="fa-solid fa-temperature-arrow-up mr-1" aria-hidden="true"></i> ğŸ”¥ Temp High
                            </button>
                            <!-- v3.2.2: à¹€à¸à¸´à¹ˆà¸¡à¸›à¸¸à¹ˆà¸¡ Temp Low -->
                            <button onclick="setSimEvent('temp_low')" 
                                    class="touch-target sim-btn px-3 py-2.5 bg-cyan-100 dark:bg-cyan-500/20 text-cyan-600 dark:text-cyan-400 text-xs font-semibold rounded-lg border border-cyan-200 dark:border-cyan-500/30 hover:bg-cyan-200 dark:hover:bg-cyan-500/30"
                                    aria-label="Simulate low temperature">
                                <i class="fa-solid fa-temperature-arrow-down mr-1" aria-hidden="true"></i> ğŸ¥¶ Temp Low
                            </button>
                            <button onclick="setSimEvent('ac_off')" 
                                    class="touch-target sim-btn px-3 py-2.5 bg-yellow-100 dark:bg-yellow-500/20 text-yellow-600 dark:text-yellow-400 text-xs font-semibold rounded-lg border border-yellow-200 dark:border-yellow-500/30 hover:bg-yellow-200 dark:hover:bg-yellow-500/30"
                                    aria-label="Simulate power off">
                                <i class="fa-solid fa-plug-circle-xmark mr-1" aria-hidden="true"></i> âš¡ Power Off
                            </button>
                            <!-- v3.2.2: à¹€à¸à¸´à¹ˆà¸¡à¸›à¸¸à¹ˆà¸¡ Battery Low -->
                            <button onclick="setSimEvent('batt_low')" 
                                    class="touch-target sim-btn px-3 py-2.5 bg-orange-100 dark:bg-orange-500/20 text-orange-600 dark:text-orange-400 text-xs font-semibold rounded-lg border border-orange-200 dark:border-orange-500/30 hover:bg-orange-200 dark:hover:bg-orange-500/30"
                                    aria-label="Simulate battery low">
                                <i class="fa-solid fa-battery-quarter mr-1" aria-hidden="true"></i> ğŸ”‹ Battery Low
                            </button>
                            <button onclick="setSimEvent('offline')" 
                                    class="touch-target sim-btn px-3 py-2.5 bg-slate-100 dark:bg-slate-600/30 text-slate-600 dark:text-slate-300 text-xs font-semibold rounded-lg border border-slate-200 dark:border-slate-500/30 hover:bg-slate-200 dark:hover:bg-slate-600/50"
                                    aria-label="Simulate network loss">
                                <i class="fa-solid fa-wifi icon-wifi-off mr-1" aria-hidden="true"></i> ğŸ“¡ Network Loss
                            </button>
                            <!-- v3.2.3: à¹€à¸à¸´à¹ˆà¸¡à¸›à¸¸à¹ˆà¸¡ Weak Signal -->
                            <button onclick="setSimEvent('rssi_low')" 
                                    class="touch-target sim-btn px-3 py-2.5 bg-indigo-100 dark:bg-indigo-500/20 text-indigo-600 dark:text-indigo-400 text-xs font-semibold rounded-lg border border-indigo-200 dark:border-indigo-500/30 hover:bg-indigo-200 dark:hover:bg-indigo-500/30"
                                    aria-label="Simulate weak signal">
                                <i class="fa-solid fa-signal mr-1" aria-hidden="true"></i> ğŸ“¶ Weak Signal
                            </button>
                            <!-- v3.4.0: à¹€à¸à¸´à¹ˆà¸¡à¸›à¸¸à¹ˆà¸¡ Humidity High -->
                            <button onclick="setSimEvent('humi_high')" 
                                    class="touch-target sim-btn px-3 py-2.5 bg-cyan-100 dark:bg-cyan-500/20 text-cyan-600 dark:text-cyan-400 text-xs font-semibold rounded-lg border border-cyan-200 dark:border-cyan-500/30 hover:bg-cyan-200 dark:hover:bg-cyan-500/30"
                                    aria-label="Simulate high humidity">
                                <i class="fa-solid fa-droplet mr-1" aria-hidden="true"></i> ğŸ’§ Humid High
                            </button>
                            <!-- v3.4.0: à¹€à¸à¸´à¹ˆà¸¡à¸›à¸¸à¹ˆà¸¡ Humidity Low -->
                            <button onclick="setSimEvent('humi_low')" 
                                    class="touch-target sim-btn px-3 py-2.5 bg-amber-100 dark:bg-amber-500/20 text-amber-600 dark:text-amber-400 text-xs font-semibold rounded-lg border border-amber-200 dark:border-amber-500/30 hover:bg-amber-200 dark:hover:bg-amber-500/30"
                                    aria-label="Simulate low humidity">
                                <i class="fa-solid fa-droplet-slash mr-1" aria-hidden="true"></i> ğŸœï¸ Humid Low
                            </button>
                        </div>
                        <!-- v3.2.3: à¸¢à¹‰à¸²à¸¢ Reset à¹€à¸›à¹‡à¸™ full width -->
                        <button onclick="setSimEvent('reset')" 
                                class="touch-target sim-btn w-full mt-2 px-3 py-2.5 bg-emerald-100 dark:bg-emerald-500/20 text-emerald-600 dark:text-emerald-400 text-xs font-semibold rounded-lg border border-emerald-200 dark:border-emerald-500/30 hover:bg-emerald-200 dark:hover:bg-emerald-500/30"
                                aria-label="Reset simulation">
                            <i class="fa-solid fa-rotate mr-1" aria-hidden="true"></i> ğŸ”„ Reset Simulation
                        </button>
                        <button onclick="testAudio()" 
                                class="touch-target sim-btn w-full mt-2 px-3 py-2.5 bg-blue-100 dark:bg-blue-500/20 text-blue-600 dark:text-blue-400 text-xs font-semibold rounded-lg border border-blue-200 dark:border-blue-500/30 hover:bg-blue-200 dark:hover:bg-blue-500/30"
                                aria-label="Test alert sound">
                            <i class="fa-solid fa-volume-high mr-1" aria-hidden="true"></i> ğŸ”Š Test Alert Sound
                        </button>
                    </div>

                    <!-- Danger Zone -->
                    <div class="space-y-2">
                        <button onclick="factoryReset()" 
                                class="touch-target w-full p-4 rounded-xl border border-slate-300 dark:border-slate-600 text-slate-500 dark:text-slate-400 hover:text-red-500 hover:border-red-300 dark:hover:border-red-500/50 hover:bg-red-50 dark:hover:bg-red-500/10 transition-colors text-sm font-semibold flex items-center justify-between"
                                aria-label="Factory reset - clear all data">
                            <span><i class="fa-solid fa-rotate-right mr-2" aria-hidden="true"></i> à¸£à¸µà¹€à¸‹à¹‡à¸•à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ (Factory Reset)</span>
                            <i class="fa-solid fa-chevron-right text-xs" aria-hidden="true"></i>
                        </button>
                        <!-- Logout button â€” disabled à¸ˆà¸™à¸à¸§à¹ˆà¸²à¸ˆà¸°à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸£à¸°à¸šà¸š Auth (Phase D) -->
                        <button disabled
                                class="touch-target w-full p-4 rounded-xl bg-slate-300 dark:bg-slate-700 text-slate-400 dark:text-slate-500 transition-colors text-sm font-semibold flex items-center justify-center cursor-not-allowed opacity-60"
                                aria-label="Logout - disabled until Auth system is connected"
                                title="à¸ˆà¸°à¹€à¸›à¸´à¸”à¹ƒà¸Šà¹‰à¹€à¸¡à¸·à¹ˆà¸­à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸£à¸°à¸šà¸š Auth">
                            <i class="fa-solid fa-right-from-bracket mr-2" aria-hidden="true"></i> à¸­à¸­à¸à¸ˆà¸²à¸à¸£à¸°à¸šà¸š
                            <span class="ml-2 text-xs font-normal">(à¸£à¸­à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ Auth)</span>
                        </button>
                    </div>
                    
                    <p class="text-center text-xs text-slate-400 dark:text-slate-500 mt-6" id="sys-build-info">
                        <!-- v3.3.4: Dynamic build info à¸ˆà¸²à¸ APP_VERSION -->
                    </p>
                </div>
            </div>

        </main>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         BOTTOM NAVIGATION - Fixed Outside app-main
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 z-40 glass-light dark:bg-slate-950 dark:border-t dark:border-slate-800 nav-safe" role="navigation" aria-label="Main navigation">
        <div class="flex justify-around items-center h-16 max-w-lg mx-auto">
            <button onclick="switchTab('dashboard')" id="nav-dash" 
                    class="touch-target nav-btn flex flex-col items-center gap-1 w-20 py-2 text-emerald-600 dark:text-emerald-400 transition-all relative"
                    aria-label="Dashboard"
                    aria-current="page">
                <i class="fa-solid fa-layer-group text-xl" aria-hidden="true"></i>
                <span class="text-xs font-medium">Dashboard</span>
                <!-- Critical Badge on Dashboard -->
                <span id="critical-badge-dash" class="badge-counter hidden" aria-label="Critical alerts">0</span>
            </button>
            <button onclick="switchTab('logs')" id="nav-logs" 
                    class="touch-target nav-btn flex flex-col items-center gap-1 w-20 py-2 text-slate-400 dark:text-slate-400 hover:text-emerald-500 dark:hover:text-emerald-400 transition-all relative"
                    aria-label="Logs">
                <i class="fa-solid fa-list-check text-xl" aria-hidden="true"></i>
                <span class="text-xs font-medium">Logs</span>
                <!-- Log Badge -->
                <span id="log-badge" class="badge-counter warning hidden" aria-label="Unread logs">0</span>
            </button>
            <button onclick="switchTab('system')" id="nav-system" 
                    class="touch-target nav-btn flex flex-col items-center gap-1 w-20 py-2 text-slate-400 dark:text-slate-400 hover:text-emerald-500 dark:hover:text-emerald-400 transition-all relative"
                    aria-label="System settings">
                <i class="fa-solid fa-sliders text-xl" aria-hidden="true"></i>
                <span class="text-xs font-medium">System</span>
            </button>
        </div>
    </nav>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         SETTINGS MODAL
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="settings-modal" class="hidden fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/60 backdrop-blur-sm" role="dialog" aria-modal="true" aria-labelledby="settings-modal-title">
        <div class="w-full max-w-sm bg-white dark:bg-slate-900 rounded-t-3xl sm:rounded-2xl p-6 border-t sm:border border-slate-200 dark:border-slate-700 shadow-2xl animate-slideUp">
            <div class="flex justify-between items-center mb-6">
                <h3 id="settings-modal-title" class="text-lg font-semibold text-slate-800 dark:text-white">Device Settings</h3>
                <button onclick="closeSettings()" 
                        class="touch-target w-11 h-11 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-400 hover:text-slate-600 dark:hover:text-white"
                        aria-label="Close settings">
                    <i class="fa-solid fa-xmark" aria-hidden="true"></i>
                </button>
            </div>
            <div class="space-y-4 mb-6">
                <div>
                    <label for="setting-name" class="text-xs text-slate-500 dark:text-slate-400 block mb-1 font-medium">Device Name</label>
                    <input type="text" id="setting-name" 
                           class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg px-3 py-2.5 text-slate-800 dark:text-white text-sm focus:border-emerald-500 focus:outline-none transition-colors" 
                           placeholder="e.g. Cold Storage - OPD"
                           required>
                </div>
                <div>
                    <label for="setting-hwid" class="text-xs text-slate-500 dark:text-slate-400 block mb-1 font-medium">Hardware ID</label>
                    <input type="text" id="setting-hwid" 
                           class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg px-3 py-2.5 text-slate-800 dark:text-white font-mono text-sm focus:border-emerald-500 focus:outline-none transition-colors" 
                           placeholder="e.g. SN-001234">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="setting-min" class="text-xs text-slate-500 dark:text-slate-400 block mb-1 font-medium">Min Temp (Â°C)</label>
                        <input type="number" id="setting-min" step="0.1"
                               class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg px-3 py-2.5 text-slate-800 dark:text-white font-mono focus:border-blue-500 focus:outline-none transition-colors">
                    </div>
                    <div>
                        <label for="setting-max" class="text-xs text-slate-500 dark:text-slate-400 block mb-1 font-medium">Max Temp (Â°C)</label>
                        <input type="number" id="setting-max" step="0.1"
                               class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg px-3 py-2.5 text-slate-800 dark:text-white font-mono focus:border-red-500 focus:outline-none transition-colors">
                    </div>
                </div>
                <!-- v3.4.0: Humidity Limits -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="setting-humi-min" class="text-xs text-slate-500 dark:text-slate-400 block mb-1 font-medium">Min Humidity (%)</label>
                        <input type="number" id="setting-humi-min" step="1"
                               class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg px-3 py-2.5 text-slate-800 dark:text-white font-mono focus:border-cyan-500 focus:outline-none transition-colors">
                    </div>
                    <div>
                        <label for="setting-humi-max" class="text-xs text-slate-500 dark:text-slate-400 block mb-1 font-medium">Max Humidity (%)</label>
                        <input type="number" id="setting-humi-max" step="1"
                               class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg px-3 py-2.5 text-slate-800 dark:text-white font-mono focus:border-cyan-500 focus:outline-none transition-colors">
                    </div>
                </div>
            </div>
            <div class="space-y-2">
                <button onclick="saveSettings()" 
                        class="touch-target w-full bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-3 rounded-xl transition-colors">
                    <i class="fa-solid fa-check mr-1" aria-hidden="true"></i> Save Changes
                </button>
                <button onclick="deleteDevice()" 
                        class="touch-target w-full border border-red-300 dark:border-red-500/50 text-red-500 hover:bg-red-50 dark:hover:bg-red-500/10 font-semibold py-3 rounded-xl transition-colors text-sm">
                    <i class="fa-solid fa-trash mr-1" aria-hidden="true"></i> Delete Device
                </button>
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         ADD DEVICE MODAL
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="add-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm" role="dialog" aria-modal="true" aria-labelledby="add-modal-title">
        <div class="w-full max-w-sm bg-white dark:bg-slate-900 rounded-2xl p-6 border border-slate-200 dark:border-slate-700 shadow-2xl mx-4 animate-zoomIn">
            <div class="flex justify-between items-center mb-6">
                <h3 id="add-modal-title" class="text-lg font-semibold text-slate-800 dark:text-white">à¹€à¸à¸´à¹ˆà¸¡à¸­à¸¸à¸›à¸à¸£à¸“à¹Œà¹ƒà¸«à¸¡à¹ˆ</h3>
                <button onclick="closeAddModal()" 
                        class="touch-target w-11 h-11 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-400 hover:text-slate-600 dark:hover:text-white"
                        aria-label="Close add device modal">
                    <i class="fa-solid fa-xmark" aria-hidden="true"></i>
                </button>
            </div>
            <div class="space-y-4 mb-6">
                <div>
                    <label for="add-name" class="text-xs text-slate-500 dark:text-slate-400 block mb-1 font-medium">Device Name *</label>
                    <input type="text" id="add-name" 
                           class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg px-3 py-2.5 text-slate-800 dark:text-white text-sm focus:border-emerald-500 focus:outline-none transition-colors" 
                           placeholder="e.g. Cold Storage - OPD"
                           required>
                </div>
                <div>
                    <label for="add-hw-id" class="text-xs text-slate-500 dark:text-slate-400 block mb-1 font-medium">Hardware ID</label>
                    <input type="text" id="add-hw-id" 
                           class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg px-3 py-2.5 text-slate-800 dark:text-white font-mono text-sm focus:border-emerald-500 focus:outline-none transition-colors" 
                           placeholder="e.g. SN-001234">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="add-min" class="text-xs text-slate-500 dark:text-slate-400 block mb-1 font-medium">Min Temp (Â°C)</label>
                        <input type="number" id="add-min" step="0.1" value="2"
                               class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg px-3 py-2.5 text-slate-800 dark:text-white font-mono focus:border-emerald-500 focus:outline-none transition-colors">
                    </div>
                    <div>
                        <label for="add-max" class="text-xs text-slate-500 dark:text-slate-400 block mb-1 font-medium">Max Temp (Â°C)</label>
                        <input type="number" id="add-max" step="0.1" value="8"
                               class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg px-3 py-2.5 text-slate-800 dark:text-white font-mono focus:border-emerald-500 focus:outline-none transition-colors">
                    </div>
                </div>
                <!-- v3.4.0: Humidity Limits -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="add-humi-min" class="text-xs text-slate-500 dark:text-slate-400 block mb-1 font-medium">Min Humidity (%)</label>
                        <input type="number" id="add-humi-min" step="1" value="30"
                               class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg px-3 py-2.5 text-slate-800 dark:text-white font-mono focus:border-cyan-500 focus:outline-none transition-colors">
                    </div>
                    <div>
                        <label for="add-humi-max" class="text-xs text-slate-500 dark:text-slate-400 block mb-1 font-medium">Max Humidity (%)</label>
                        <input type="number" id="add-humi-max" step="1" value="80"
                               class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg px-3 py-2.5 text-slate-800 dark:text-white font-mono focus:border-cyan-500 focus:outline-none transition-colors">
                    </div>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="closeAddModal()" 
                        class="touch-target w-1/2 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-semibold py-3 rounded-xl hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                    Cancel
                </button>
                <button onclick="addDevice()" 
                        class="touch-target w-1/2 bg-emerald-500 text-white font-semibold py-3 rounded-xl hover:bg-emerald-600 transition-colors">
                    <i class="fa-solid fa-plus mr-1" aria-hidden="true"></i> Add
                </button>
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         SITE SETTINGS MODAL (v3.2.1)
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="site-settings-modal" class="hidden fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/60 backdrop-blur-sm" role="dialog" aria-modal="true" aria-labelledby="site-settings-modal-title">
        <div class="w-full max-w-sm bg-white dark:bg-slate-900 rounded-t-3xl sm:rounded-2xl p-6 border-t sm:border border-slate-200 dark:border-slate-700 shadow-2xl animate-slideUp">
            <div class="flex justify-between items-center mb-6">
                <h3 id="site-settings-modal-title" class="text-lg font-semibold text-slate-800 dark:text-white">
                    <i class="fa-solid fa-location-dot text-emerald-500 mr-2" aria-hidden="true"></i>à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆ
                </h3>
                <button onclick="closeSiteSettingsModal()" 
                        class="touch-target w-11 h-11 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-400 hover:text-slate-600 dark:hover:text-white"
                        aria-label="à¸›à¸´à¸”">
                    <i class="fa-solid fa-xmark" aria-hidden="true"></i>
                </button>
            </div>
            <div class="space-y-4 mb-6">
                <div>
                    <label for="site-hospital-input" class="text-xs text-slate-500 dark:text-slate-400 block mb-1 font-medium">à¸Šà¸·à¹ˆà¸­à¹‚à¸£à¸‡à¸à¸¢à¸²à¸šà¸²à¸¥</label>
                    <input type="text" id="site-hospital-input" 
                           class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg px-3 py-2.5 text-slate-800 dark:text-white text-sm focus:border-emerald-500 focus:outline-none transition-colors"
                           placeholder="à¹€à¸Šà¹ˆà¸™ à¸£à¸.à¸¨à¸£à¸µà¸™à¸„à¸£à¸´à¸™à¸—à¸£à¹Œ" maxlength="50">
                </div>
                <div>
                    <label for="site-unit-input" class="text-xs text-slate-500 dark:text-slate-400 block mb-1 font-medium">à¸Šà¸·à¹ˆà¸­ Unit / à¹à¸œà¸™à¸</label>
                    <input type="text" id="site-unit-input" 
                           class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg px-3 py-2.5 text-slate-800 dark:text-white font-mono text-sm focus:border-emerald-500 focus:outline-none transition-colors"
                           placeholder="à¹€à¸Šà¹ˆà¸™ ICU-01" maxlength="30">
                </div>
                <div>
                    <label for="site-displayname-input" class="text-xs text-slate-500 dark:text-slate-400 block mb-1 font-medium">à¸Šà¸·à¹ˆà¸­à¹€à¸¥à¹ˆà¸™ (Display Name)</label>
                    <input type="text" id="site-displayname-input" 
                           class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg px-3 py-2.5 text-slate-800 dark:text-white text-sm focus:border-emerald-500 focus:outline-none transition-colors"
                           placeholder="à¹€à¸Šà¹ˆà¸™ à¸à¸µà¹ˆà¸™à¸, à¸„à¸¸à¸“à¸«à¸¡à¸­" maxlength="30">
                    <p class="text-xs text-slate-400 dark:text-slate-400 mt-1">à¹ƒà¸Šà¹‰à¹à¸ªà¸”à¸‡à¹ƒà¸™ Logs à¹€à¸¡à¸·à¹ˆà¸­à¸—à¸³à¸£à¸²à¸¢à¸à¸²à¸£</p>
                </div>
            </div>
            <div class="space-y-2">
                <button onclick="saveSiteSettingsFromModal()" 
                        class="touch-target w-full bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-3 rounded-xl transition-colors">
                    <i class="fa-solid fa-check mr-1" aria-hidden="true"></i> à¸šà¸±à¸™à¸—à¸¶à¸
                </button>
                <button onclick="closeSiteSettingsModal()" 
                        class="touch-target w-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-semibold py-3 rounded-xl hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors text-sm">
                    à¸¢à¸à¹€à¸¥à¸´à¸
                </button>
            </div>
        </div>
    </div>

    <!-- â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
         â•‘                   JAVASCRIPT APPLICATION                   â•‘
         â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CONSTANTS & CONFIGURATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const DB_KEY = 'vaccine_monitor_ultimate_v3';
        const SITE_SETTINGS_KEY = 'vaccine_site_settings'; // v3.2.1: localStorage key à¸ªà¸³à¸«à¸£à¸±à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆ
        const DATA_VERSION = 'v3.3'; // v3.3: Phase B â€” ECharts + Map Lookup
        
        // v3.4.0: APP_VERSION â€” Single Source of Truth à¸ªà¸³à¸«à¸£à¸±à¸š version number
        const APP_VERSION = {
            major: 3,
            minor: 4,
            patch: 0,
            get full() { return `v${this.major}.${this.minor}.${this.patch}`; },
            get short() { return `v${this.major}.${this.minor}`; },
            date: '2026-02-04',
            phase: 'Humidity Feature'
        };
        
        // v3.3.4: APP_NAME â€” Single Source of Truth à¸ªà¸³à¸«à¸£à¸±à¸šà¸Šà¸·à¹ˆà¸­ app
        const APP_NAME = {
            brand: '360DE',
            full: '360DE Temperature Monitor',
            short: '360DE TempMon',
            system: 'Temperature Monitor'
        };
        
        // AUTH_KEY â€” à¸¥à¸šà¸­à¸­à¸à¹ƒà¸™ v3.2 (à¸ˆà¸°à¸¢à¹‰à¸²à¸¢à¹„à¸› index.html à¹ƒà¸™ Phase D)
        const OFFLINE_THRESHOLD = 5000;
        const MAX_HISTORY = 60;
        const MAX_HISTORY_24H = 288; // 5-min intervals for 24h
        const MAX_HISTORY_7D = 336;  // 30-min intervals for 7 days (v3.2: à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸ˆà¸²à¸ 1hrâ†’30min)
        const MAX_LOGS = 100;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // APPLICATION STATE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let devices = [];
        let deviceMap = new Map(); // v3.3: O(1) lookup by device ID
        let logs = [];
        let unreadLogs = 0;
        let selectedId = null;
        let filterType = 'all';
        let chart = null;
        let simEvent = null;
        let simTargetId = null; // v3.2.2: device ID à¸—à¸µà¹ˆà¸–à¸¹à¸ simulate (à¸„à¹‰à¸²à¸‡à¸­à¸¢à¸¹à¹ˆà¹à¸¡à¹‰à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸«à¸™à¹‰à¸²)
        let isResetting = false; // v3.2.2: flag à¸›à¹‰à¸­à¸‡à¸à¸±à¸™ save à¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡ factory reset
        let audioCtx = null;
        let audioEnabled = true;
        let loopInterval = null;
        let prevTempValues = {};
        let currentTimeRange = '1h';
        let historyTick = 0; // v3.2: tick counter à¸ªà¸³à¸«à¸£à¸±à¸š history interval (1 tick = 3s)
        let prevStatuses = {}; // v3.2.2: à¹€à¸à¹‡à¸š status à¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸²à¸‚à¸­à¸‡à¹à¸•à¹ˆà¸¥à¸° device à¸ªà¸³à¸«à¸£à¸±à¸š transition log (runtime only)
        
        // v3.2.3: à¹€à¸à¹‡à¸š sub-status à¹à¸¢à¸à¸ªà¸³à¸«à¸£à¸±à¸š transition log à¸—à¸µà¹ˆà¹à¸¡à¹ˆà¸™à¸¢à¸³à¸‚à¸¶à¹‰à¸™ (runtime only)
        let prevTempStatus = {};    // 'normal', 'critical'
        let prevPowerStatus = {};   // 'normal', 'off'
        let prevBatteryStatus = {}; // 'normal', 'low', 'critical'
        let prevSignalStatus = {};  // 'normal', 'weak', 'critical'
        let prevHumiStatus = {};    // v3.4.0: 'normal', 'warning', 'critical'
        
        // v3.2.3: Log Filter State
        let logFilterType = 'all';    // 'all', 'crit', 'warn', 'info'
        let logFilterDevice = 'all';  // 'all' à¸«à¸£à¸·à¸­ device name
        
        // v3.2.1: Site Settings â€” à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆ (à¹€à¸à¹‡à¸šà¹ƒà¸™ localStorage à¹à¸¢à¸)
        let siteSettings = {
            hospital: 'à¸£à¸.à¸¨à¸£à¸µà¸™à¸„à¸£à¸´à¸™à¸—à¸£à¹Œ',
            unit: 'ICU-01',
            displayName: 'Admin'
        };
        
        // v3.2.1: Uptime + Last Save tracking
        const appStartTime = Date.now();
        let lastSaveTime = null;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // v3.2 UTILITIES â€” XSS Sanitize + DOM Optimization
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // Task #5: à¸›à¹‰à¸­à¸‡à¸à¸±à¸™ XSS â€” à¹ƒà¸Šà¹‰à¸à¸±à¸š user-provided data à¸à¹ˆà¸­à¸™ render à¸”à¹‰à¸§à¸¢ innerHTML
        // à¹€à¸•à¸£à¸µà¸¢à¸¡à¸£à¸­à¸‡à¸£à¸±à¸šà¹€à¸¡à¸·à¹ˆà¸­à¸£à¸±à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ MQTT/Supabase à¹ƒà¸™à¸­à¸™à¸²à¸„à¸•
        function sanitizeHTML(str) {
            if (typeof str !== 'string') return '';
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }
        
        // Task #6: DOM cache à¸ªà¸³à¸«à¸£à¸±à¸š skip render à¹€à¸¡à¸·à¹ˆà¸­à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸¡à¹ˆà¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™
        let prevDashboardHash = '';   // fingerprint à¸‚à¸­à¸‡ dashboard state
        let prevDetailCache = {};     // cache à¸„à¹ˆà¸²à¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸²à¸‚à¸­à¸‡ detail view

        // à¸ªà¸£à¹‰à¸²à¸‡ fingerprint à¸ªà¸³à¸«à¸£à¸±à¸šà¹€à¸›à¸£à¸µà¸¢à¸šà¹€à¸—à¸µà¸¢à¸š state
        function getDashboardHash(filtered) {
            return filtered.map(d => 
                `${d.id}:${d.temp.toFixed(1)}:${d.humi.toFixed(0)}:${d.status}:${d.ack}:${d.vin.toFixed(1)}`
            ).join('|');
        }
        
        // Task #7: Debounce â€” à¸Šà¸°à¸¥à¸­à¸à¸²à¸£à¹€à¸£à¸µà¸¢à¸ fn à¸ˆà¸™à¸à¸§à¹ˆà¸²à¸ˆà¸°à¸«à¸¢à¸¸à¸”à¸à¸´à¸¡à¸à¹Œ
        function debounce(fn, delay) {
            let timer = null;
            return function(...args) {
                clearTimeout(timer);
                timer = setTimeout(() => fn.apply(this, args), delay);
            };
        }
        
        // Task #7: Throttle â€” à¹€à¸£à¸µà¸¢à¸ fn à¹„à¸”à¹‰à¸ªà¸¹à¸‡à¸ªà¸¸à¸” 1 à¸„à¸£à¸±à¹‰à¸‡à¸•à¹ˆà¸­ delay
        function throttle(fn, delay) {
            let lastRun = 0;
            let timer = null;
            return function(...args) {
                const now = Date.now();
                const remaining = delay - (now - lastRun);
                clearTimeout(timer);
                if (remaining <= 0) {
                    lastRun = now;
                    fn.apply(this, args);
                } else {
                    // à¸•à¸±à¹‰à¸‡ timer à¸ªà¸³à¸£à¸­à¸‡ à¹€à¸à¸·à¹ˆà¸­à¹„à¸¡à¹ˆà¹ƒà¸«à¹‰à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸¸à¸”à¸—à¹‰à¸²à¸¢à¸«à¸²à¸¢
                    timer = setTimeout(() => {
                        lastRun = Date.now();
                        fn.apply(this, args);
                    }, remaining);
                }
            };
        }
        
        // à¸ªà¸£à¹‰à¸²à¸‡ debounced search (300ms) + throttled save (10s)
        const debouncedSearch = debounce(() => {
            prevDashboardHash = ''; // reset hash à¸šà¸±à¸‡à¸„à¸±à¸š re-render à¹€à¸¡à¸·à¹ˆà¸­ search à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™
            renderList();
        }, 300);
        
        const throttledSave = throttle(saveData, 10000);
        
        // v3.3: Sync deviceMap à¸à¸±à¸š devices array à¸ªà¸³à¸«à¸£à¸±à¸š O(1) lookup
        // à¹€à¸£à¸µà¸¢à¸à¸—à¸¸à¸à¸„à¸£à¸±à¹‰à¸‡à¸—à¸µà¹ˆ devices array à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹à¸›à¸¥à¸‡ (load, add, delete)
        function syncDeviceMap() {
            deviceMap.clear();
            devices.forEach(dev => deviceMap.set(dev.id, dev));
        }
        
        // v3.3: Helper function à¸ªà¸³à¸«à¸£à¸±à¸š get device by ID (O(1) à¹à¸—à¸™ O(n))
        function getDeviceById(id) {
            return deviceMap.get(id) || null;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // v3.2.1: SITE SETTINGS â€” à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆ (à¸Šà¸·à¹ˆà¸­ à¸£à¸., Unit, à¸Šà¸·à¹ˆà¸­à¹€à¸¥à¹ˆà¸™)
        // à¹€à¸à¹‡à¸šà¹ƒà¸™ localStorage key à¹à¸¢à¸à¸ˆà¸²à¸ device data
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        /** à¹‚à¸«à¸¥à¸” site settings à¸ˆà¸²à¸ localStorage */
        function loadSiteSettings() {
            try {
                const saved = localStorage.getItem(SITE_SETTINGS_KEY);
                if (saved) {
                    const parsed = JSON.parse(saved);
                    siteSettings.hospital = parsed.hospital || siteSettings.hospital;
                    siteSettings.unit = parsed.unit || siteSettings.unit;
                    siteSettings.displayName = parsed.displayName || siteSettings.displayName;
                }
            } catch (e) {
                console.warn('Error loading site settings:', e);
            }
            updateSiteDisplay();
        }
        
        /** à¸šà¸±à¸™à¸—à¸¶à¸ site settings à¸¥à¸‡ localStorage */
        function saveSiteSettings() {
            try {
                localStorage.setItem(SITE_SETTINGS_KEY, JSON.stringify(siteSettings));
            } catch (e) {
                console.error('Error saving site settings:', e);
            }
        }
        
        /** à¸­à¸±à¸à¹€à¸”à¸•à¸à¸²à¸£à¹à¸ªà¸”à¸‡à¸œà¸¥à¸—à¸¸à¸à¸ˆà¸¸à¸”à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰ siteSettings */
        function updateSiteDisplay() {
            const h = sanitizeHTML(siteSettings.hospital);
            const u = sanitizeHTML(siteSettings.unit);
            const d = sanitizeHTML(siteSettings.displayName);
            
            // Header
            const headerHospital = document.getElementById('header-hospital');
            if (headerHospital) headerHospital.textContent = siteSettings.hospital;
            
            const headerUnit = document.getElementById('header-unit');
            if (headerUnit) headerUnit.textContent = 'Unit: ' + siteSettings.unit;
            
            // System tab â€” Site Info section
            const siteHospitalDisplay = document.getElementById('site-hospital-display');
            if (siteHospitalDisplay) siteHospitalDisplay.textContent = siteSettings.hospital;
            
            const siteUnitDisplay = document.getElementById('site-unit-display');
            if (siteUnitDisplay) siteUnitDisplay.textContent = siteSettings.unit;
            
            const siteNameDisplay = document.getElementById('site-name-display');
            if (siteNameDisplay) siteNameDisplay.textContent = siteSettings.displayName;
            
            // Profile Card â€” à¸Šà¸·à¹ˆà¸­à¹€à¸¥à¹ˆà¸™
            const profileDisplayName = document.getElementById('profile-display-name');
            if (profileDisplayName) profileDisplayName.textContent = siteSettings.displayName;
            
            // Logs â€” subtitle à¹à¸ªà¸”à¸‡ à¸Šà¸·à¹ˆà¸­ à¸£à¸. â€¢ Unit
            const logsSubtitle = document.getElementById('logs-subtitle');
            if (logsSubtitle) logsSubtitle.textContent = siteSettings.hospital + ' \u2022 ' + siteSettings.unit;
        }
        
        /** à¹€à¸›à¸´à¸” Site Settings Modal */
        function openSiteSettingsModal() {
            document.getElementById('site-hospital-input').value = siteSettings.hospital;
            document.getElementById('site-unit-input').value = siteSettings.unit;
            document.getElementById('site-displayname-input').value = siteSettings.displayName;
            document.getElementById('site-settings-modal').classList.remove('hidden');
            document.getElementById('site-hospital-input').focus();
        }
        
        /** à¸›à¸´à¸” Site Settings Modal */
        function closeSiteSettingsModal() {
            document.getElementById('site-settings-modal').classList.add('hidden');
        }
        
        /** à¸šà¸±à¸™à¸—à¸¶à¸à¸ˆà¸²à¸ Modal â†’ update state + localStorage + UI */
        function saveSiteSettingsFromModal() {
            const hospital = document.getElementById('site-hospital-input').value.trim();
            const unit = document.getElementById('site-unit-input').value.trim();
            const displayName = document.getElementById('site-displayname-input').value.trim();
            
            if (!hospital) {
                window.Toast?.fire({ icon: 'warning', title: 'à¸à¸£à¸¸à¸“à¸²à¹ƒà¸ªà¹ˆà¸Šà¸·à¹ˆà¸­à¹‚à¸£à¸‡à¸à¸¢à¸²à¸šà¸²à¸¥' });
                return;
            }
            if (!unit) {
                window.Toast?.fire({ icon: 'warning', title: 'à¸à¸£à¸¸à¸“à¸²à¹ƒà¸ªà¹ˆà¸Šà¸·à¹ˆà¸­ Unit' });
                return;
            }
            if (!displayName) {
                window.Toast?.fire({ icon: 'warning', title: 'à¸à¸£à¸¸à¸“à¸²à¹ƒà¸ªà¹ˆà¸Šà¸·à¹ˆà¸­à¹€à¸¥à¹ˆà¸™' });
                return;
            }
            
            siteSettings.hospital = hospital;
            siteSettings.unit = unit;
            siteSettings.displayName = displayName;
            
            saveSiteSettings();
            updateSiteDisplay();
            closeSiteSettingsModal();
            
            window.Toast?.fire({ icon: 'success', title: 'à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ!' });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // INITIALIZATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        document.addEventListener('DOMContentLoaded', () => {
            const isDark = localStorage.theme === 'dark' || 
                          (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
            if (isDark) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            updateThemeUI();
            loadSiteSettings(); // v3.2.1: à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆ
            loadData();
            
            // v3.2: à¹€à¸£à¸µà¸¢à¸ showApp() à¸•à¸£à¸‡ (à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡ auth â€” à¸ˆà¸°à¹€à¸à¸´à¹ˆà¸¡à¸à¸¥à¸±à¸šà¹ƒà¸™ Phase D)
            showApp();
            
            window.Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
                didOpen: (toast) => {
                    toast.addEventListener('mouseenter', Swal.stopTimer);
                    toast.addEventListener('mouseleave', Swal.resumeTimer);
                }
            });
            
            // Add keyboard support for toggle switches
            document.querySelectorAll('.toggle-switch').forEach(el => {
                el.addEventListener('keydown', (e) => {
                    if (e.key === ' ' || e.key === 'Enter') {
                        e.preventDefault();
                        el.click();
                    }
                });
            });
        });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DATA MANAGEMENT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // v3.2: à¹à¸à¹‰à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡ double-encoded UTF-8 à¸ˆà¸²à¸ localStorage à¹€à¸à¹ˆà¸²
        // à¸ªà¸²à¹€à¸«à¸•à¸¸: à¹„à¸Ÿà¸¥à¹Œ v3.1 à¸¡à¸µ Thai text à¸—à¸µà¹ˆà¸–à¸¹à¸ encode à¸‹à¹‰à¸­à¸™ 2 à¸Šà¸±à¹‰à¸™
        function fixDoubleEncoded(str) {
            if (typeof str !== 'string' || str.length === 0) return str;
            // à¸–à¹‰à¸²à¸¡à¸µ character > 0xFF à¹à¸ªà¸”à¸‡à¸§à¹ˆà¸² encode à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡à¹à¸¥à¹‰à¸§ (à¹€à¸Šà¹ˆà¸™ Thai Unicode U+0E00+)
            for (let i = 0; i < str.length; i++) {
                if (str.charCodeAt(i) > 0xFF) return str;
            }
            // à¸–à¹‰à¸²à¹€à¸›à¹‡à¸™ ASCII à¸¥à¹‰à¸§à¸™ à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡ fix
            if (!/[\u0080-\u00ff]/.test(str)) return str;
            try {
                // à¹à¸›à¸¥à¸‡ character codes à¸à¸¥à¸±à¸šà¹€à¸›à¹‡à¸™ bytes â†’ decode à¹€à¸›à¹‡à¸™ UTF-8 à¸—à¸µà¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡
                const bytes = new Uint8Array(str.length);
                for (let i = 0; i < str.length; i++) {
                    bytes[i] = str.charCodeAt(i);
                }
                const decoded = new TextDecoder('utf-8').decode(bytes);
                // à¸•à¸£à¸§à¸ˆà¸§à¹ˆà¸² decode à¹à¸¥à¹‰à¸§à¹„à¸”à¹‰ Thai/emoji à¸ˆà¸£à¸´à¸‡ à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¸‚à¸¢à¸°
                if (/[\u0E00-\u0E7F]|[\u{1F300}-\u{1F9FF}]/u.test(decoded)) return decoded;
                return str;
            } catch (e) {
                return str;
            }
        }
        
        // v3.2: Migrate à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ localStorage à¹€à¸à¹ˆà¸²à¸—à¸µà¹ˆà¸¡à¸µ double-encoded text
        function migrateStoredData(data) {
            let migrated = false;
            if (data.devices) {
                data.devices.forEach(dev => {
                    const fixedName = fixDoubleEncoded(dev.name);
                    if (fixedName !== dev.name) { dev.name = fixedName; migrated = true; }
                    if (dev.hw_id) {
                        const fixedHwid = fixDoubleEncoded(dev.hw_id);
                        if (fixedHwid !== dev.hw_id) { dev.hw_id = fixedHwid; migrated = true; }
                    }
                });
            }
            if (data.logs) {
                data.logs.forEach(log => {
                    const fixedMsg = fixDoubleEncoded(log.msg);
                    if (fixedMsg !== log.msg) { log.msg = fixedMsg; migrated = true; }
                    const fixedDev = fixDoubleEncoded(log.dev);
                    if (fixedDev !== log.dev) { log.dev = fixedDev; migrated = true; }
                });
            }
            data.dataVersion = DATA_VERSION;
            if (migrated) {
                console.log('âœ… Migrated double-encoded data to v3.2');
            }
            return migrated;
        }

        function loadData() {
            try {
                const saved = localStorage.getItem(DB_KEY);
                if (saved) {
                    const data = JSON.parse(saved);
                    
                    // v3.2: à¸•à¸£à¸§à¸ˆ version â†’ migrate à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸à¹ˆà¸²à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´
                    if (data.dataVersion !== DATA_VERSION) {
                        migrateStoredData(data);
                    }
                    
                    devices = data.devices || [];
                    logs = data.logs || [];
                    unreadLogs = data.unreadLogs || 0;
                    
                    // Ensure extended history exists + v3.4.0: migrate humidity limits
                    devices.forEach(dev => {
                        if (!dev.history24h) generateExtendedHistory(dev);
                        // v3.4.0: Migration â€” à¹€à¸à¸´à¹ˆà¸¡ humi_min, humi_max à¹ƒà¸«à¹‰ devices à¹€à¸à¹ˆà¸²
                        if (dev.humi_min === undefined) dev.humi_min = 30;
                        if (dev.humi_max === undefined) dev.humi_max = 80;
                    });
                    
                    // v3.3: Sync deviceMap à¸«à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸” devices
                    syncDeviceMap();
                    
                    // à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆ migrate à¹à¸¥à¹‰à¸§
                    if (data.dataVersion !== DATA_VERSION) {
                        saveData();
                    }
                } else {
                    initDefaultData();
                }
            } catch (error) {
                console.error('Error loading data:', error);
                initDefaultData();
            }
            updateCounts();
        }

        function saveData() {
            // v3.2.2: à¸›à¹‰à¸­à¸‡à¸à¸±à¸™ save à¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡ factory reset
            if (isResetting) {
                console.log('â­ï¸ saveData skipped (isResetting)');
                return;
            }
            try {
                const data = JSON.stringify({ devices, logs, unreadLogs, dataVersion: DATA_VERSION });
                localStorage.setItem(DB_KEY, data);
                lastSaveTime = Date.now(); // v3.2.1: à¸šà¸±à¸™à¸—à¸¶à¸à¹€à¸§à¸¥à¸² save à¸¥à¹ˆà¸²à¸ªà¸¸à¸”
                updateCounts();
            } catch (error) {
                console.error('Error saving data:', error);
                if (error.name === 'QuotaExceededError') {
                    window.Toast?.fire({ icon: 'error', title: 'Storage Full!' });
                }
            }
        }

        function initDefaultData() {
            devices = [
                createDevice('d1', 'à¸•à¸¹à¹‰à¹à¸Šà¹ˆà¸§à¸±à¸„à¸‹à¸µà¸™ OPD', 'SN-VF001', 2.0, 8.0),
                createDevice('d2', 'à¸•à¸¹à¹‰à¹€à¸à¹‡à¸šà¹€à¸¥à¸·à¸­à¸” Blood Bank', 'SN-BB002', 2.0, 8.0),
                createDevice('d3', 'à¸«à¹‰à¸­à¸‡à¸¢à¸² ER', 'SN-ER003', 18.0, 25.0),
                createDevice('d4', 'à¸•à¸¹à¹‰à¹à¸Šà¹ˆà¹à¸‚à¹‡à¸‡ Lab', 'SN-LB004', -25.0, -15.0),
                createDevice('d5', 'à¸£à¸–à¹€à¸„à¸¥à¸·à¹ˆà¸­à¸™à¸—à¸µà¹ˆ Mobile Unit', 'SN-MV005', 2.0, 8.0)
            ];
            devices.forEach(d => {
                generateMockHistory(d);
                generateExtendedHistory(d);
            });
            
            // v3.3: Sync deviceMap à¸«à¸¥à¸±à¸‡à¸ªà¸£à¹‰à¸²à¸‡ devices
            syncDeviceMap();
            
            logs = [{ 
                t: new Date().toLocaleString('th-TH'), 
                dev: 'System', 
                msg: `ğŸš€ System Initialized - ${APP_VERSION.full}`,  // v3.4.0: à¹ƒà¸Šà¹‰ APP_VERSION à¹à¸—à¸™ hardcode
                type: 'info' 
            }];
            unreadLogs = 1;
            saveData();
        }

        // v3.4.0: à¹€à¸à¸´à¹ˆà¸¡ humi_min, humi_max parameters (default: 30, 80)
        function createDevice(id, name, hwid, min, max, humi_min = 30, humi_max = 80) {
            const baseTemp = (min + max) / 2;
            return {
                id, name, hw_id: hwid,
                temp: baseTemp + (Math.random() - 0.5) * 2,
                humi: 45 + Math.floor(Math.random() * 20),
                vin: 5.0 + Math.random() * 0.2,
                vbat: 3.8 + Math.random() * 0.4,
                ibat: 0,
                rssi: -60 - Math.floor(Math.random() * 40),
                min, max,
                humi_min, humi_max,  // v3.4.0: Humidity limits
                status: 'normal',
                ack: false,
                lastUpdate: Date.now(),
                lastSeen: new Date().toLocaleString('th-TH'),
                history: [],
                history24h: [],
                history7d: []
            };
        }

        function generateMockHistory(dev) {
            dev.history = [];
            const baseTemp = (dev.min + dev.max) / 2;
            const now = Date.now();
            for (let i = 59; i >= 0; i--) {
                const time = new Date(now - i * 60000);
                dev.history.push({
                    t: time.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }),
                    v: baseTemp + (Math.random() - 0.5) * 3,
                    h: dev.humi + (Math.random() - 0.5) * 10
                });
            }
        }

        // Generate extended history for 24H and 7D views
        function generateExtendedHistory(dev) {
            const baseTemp = (dev.min + dev.max) / 2;
            const now = Date.now();
            
            // 24H history (5-minute intervals)
            dev.history24h = [];
            for (let i = 287; i >= 0; i--) {
                const time = new Date(now - i * 5 * 60000);
                const hourOfDay = time.getHours();
                // Simulate slight temperature variation based on time of day
                const dayVariation = Math.sin((hourOfDay - 6) * Math.PI / 12) * 0.5;
                dev.history24h.push({
                    t: time.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }),
                    v: baseTemp + dayVariation + (Math.random() - 0.5) * 2,
                    h: dev.humi + (Math.random() - 0.5) * 8
                });
            }
            
            // 7D history (30-minute intervals) â€” v3.2: à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸ˆà¸²à¸ 1hr/168 â†’ 30min/336
            dev.history7d = [];
            const dayNames = ['à¸­à¸².', 'à¸ˆ.', 'à¸­.', 'à¸.', 'à¸à¸¤.', 'à¸¨.', 'à¸ª.'];
            for (let i = 335; i >= 0; i--) {
                const time = new Date(now - i * 30 * 60000);
                const dayName = dayNames[time.getDay()];
                const hour = time.getHours();
                const minute = time.getMinutes();
                // Simulate temperature trend over the week
                const dayVariation = Math.sin((hour - 6) * Math.PI / 12) * 0.5;
                const weekVariation = Math.sin(i / 48 * Math.PI / 3.5) * 0.3;
                dev.history7d.push({
                    t: `${dayName} ${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`,
                    v: baseTemp + dayVariation + weekVariation + (Math.random() - 0.5) * 1.5,
                    h: dev.humi + (Math.random() - 0.5) * 6
                });
            }
        }

        function updateCounts() {
            const unitEl = document.getElementById('unit-count');
            if (unitEl) unitEl.innerText = devices.length;
            
            const sysDevEl = document.getElementById('sys-device-count');
            const sysLogEl = document.getElementById('sys-log-count');
            const sysStorageEl = document.getElementById('sys-storage');
            const sysVersionEl = document.getElementById('sys-version');
            
            if (sysDevEl) sysDevEl.innerText = devices.length;
            if (sysLogEl) sysLogEl.innerText = logs.length;
            if (sysStorageEl) {
                const bytes = new Blob([JSON.stringify({ devices, logs })]).size;
                sysStorageEl.innerText = (bytes / 1024).toFixed(2) + ' KB';
            }
            
            // v3.3.3: à¸­à¸±à¸à¹€à¸”à¸• Version à¸ˆà¸²à¸ APP_VERSION constant
            if (sysVersionEl) sysVersionEl.innerText = APP_VERSION.full;
            
            // v3.3.4: à¸­à¸±à¸à¹€à¸”à¸• Build Info à¸ˆà¸²à¸ APP_VERSION + APP_NAME
            const sysBuildEl = document.getElementById('sys-build-info');
            if (sysBuildEl) sysBuildEl.innerText = `Build ${APP_VERSION.full} â€¢ Local Storage Active`;
            
            // v3.2.1: à¸­à¸±à¸à¹€à¸”à¸• Uptime
            const sysUptimeEl = document.getElementById('sys-uptime');
            if (sysUptimeEl) {
                sysUptimeEl.innerText = formatUptime(Date.now() - appStartTime);
            }
            
            // v3.2.1: à¸­à¸±à¸à¹€à¸”à¸• Last Save
            const sysLastSaveEl = document.getElementById('sys-last-save');
            if (sysLastSaveEl) {
                sysLastSaveEl.innerText = lastSaveTime 
                    ? new Date(lastSaveTime).toLocaleTimeString('th-TH', { hour12: false }) 
                    : 'â€”';
            }
            
            updateBadges();
        }
        
        /** v3.2.1: à¹à¸›à¸¥à¸‡ milliseconds à¹€à¸›à¹‡à¸™ "X à¸Šà¸¡. Y à¸™à¸²à¸—à¸µ" */
        function formatUptime(ms) {
            const totalMin = Math.floor(ms / 60000);
            const hours = Math.floor(totalMin / 60);
            const mins = totalMin % 60;
            if (hours > 0) {
                return `${hours} à¸Šà¸¡. ${mins} à¸™à¸²à¸—à¸µ`;
            }
            return `${mins} à¸™à¸²à¸—à¸µ`;
        }

        function updateBadges() {
            // Critical badge on Dashboard
            const criticalCount = devices.filter(d => d.status === 'critical' && !d.ack).length;
            const critBadgeDash = document.getElementById('critical-badge-dash');
            if (critBadgeDash) {
                if (criticalCount > 0) {
                    critBadgeDash.innerText = criticalCount;
                    critBadgeDash.classList.remove('hidden');
                    critBadgeDash.setAttribute('aria-label', `${criticalCount} critical alerts`);
                } else {
                    critBadgeDash.classList.add('hidden');
                }
            }
            
            // Log badge
            const logBadge = document.getElementById('log-badge');
            if (logBadge) {
                if (unreadLogs > 0) {
                    logBadge.innerText = unreadLogs > 99 ? '99+' : unreadLogs;
                    logBadge.classList.remove('hidden');
                    logBadge.setAttribute('aria-label', `${unreadLogs} unread logs`);
                } else {
                    logBadge.classList.add('hidden');
                }
            }
        }


        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // APP INITIALIZATION (v3.2 â€” Auth à¸–à¸¹à¸à¸¥à¸šà¸­à¸­à¸, à¸ˆà¸°à¸¢à¹‰à¸²à¸¢à¹„à¸› index.html à¹ƒà¸™ Phase D)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // handleLogin() â€” à¸¥à¸šà¸­à¸­à¸à¹ƒà¸™ v3.2
        // logout() â€” à¸¥à¸šà¸­à¸­à¸à¹ƒà¸™ v3.2

        function showApp() {
            initAudio();
            
            // v3.2: à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸‹à¹ˆà¸­à¸™/à¹à¸ªà¸”à¸‡ login-page à¹à¸¥à¹‰à¸§ (à¸–à¸¹à¸à¸¥à¸šà¸­à¸­à¸)
            // app-main à¹à¸¥à¸° bottom-nav à¹à¸ªà¸”à¸‡à¸•à¸±à¹‰à¸‡à¹à¸•à¹ˆà¸•à¹‰à¸™à¸œà¹ˆà¸²à¸™ HTML class
            
            // Show loading skeleton first
            showLoadingSkeleton();
            
            // Simulate loading delay then render
            setTimeout(() => {
                hideLoadingSkeleton();
                renderList();
            }, 500);
            
            if (loopInterval) clearInterval(loopInterval);
            loopInterval = setInterval(mainLoop, 3000); // v3.2: UI refresh à¸—à¸¸à¸ 3 à¸§à¸´à¸™à¸²à¸—à¸µ (à¹€à¸”à¸´à¸¡ 1s)
        }
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // LOADING SKELETON
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function showLoadingSkeleton() {
            document.getElementById('loading-skeleton')?.classList.remove('hidden');
            document.getElementById('device-grid')?.classList.add('hidden');
        }
        
        function hideLoadingSkeleton() {
            document.getElementById('loading-skeleton')?.classList.add('hidden');
            document.getElementById('device-grid')?.classList.remove('hidden');
        }
        
        function showLogSkeleton() {
            document.getElementById('log-skeleton')?.classList.remove('hidden');
            document.getElementById('log-list')?.classList.add('hidden');
        }
        
        function hideLogSkeleton() {
            document.getElementById('log-skeleton')?.classList.add('hidden');
            document.getElementById('log-list')?.classList.remove('hidden');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // MAIN SIMULATION LOOP
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // v3.3.1: Helper function â€” à¸«à¸²à¸›à¸£à¸°à¹€à¸ à¸— Warning (power/battery/signal/humidity)
        // v3.4.0: à¹€à¸à¸´à¹ˆà¸¡ humidity warning
        // à¹ƒà¸Šà¹‰à¹ƒà¸™ renderList() à¹à¸¥à¸° renderDetail()
        function getWarningType(dev) {
            // Priority: power > battery > signal > humidity
            if (dev.vin < 4.0) return 'power';
            if (dev.vbat < 3.5) return 'battery';  // v3.3.2: à¸¥à¸š && dev.vin < 4.0
            if (dev.rssi < -85) return 'signal';
            // v3.4.0: Humidity warning (à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸–à¸¶à¸‡ critical)
            const humiMin = dev.humi_min ?? 30;
            const humiMax = dev.humi_max ?? 80;
            if (dev.humi > humiMax && dev.humi <= humiMax + 10) return 'humidity_high';
            if (dev.humi < humiMin && dev.humi >= humiMin - 10) return 'humidity_low';
            return null;
        }
        
        // v3.3.1: Helper function â€” à¸«à¸²à¸—à¸´à¸¨à¸—à¸²à¸‡à¸­à¸¸à¸“à¸«à¸ à¸¹à¸¡à¸´à¸§à¸´à¸à¸¤à¸• (high/low)
        function getCriticalTempType(dev) {
            if (dev.temp > dev.max) return 'high';
            if (dev.temp < dev.min) return 'low';
            return null;
        }
        
        // v3.4.0: Helper function â€” à¸«à¸²à¸—à¸´à¸¨à¸—à¸²à¸‡à¸„à¸§à¸²à¸¡à¸Šà¸·à¹‰à¸™à¸§à¸´à¸à¸¤à¸• (high/low)
        function getCriticalHumiType(dev) {
            const humiMin = dev.humi_min ?? 30;
            const humiMax = dev.humi_max ?? 80;
            if (dev.humi > humiMax + 10) return 'high';
            if (dev.humi < humiMin - 10) return 'low';
            return null;
        }
        
        // v3.3.2: Helper function â€” à¸«à¸²à¸›à¸£à¸°à¹€à¸ à¸— Critical (temp/battery/signal/humidity)
        // v3.4.0: à¹€à¸à¸´à¹ˆà¸¡ humidity critical
        function getCriticalType(dev) {
            // Priority: temp > humidity > battery > signal
            if (dev.temp > dev.max || dev.temp < dev.min) return 'temp';
            // v3.4.0: Humidity critical
            const humiMin = dev.humi_min ?? 30;
            const humiMax = dev.humi_max ?? 80;
            if (dev.humi > humiMax + 10 || dev.humi < humiMin - 10) return 'humidity';
            if (dev.vbat < 3.3) return 'battery';
            if (dev.rssi < -95) return 'signal';
            return null;
        }
        
        // v3.3.1: Warning Type Configuration
        // v3.4.0: à¹€à¸à¸´à¹ˆà¸¡ humidity_high, humidity_low
        const WARNING_CONFIG = {
            power: {
                badge: 'NO POWER',
                badgeClass: 'bg-yellow-500',
                icon: 'fa-plug-circle-xmark',
                iconClass: 'bg-yellow-100 dark:bg-yellow-500/20 text-yellow-600 dark:text-yellow-400',
                statusText: 'NO POWER',
                statusClass: 'text-yellow-600 dark:text-yellow-400',
                dotClass: 'bg-yellow-500'
            },
            battery: {
                badge: 'LOW BATTERY',
                badgeClass: 'bg-orange-500',
                icon: 'fa-battery-quarter',
                iconClass: 'bg-orange-100 dark:bg-orange-500/20 text-orange-600 dark:text-orange-400',
                statusText: 'LOW BATTERY',
                statusClass: 'text-orange-600 dark:text-orange-400',
                dotClass: 'bg-orange-500'
            },
            signal: {
                badge: 'WEAK SIGNAL',
                badgeClass: 'bg-indigo-500',
                icon: 'fa-signal',
                iconClass: 'bg-indigo-100 dark:bg-indigo-500/20 text-indigo-600 dark:text-indigo-400',
                statusText: 'WEAK SIGNAL',
                statusClass: 'text-indigo-600 dark:text-indigo-400',
                dotClass: 'bg-indigo-500'
            },
            // v3.4.0: Humidity warnings
            humidity_high: {
                badge: 'HUMID HIGH',
                badgeClass: 'bg-cyan-500',
                icon: 'fa-droplet',
                iconClass: 'bg-cyan-100 dark:bg-cyan-500/20 text-cyan-600 dark:text-cyan-400',
                statusText: 'HUMID HIGH',
                statusClass: 'text-cyan-600 dark:text-cyan-400',
                dotClass: 'bg-cyan-500'
            },
            humidity_low: {
                badge: 'HUMID LOW',
                badgeClass: 'bg-amber-500',
                icon: 'fa-droplet-slash',
                iconClass: 'bg-amber-100 dark:bg-amber-500/20 text-amber-600 dark:text-amber-400',
                statusText: 'HUMID LOW',
                statusClass: 'text-amber-600 dark:text-amber-400',
                dotClass: 'bg-amber-500'
            }
        };
        
        // v3.3.2: Critical Type Configuration
        // v3.4.0: à¹€à¸à¸´à¹ˆà¸¡ humidity_high, humidity_low
        const CRITICAL_CONFIG = {
            temp_high: {
                badge: 'TEMP HIGH',
                icon: 'fa-temperature-arrow-up'
            },
            temp_low: {
                badge: 'TEMP LOW',
                icon: 'fa-temperature-arrow-down'
            },
            battery: {
                badge: 'BATT CRITICAL',
                icon: 'fa-battery-empty'
            },
            signal: {
                badge: 'NO SIGNAL',
                icon: 'fa-signal'  // à¸ˆà¸°à¹ƒà¸Šà¹‰ icon-signal-off class à¹€à¸à¸´à¹ˆà¸¡
            },
            // v3.4.0: Humidity critical
            humidity_high: {
                badge: 'WET CRITICAL',
                icon: 'fa-droplet'
            },
            humidity_low: {
                badge: 'DRY CRITICAL',
                icon: 'fa-droplet-slash'
            }
        };
        
        function mainLoop() {
            let anyAlert = false;
            const now = Date.now();

            devices.forEach(dev => {
                prevTempValues[dev.id] = dev.temp;
                
                // v3.2.2: à¹ƒà¸Šà¹‰ simTargetId à¹à¸—à¸™ selectedId à¹€à¸à¸·à¹ˆà¸­à¹ƒà¸«à¹‰ sim à¸„à¹‰à¸²à¸‡à¸­à¸¢à¸¹à¹ˆà¹à¸¡à¹‰à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸«à¸™à¹‰à¸²
                if (simEvent === 'offline' && dev.id === simTargetId) {
                    // Don't update
                } else {
                    dev.lastUpdate = now;
                    dev.lastSeen = new Date().toLocaleString('th-TH');
                }

                if (simEvent === 'ac_off' && dev.id === simTargetId) {
                    dev.vin = 0.0;
                    dev.vbat = Math.max(3.0, dev.vbat - 0.01);
                    dev.ibat = -0.45;
                } else if (simEvent === 'batt_low' && dev.id === simTargetId) {
                    // v3.3.2: Battery Low â€” à¹à¸„à¹ˆà¸¥à¸” vbat (à¹„à¸¡à¹ˆà¸•à¸±à¹‰à¸‡ vin=0)
                    // à¹ƒà¸Šà¹‰à¸ˆà¸³à¸¥à¸­à¸‡à¸à¸£à¸“à¸µà¹à¸šà¸•à¹€à¸ªà¸·à¹ˆà¸­à¸¡/à¸Šà¸²à¸£à¹Œà¸ˆà¹„à¸¡à¹ˆà¹€à¸‚à¹‰à¸² (vin à¸¢à¸±à¸‡à¸›à¸à¸•à¸´)
                    dev.vbat = Math.max(3.0, dev.vbat - 0.05);
                    dev.ibat = -0.1;
                } else if (simEvent === 'rssi_low' && dev.id === simTargetId) {
                    // v3.2.3: Weak Signal â€” rssi à¸¥à¸”à¸¥à¸‡à¸ˆà¸™à¸–à¸¶à¸‡ -95dBm (critical threshold)
                    dev.rssi = -95;
                } else if (simEvent === 'temp_high' && dev.id === simTargetId) {
                    dev.temp += 0.8;
                } else if (simEvent === 'temp_low' && dev.id === simTargetId) {
                    // v3.2.2: Temp Low â€” à¸•à¸£à¸‡à¸‚à¹‰à¸²à¸¡ temp_high
                    dev.temp -= 0.8;
                } else if (simEvent === 'humi_high' && dev.id === simTargetId) {
                    // v3.4.0: Humidity High â€” à¹€à¸à¸´à¹ˆà¸¡à¸„à¸§à¸²à¸¡à¸Šà¸·à¹‰à¸™à¸ˆà¸™à¹€à¸à¸´à¸™ max + 10 (critical)
                    const humiMax = dev.humi_max ?? 80;
                    dev.humi = Math.min(99, dev.humi + 2);
                } else if (simEvent === 'humi_low' && dev.id === simTargetId) {
                    // v3.4.0: Humidity Low â€” à¸¥à¸”à¸„à¸§à¸²à¸¡à¸Šà¸·à¹‰à¸™à¸ˆà¸™à¸•à¹ˆà¸³à¸à¸§à¹ˆà¸² min - 10 (critical)
                    const humiMin = dev.humi_min ?? 30;
                    dev.humi = Math.max(5, dev.humi - 2);
                } else if (simEvent === 'reset') {
                    dev.vin = 5.1;
                    dev.vbat = 4.1;
                    dev.rssi = -70;
                    dev.temp = (dev.min + dev.max) / 2;
                    dev.humi = 50;  // v3.4.0: reset humidity à¸”à¹‰à¸§à¸¢
                    dev.ack = false;
                    dev.status = 'normal';
                } else {
                    dev.vin = 5.0 + Math.random() * 0.2;
                    if (dev.vbat < 4.1) {
                        dev.vbat = Math.min(4.2, dev.vbat + 0.02);
                        dev.ibat = 0.5;
                    } else {
                        dev.ibat = 0.0;
                    }
                    dev.rssi = -65 + Math.floor(Math.random() * 10 - 5);
                    const target = (dev.min + dev.max) / 2;
                    dev.temp += (target - dev.temp) * 0.05 + (Math.random() - 0.5) * 0.3;
                    dev.humi += (Math.random() - 0.5) * 0.5;
                    dev.humi = Math.max(20, Math.min(90, dev.humi));
                }

                const isOffline = (now - dev.lastUpdate) > OFFLINE_THRESHOLD;
                
                // â”€â”€ v3.2.3: à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š sub-status à¹à¸¢à¸à¹à¸•à¹ˆà¸¥à¸°à¸›à¸£à¸°à¹€à¸ à¸— â”€â”€
                const tempStatus = (dev.temp > dev.max || dev.temp < dev.min) ? 'critical' : 'normal';
                const powerStatus = dev.vin < 4.0 ? 'off' : 'normal';
                
                // v3.3.2: Battery â€” à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¹€à¸Šà¹‡à¸„ vin (à¹à¸šà¸•à¸•à¹ˆà¸³à¹„à¸”à¹‰à¹à¸¡à¹‰à¹„à¸Ÿà¸¢à¸±à¸‡à¸¡à¸² à¹€à¸Šà¹ˆà¸™ à¹à¸šà¸•à¹€à¸ªà¸·à¹ˆà¸­à¸¡)
                // critical < 3.3V, low < 3.5V
                const batteryStatus = dev.vbat < 3.3 ? 'critical' : 
                                      dev.vbat < 3.5 ? 'low' : 'normal';
                
                // Signal: critical < -95dBm, weak < -85dBm
                const signalStatus = dev.rssi < -95 ? 'critical' :
                                     dev.rssi < -85 ? 'weak' : 'normal';
                
                // v3.4.0: Humidity status
                // critical: humi < humi_min - 10 à¸«à¸£à¸·à¸­ > humi_max + 10
                // warning: humi < humi_min à¸«à¸£à¸·à¸­ > humi_max (à¹à¸•à¹ˆà¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸–à¸¶à¸‡ critical)
                const humiMin = dev.humi_min ?? 30;
                const humiMax = dev.humi_max ?? 80;
                let humiStatus = 'normal';
                if (dev.humi < humiMin - 10 || dev.humi > humiMax + 10) {
                    humiStatus = 'critical';
                } else if (dev.humi < humiMin || dev.humi > humiMax) {
                    humiStatus = 'warning';
                }
                
                // â”€â”€ v3.2.3: à¸à¸³à¸«à¸™à¸” overall status à¸•à¸²à¸¡ priority â”€â”€
                // v3.4.0: à¹€à¸à¸´à¹ˆà¸¡ humidity à¹ƒà¸™ critical/warning check
                // Priority: offline > critical (temp/humidity/battery/signal) > warning (power/battery_low/signal_weak/humidity) > normal
                if (isOffline) {
                    dev.status = 'offline';
                } else if (tempStatus === 'critical' || humiStatus === 'critical' || batteryStatus === 'critical' || signalStatus === 'critical') {
                    dev.status = 'critical';
                    if (!dev.ack) {
                        anyAlert = true;
                    }
                } else if (powerStatus === 'off' || batteryStatus === 'low' || signalStatus === 'weak' || humiStatus === 'warning') {
                    dev.status = 'warning';
                } else {
                    dev.status = 'normal';
                    dev.ack = false;
                }
                
                // â”€â”€ v3.2.3: State Transition Logs â€” à¹à¸¢à¸à¸•à¸²à¸¡ sub-status â”€â”€
                
                // 1. Temperature Status
                const prevTemp = prevTempStatus[dev.id] || 'normal';
                if (!isOffline && prevTemp !== tempStatus) {
                    if (tempStatus === 'critical' && !dev.ack) {
                        const direction = dev.temp > dev.max ? 'ğŸ”¥ à¸ªà¸¹à¸‡à¹€à¸à¸´à¸™à¹„à¸›' : 'â„ï¸ à¸•à¹ˆà¸³à¹€à¸à¸´à¸™à¹„à¸›';
                        addLog(dev.name, `${direction}: ${dev.temp.toFixed(1)}Â°C (Limit: ${dev.min}~${dev.max}Â°C)`, 'crit');
                    } else if (tempStatus === 'normal' && prevTemp === 'critical') {
                        addLog(dev.name, 'âœ… à¸­à¸¸à¸“à¸«à¸ à¸¹à¸¡à¸´à¸à¸¥à¸±à¸šà¸ªà¸¹à¹ˆà¸›à¸à¸•à¸´', 'info');
                    }
                    prevTempStatus[dev.id] = tempStatus;
                }
                
                // 2. Power Status
                const prevPower = prevPowerStatus[dev.id] || 'normal';
                if (!isOffline && prevPower !== powerStatus) {
                    if (powerStatus === 'off') {
                        addLog(dev.name, 'âš¡ à¹„à¸Ÿà¸Ÿà¹‰à¸²à¸”à¸±à¸š - à¹ƒà¸Šà¹‰à¹à¸šà¸•à¹€à¸•à¸­à¸£à¸µà¹ˆ', 'warn');
                    } else if (powerStatus === 'normal' && prevPower === 'off') {
                        addLog(dev.name, 'âœ… à¹„à¸Ÿà¸Ÿà¹‰à¸²à¸à¸¥à¸±à¸šà¸¡à¸²à¹à¸¥à¹‰à¸§', 'info');
                    }
                    prevPowerStatus[dev.id] = powerStatus;
                }
                
                // 3. Battery Status (v3.2.3 â€” Hardware Warning)
                const prevBatt = prevBatteryStatus[dev.id] || 'normal';
                if (!isOffline && prevBatt !== batteryStatus) {
                    if (batteryStatus === 'critical') {
                        addLog(dev.name, `ğŸ”‹ à¹à¸šà¸•à¹€à¸•à¸­à¸£à¸µà¹ˆà¸§à¸´à¸à¸¤à¸•: ${dev.vbat.toFixed(2)}V`, 'crit');
                    } else if (batteryStatus === 'low') {
                        addLog(dev.name, `ğŸ”‹ à¹à¸šà¸•à¹€à¸•à¸­à¸£à¸µà¹ˆà¸•à¹ˆà¸³: ${dev.vbat.toFixed(2)}V`, 'warn');
                    } else if (prevBatt !== 'normal' && batteryStatus === 'normal') {
                        addLog(dev.name, 'âœ… à¹à¸šà¸•à¹€à¸•à¸­à¸£à¸µà¹ˆà¸à¸¥à¸±à¸šà¸ªà¸¹à¹ˆà¸›à¸à¸•à¸´', 'info');
                    }
                    prevBatteryStatus[dev.id] = batteryStatus;
                }
                
                // 4. Signal Status (v3.2.3 â€” Hardware Warning)
                const prevSig = prevSignalStatus[dev.id] || 'normal';
                if (!isOffline && prevSig !== signalStatus) {
                    if (signalStatus === 'critical') {
                        addLog(dev.name, `ğŸ“¶ à¸ªà¸±à¸à¸à¸²à¸“à¸§à¸´à¸à¸¤à¸•: ${dev.rssi}dBm`, 'crit');
                    } else if (signalStatus === 'weak') {
                        addLog(dev.name, `ğŸ“¶ à¸ªà¸±à¸à¸à¸²à¸“à¸­à¹ˆà¸­à¸™: ${dev.rssi}dBm`, 'warn');
                    } else if (prevSig !== 'normal' && signalStatus === 'normal') {
                        addLog(dev.name, 'âœ… à¸ªà¸±à¸à¸à¸²à¸“à¸à¸¥à¸±à¸šà¸ªà¸¹à¹ˆà¸›à¸à¸•à¸´', 'info');
                    }
                    prevSignalStatus[dev.id] = signalStatus;
                }
                
                // 5. Humidity Status (v3.4.0 â€” Humidity Warning/Critical)
                const prevHumi = prevHumiStatus[dev.id] || 'normal';
                if (!isOffline && prevHumi !== humiStatus) {
                    if (humiStatus === 'critical') {
                        const direction = dev.humi > humiMax + 10 ? 'ğŸ’§ à¸„à¸§à¸²à¸¡à¸Šà¸·à¹‰à¸™à¸ªà¸¹à¸‡à¸§à¸´à¸à¸¤à¸•' : 'ğŸœï¸ à¸„à¸§à¸²à¸¡à¸Šà¸·à¹‰à¸™à¸•à¹ˆà¸³à¸§à¸´à¸à¸¤à¸•';
                        addLog(dev.name, `${direction}: ${dev.humi.toFixed(1)}% (Limit: ${humiMin}~${humiMax}%)`, 'crit');
                    } else if (humiStatus === 'warning') {
                        const direction = dev.humi > humiMax ? 'ğŸ’§ à¸„à¸§à¸²à¸¡à¸Šà¸·à¹‰à¸™à¸ªà¸¹à¸‡à¹€à¸à¸´à¸™à¹„à¸›' : 'ğŸœï¸ à¸„à¸§à¸²à¸¡à¸Šà¸·à¹‰à¸™à¸•à¹ˆà¸³à¹€à¸à¸´à¸™à¹„à¸›';
                        addLog(dev.name, `${direction}: ${dev.humi.toFixed(1)}% (Limit: ${humiMin}~${humiMax}%)`, 'warn');
                    } else if (prevHumi !== 'normal' && humiStatus === 'normal') {
                        addLog(dev.name, 'âœ… à¸„à¸§à¸²à¸¡à¸Šà¸·à¹‰à¸™à¸à¸¥à¸±à¸šà¸ªà¸¹à¹ˆà¸›à¸à¸•à¸´', 'info');
                    }
                    prevHumiStatus[dev.id] = humiStatus;
                }
                
                // 6. Offline Status
                const prevStatus = prevStatuses[dev.id] || 'normal';
                const newStatus = dev.status;
                if (prevStatus !== newStatus) {
                    if (newStatus === 'offline') {
                        addLog(dev.name, 'ğŸ“¡ à¸‚à¸²à¸”à¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­', 'warn');
                    }
                    if (newStatus !== 'offline' && prevStatus === 'offline') {
                        addLog(dev.name, 'âœ… à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸à¸¥à¸±à¸šà¸¡à¸²à¹à¸¥à¹‰à¸§', 'info');
                    }
                }
                prevStatuses[dev.id] = newStatus;

                // â”€â”€ v3.2: History Push à¸•à¸²à¸¡ Sampling Rate â”€â”€
                // UI refresh: à¸—à¸¸à¸ 3 à¸§à¸´à¸™à¸²à¸—à¸µ (1 tick = 3s)
                // history (1H):  à¸—à¸¸à¸ 1 à¸™à¸²à¸—à¸µ  = 20 ticks  â†’ à¹€à¸à¹‡à¸š 60 records
                // history24h:    à¸—à¸¸à¸ 5 à¸™à¸²à¸—à¸µ  = 100 ticks â†’ à¹€à¸à¹‡à¸š 288 records
                // history7d:     à¸—à¸¸à¸ 30 à¸™à¸²à¸—à¸µ = 600 ticks â†’ à¹€à¸à¹‡à¸š 336 records
                const timeLabel = new Date().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                
                if (historyTick % 20 === 0) {
                    dev.history.push({ t: timeLabel, v: dev.temp, h: dev.humi });
                    if (dev.history.length > MAX_HISTORY) dev.history.shift();
                }
                
                if (historyTick % 100 === 0) {
                    if (dev.history24h) {
                        dev.history24h.push({ t: timeLabel, v: dev.temp, h: dev.humi });
                        if (dev.history24h.length > MAX_HISTORY_24H) dev.history24h.shift();
                    }
                }
                
                if (historyTick % 600 === 0) {
                    if (dev.history7d) {
                        dev.history7d.push({ t: timeLabel, v: dev.temp, h: dev.humi });
                        if (dev.history7d.length > MAX_HISTORY_7D) dev.history7d.shift();
                    }
                }
            });

            if (simEvent === 'reset') simEvent = null;
            if (anyAlert) playAlert();
            
            // v3.2: à¹€à¸à¸´à¹ˆà¸¡ tick counter à¸«à¸¥à¸±à¸‡à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥à¸—à¸¸à¸ device à¹€à¸ªà¸£à¹‡à¸ˆ
            historyTick++;

            updateAmbientGlow();
            updateBadges();
            updateConnectionStatus();

            if (selectedId) {
                renderDetail();
            } else if (!document.getElementById('view-dashboard').classList.contains('hidden')) {
                renderList();
            }

            // v3.2 Task #7: throttle save à¸—à¸¸à¸ 10 à¸§à¸´à¸™à¸²à¸—à¸µ (à¹à¸—à¸™ random 10%)
            throttledSave();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // RENDER FUNCTIONS (Optimized Performance)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function renderList() {
            const grid = document.getElementById('device-grid');
            const emptyState = document.getElementById('empty-state');
            const searchTerm = document.getElementById('search-box')?.value.toLowerCase() || '';
            
            let filtered = devices.filter(d => {
                const matchSearch = d.name.toLowerCase().includes(searchTerm) || 
                                   (d.hw_id && d.hw_id.toLowerCase().includes(searchTerm));
                const isOffline = (Date.now() - d.lastUpdate) > OFFLINE_THRESHOLD;
                
                let matchFilter = true;
                if (filterType === 'critical') matchFilter = d.status === 'critical';
                if (filterType === 'offline') matchFilter = isOffline;
                if (filterType === 'normal') matchFilter = d.status === 'normal' && !isOffline;
                
                return matchSearch && matchFilter;
            });

            filtered.sort((a, b) => {
                const score = (d) => {
                    if (d.status === 'critical' && !d.ack) return 4;
                    if (d.status === 'critical' && d.ack) return 3;
                    if ((Date.now() - d.lastUpdate) > OFFLINE_THRESHOLD) return 2;
                    if (d.status === 'warning') return 1;
                    return 0;
                };
                return score(b) - score(a);
            });

            if (filtered.length === 0) {
                grid.innerHTML = '';
                grid.classList.add('hidden');
                emptyState?.classList.remove('hidden');
                prevDashboardHash = ''; // v3.2: reset hash
                return;
            }
            
            grid.classList.remove('hidden');
            emptyState?.classList.add('hidden');
            
            // v3.2 Task #6: skip render à¸–à¹‰à¸²à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸¡à¹ˆà¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™
            const currentHash = getDashboardHash(filtered);
            if (currentHash === prevDashboardHash) return;
            prevDashboardHash = currentHash;
            
            // PERFORMANCE FIX: Build HTML string first, then assign once
            const htmlParts = [];

            filtered.forEach(dev => {
                const isOffline = (Date.now() - dev.lastUpdate) > OFFLINE_THRESHOLD;
                const isCritical = dev.status === 'critical';
                const isWarning = dev.status === 'warning';
                
                let cardClass = 'card-normal';
                if (isCritical && !dev.ack) cardClass = 'card-critical';
                else if (isCritical && dev.ack) cardClass = 'card-warning';
                else if (isOffline) cardClass = 'card-offline';
                else if (isWarning) cardClass = 'card-warning';
                
                let iconClass = 'bg-emerald-100 dark:bg-emerald-500/20 text-emerald-600 dark:text-emerald-400';
                let iconName = 'fa-temperature-low';
                
                // v3.3.2: à¹à¸¢à¸ Icon à¸•à¸²à¸¡à¸›à¸£à¸°à¹€à¸ à¸— (Critical à¹à¸¢à¸à¸¢à¹ˆà¸­à¸¢ temp/humidity/battery/signal)
                // v3.4.0: à¹€à¸à¸´à¹ˆà¸¡ humidity critical
                if (isCritical && !dev.ack) {
                    iconClass = 'bg-red-100 dark:bg-red-500/20 text-red-600 dark:text-red-400 animate-pulse';
                    // v3.4.0: à¹€à¸¥à¸·à¸­à¸ icon à¸•à¸²à¸¡à¸›à¸£à¸°à¹€à¸ à¸— critical (à¸£à¸§à¸¡ humidity)
                    const critType = getCriticalType(dev);
                    if (critType === 'temp') {
                        const tempDir = getCriticalTempType(dev);
                        iconName = tempDir === 'low' ? 'fa-temperature-arrow-down' : 'fa-temperature-arrow-up';
                    } else if (critType === 'humidity') {
                        const humiDir = getCriticalHumiType(dev);
                        iconName = humiDir === 'low' ? 'fa-droplet-slash' : 'fa-droplet';
                    } else if (critType === 'battery') {
                        iconName = 'fa-battery-empty';
                    } else if (critType === 'signal') {
                        iconName = 'fa-signal';
                    } else {
                        iconName = 'fa-triangle-exclamation';
                    }
                } else if (dev.ack) {
                    iconClass = 'bg-amber-100 dark:bg-amber-500/20 text-amber-600 dark:text-amber-400';
                    iconName = 'fa-bell-slash';
                } else if (isWarning) {
                    // v3.3.1: à¹€à¸¥à¸·à¸­à¸ icon à¸•à¸²à¸¡à¸›à¸£à¸°à¹€à¸ à¸— warning (power/battery/signal)
                    const warnType = getWarningType(dev);
                    if (warnType && WARNING_CONFIG[warnType]) {
                        iconClass = WARNING_CONFIG[warnType].iconClass;
                        iconName = WARNING_CONFIG[warnType].icon;
                    } else {
                        // fallback
                        iconClass = 'bg-yellow-100 dark:bg-yellow-500/20 text-yellow-600 dark:text-yellow-400';
                        iconName = 'fa-triangle-exclamation';
                    }
                } else if (isOffline) {
                    iconClass = 'bg-slate-200 dark:bg-slate-600/30 text-slate-500 dark:text-slate-400';
                    iconName = 'fa-wifi icon-wifi-off';
                }
                
                let statusBadge = '';
                if (isCritical && !dev.ack) {
                    // v3.4.0: Badge à¸•à¸²à¸¡à¸›à¸£à¸°à¹€à¸ à¸— critical (à¸£à¸§à¸¡ humidity)
                    const critType = getCriticalType(dev);
                    let badgeText = 'CRITICAL';
                    if (critType === 'temp') {
                        const tempDir = getCriticalTempType(dev);
                        badgeText = tempDir === 'low' ? 'TEMP LOW' : 'TEMP HIGH';
                    } else if (critType === 'humidity') {
                        const humiDir = getCriticalHumiType(dev);
                        badgeText = humiDir === 'low' ? 'DRY CRITICAL' : 'WET CRITICAL';
                    } else if (critType === 'battery') {
                        badgeText = 'BATT CRITICAL';
                    } else if (critType === 'signal') {
                        badgeText = 'NO SIGNAL';
                    }
                    statusBadge = `<span class="absolute top-2 right-2 px-2 py-0.5 text-[10px] font-semibold rounded-full bg-red-500 text-white animate-pulse" role="status">${badgeText}</span>`;
                } else if (dev.ack) {
                    statusBadge = `<span class="absolute top-2 right-2 px-2 py-0.5 text-[10px] font-semibold rounded-full bg-amber-500 text-white" role="status">MUTED</span>`;
                } else if (isWarning) {
                    // v3.3.1: Badge à¸•à¸²à¸¡à¸›à¸£à¸°à¹€à¸ à¸— warning (power/battery/signal)
                    const warnType = getWarningType(dev);
                    if (warnType && WARNING_CONFIG[warnType]) {
                        const cfg = WARNING_CONFIG[warnType];
                        statusBadge = `<span class="absolute top-2 right-2 px-2 py-0.5 text-[10px] font-semibold rounded-full ${cfg.badgeClass} text-white" role="status">${cfg.badge}</span>`;
                    } else {
                        statusBadge = `<span class="absolute top-2 right-2 px-2 py-0.5 text-[10px] font-semibold rounded-full bg-yellow-500 text-white" role="status">WARNING</span>`;
                    }
                }

                let offlineOverlay = '';
                if (isOffline) {
                    offlineOverlay = `
                        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                            <span class="bg-slate-600 text-white text-xs font-semibold px-4 py-1.5 rounded-full shadow-lg offline-badge">
                                <i class="fa-solid fa-wifi icon-wifi-off mr-1" aria-hidden="true"></i> OFFLINE
                            </span>
                        </div>`;
                }
                
                // v3.4.0: à¸„à¸³à¸™à¸§à¸“à¸ªà¸µ Humidity à¸•à¸²à¸¡ status
                // v3.4.0 Fix: respect offline/ack à¹€à¸«à¸¡à¸·à¸­à¸™ Temperature
                const humiMin = dev.humi_min ?? 30;
                const humiMax = dev.humi_max ?? 80;
                let humiColorClass = 'text-blue-500';  // Normal
                if (isOffline) {
                    humiColorClass = 'text-slate-500'; // Offline - à¹€à¸—à¸²
                } else if (isCritical && dev.ack) {
                    humiColorClass = 'text-amber-500'; // Acknowledged - à¸ªà¹‰à¸¡
                } else if (dev.humi < humiMin - 10 || dev.humi > humiMax + 10) {
                    humiColorClass = 'text-red-500';   // Critical
                } else if (dev.humi < humiMin) {
                    humiColorClass = 'text-amber-500'; // Warning Low
                } else if (dev.humi > humiMax) {
                    humiColorClass = 'text-cyan-500';  // Warning High
                }

                htmlParts.push(`
                    <div class="relative device-card" role="listitem">
                        ${statusBadge}
                        <div onclick="${isOffline ? "window.Toast.fire({icon:'warning',title:'à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¹„à¸”à¹‰'})" : `selectDevice('${dev.id}')`}" 
                             class="${isOffline ? 'device-offline' : ''} ${cardClass} rounded-2xl p-4 border-2 cursor-pointer transition-all"
                             role="button"
                             tabindex="0"
                             aria-label="${sanitizeHTML(dev.name)}, ${dev.temp.toFixed(1)} degrees, ${dev.status}"
                             onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();${isOffline ? "window.Toast.fire({icon:'warning',title:'à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¹„à¸”à¹‰'})" : `selectDevice('${dev.id}')`}}">
                            <div class="flex items-start gap-3">
                                <div class="w-12 h-12 rounded-xl ${iconClass} flex items-center justify-center shrink-0">
                                    <i class="fa-solid ${iconName} text-xl" aria-hidden="true"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h4 class="font-semibold text-slate-800 dark:text-white text-sm truncate">${sanitizeHTML(dev.name)}</h4>
                                    <p class="text-xs text-slate-500 dark:text-slate-400 font-mono truncate">${sanitizeHTML(dev.hw_id || 'No HW ID')}</p>
                                    <div class="flex items-baseline gap-3 mt-2">
                                        <!-- v3.3.3: à¸ªà¸µ Temperature à¸•à¸²à¸¡à¸ªà¸–à¸²à¸™à¸° â€” à¸•à¸£à¸‡à¸à¸±à¸š Detail View -->
                                        <span class="text-2xl font-bold font-mono ${
                                            isCritical && dev.ack ? 'text-amber-500' : 
                                            isCritical ? 'text-red-500' : 
                                            isOffline ? 'text-slate-500' :
                                            isWarning ? 'text-yellow-500' :
                                            'text-emerald-600 dark:text-emerald-400'
                                        }">${dev.temp.toFixed(1)}Â°</span>
                                        <!-- v3.4.0: Humidity à¸ªà¸µà¸•à¸²à¸¡ status -->
                                        <span class="text-xs ${humiColorClass} font-medium"><i class="fa-solid fa-droplet mr-0.5" aria-hidden="true"></i>${dev.humi.toFixed(1)}%</span>
                                    </div>
                                    <div class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                                        Limit: ${dev.min}Â° ~ ${dev.max}Â°C
                                    </div>
                                </div>
                            </div>
                        </div>
                        ${offlineOverlay}
                    </div>
                `);
            });
            
            grid.innerHTML = htmlParts.join('');
        }

        function renderDetail() {
            const dev = getDeviceById(selectedId); // v3.3: O(1) lookup
            if (!dev) return;

            const isCritical = dev.status === 'critical';
            const isOffline = dev.status === 'offline';
            const isWarning = dev.status === 'warning';
            const isDark = document.documentElement.classList.contains('dark');
            
            // v3.2 Task #6: helper â€” à¸­à¸±à¸à¹€à¸”à¸• DOM à¹€à¸‰à¸à¸²à¸°à¹€à¸¡à¸·à¹ˆà¸­à¸„à¹ˆà¸²à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™
            const C = prevDetailCache;
            function updateText(id, val) {
                if (C[id] !== val) {
                    C[id] = val;
                    const el = document.getElementById(id);
                    if (el) el.innerText = val;
                }
            }
            function updateHTML(id, val) {
                if (C[id] !== val) {
                    C[id] = val;
                    const el = document.getElementById(id);
                    if (el) el.innerHTML = val;
                }
            }
            
            updateText('detail-device-name', dev.name);
            updateText('detail-hw-id', `HW: ${dev.hw_id || 'N/A'}`);
            
            // v3.3 R6: à¸à¸³à¸«à¸™à¸”à¸ªà¸µà¸•à¸±à¸§à¹€à¸¥à¸‚ Temperature à¸•à¸²à¸¡à¸ªà¸–à¸²à¸™à¸°
            let tempColorClass;
            if (isCritical && !dev.ack) {
                tempColorClass = 'text-red-500';           // Critical - à¹à¸”à¸‡
            } else if (isCritical && dev.ack) {
                tempColorClass = 'text-amber-500';         // Acknowledged - à¸ªà¹‰à¸¡
            } else if (isOffline) {
                tempColorClass = 'text-slate-500';         // Offline - à¹€à¸—à¸²
            } else if (isWarning) {
                tempColorClass = 'text-yellow-500';        // Warning - à¹€à¸«à¸¥à¸·à¸­à¸‡
            } else {
                tempColorClass = 'text-emerald-500';       // Normal - à¹€à¸‚à¸µà¸¢à¸§
            }
            
            const tempEl = document.getElementById('detail-temp');
            const prevTemp = prevTempValues[dev.id] || dev.temp;
            if (Math.abs(prevTemp - dev.temp) > 0.1) {
                tempEl.classList.add('changing');
                setTimeout(() => tempEl.classList.remove('changing'), 300);
            }
            
            // v3.3 R7: à¸«à¸™à¹ˆà¸§à¸¢ Â°C à¹ƒà¸Šà¹‰à¸ªà¸µà¹€à¸”à¸µà¸¢à¸§à¸à¸±à¸šà¸•à¸±à¸§à¹€à¸¥à¸‚ + opacity-60
            updateHTML('detail-temp', `<span class="${tempColorClass}">${dev.temp.toFixed(1)}</span><span class="text-xl ml-1 opacity-60 ${tempColorClass}">Â°C</span>`);
            
            // v3.4.0: Humidity à¸ªà¸µà¸•à¸²à¸¡ status
            // v3.4.0 Fix: respect offline/ack à¹€à¸«à¸¡à¸·à¸­à¸™ Temperature
            const humiMin = dev.humi_min ?? 30;
            const humiMax = dev.humi_max ?? 80;
            let humiColorClass = 'text-blue-500';  // Normal
            if (isOffline) {
                humiColorClass = 'text-slate-500'; // Offline - à¹€à¸—à¸²
            } else if (isCritical && dev.ack) {
                humiColorClass = 'text-amber-500'; // Acknowledged - à¸ªà¹‰à¸¡
            } else if (dev.humi < humiMin - 10 || dev.humi > humiMax + 10) {
                humiColorClass = 'text-red-500';   // Critical
            } else if (dev.humi < humiMin) {
                humiColorClass = 'text-amber-500'; // Warning Low
            } else if (dev.humi > humiMax) {
                humiColorClass = 'text-cyan-500';  // Warning High
            }
            updateHTML('detail-humi', `<span class="${humiColorClass}">${dev.humi.toFixed(1)}</span><span class="text-sm ml-0.5 opacity-70 ${humiColorClass}">%</span>`);
            updateText('display-limit-min', dev.min);
            updateText('display-limit-max', dev.max);
            updateText('detail-last-seen', dev.lastSeen || '--');

            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            const detailCard = document.getElementById('detail-card');
            const btnAck = document.getElementById('btn-ack');

            detailCard.classList.remove('card-normal', 'card-warning', 'card-critical', 'card-offline');
            
            if (isCritical) {
                detailCard.classList.add(dev.ack ? 'card-warning' : 'card-critical');
                // v3.4.0: Status à¸•à¸²à¸¡à¸›à¸£à¸°à¹€à¸ à¸— critical (temp/humidity/battery/signal)
                if (dev.ack) {
                    statusText.innerText = 'ACKNOWLEDGED';
                    statusText.className = 'text-xs font-semibold text-amber-500';
                    statusDot.className = 'w-2.5 h-2.5 rounded-full bg-amber-500';
                } else {
                    const critType = getCriticalType(dev);
                    let criticalText = 'CRITICAL';
                    if (critType === 'temp') {
                        const tempDir = getCriticalTempType(dev);
                        criticalText = tempDir === 'low' ? 'TEMP LOW' : 'TEMP HIGH';
                    } else if (critType === 'humidity') {
                        const humiDir = getCriticalHumiType(dev);
                        criticalText = humiDir === 'low' ? 'DRY CRITICAL' : 'WET CRITICAL';
                    } else if (critType === 'battery') {
                        criticalText = 'BATT CRITICAL';
                    } else if (critType === 'signal') {
                        criticalText = 'NO SIGNAL';
                    }
                    statusText.innerText = criticalText;
                    statusText.className = 'text-xs font-semibold text-red-500';
                    statusDot.className = 'w-2.5 h-2.5 rounded-full bg-red-500 animate-bounce';
                }
                btnAck.classList.toggle('hidden', dev.ack);
            } else if (isOffline) {
                detailCard.classList.add('card-offline');
                statusText.innerText = 'OFFLINE';
                statusText.className = 'text-xs font-semibold text-slate-500 dark:text-slate-400';
                statusDot.className = 'w-2.5 h-2.5 rounded-full bg-slate-500';
                btnAck.classList.add('hidden');
            } else if (isWarning) {
                detailCard.classList.add('card-warning');
                // v3.3.1: Status à¸•à¸²à¸¡à¸›à¸£à¸°à¹€à¸ à¸— warning (power/battery/signal)
                const warnType = getWarningType(dev);
                if (warnType && WARNING_CONFIG[warnType]) {
                    const cfg = WARNING_CONFIG[warnType];
                    statusText.innerText = cfg.statusText;
                    statusText.className = `text-xs font-semibold ${cfg.statusClass}`;
                    statusDot.className = `w-2.5 h-2.5 rounded-full ${cfg.dotClass} animate-pulse`;
                } else {
                    statusText.innerText = 'WARNING';
                    statusText.className = 'text-xs font-semibold text-yellow-600 dark:text-yellow-400';
                    statusDot.className = 'w-2.5 h-2.5 rounded-full bg-yellow-500 animate-pulse';
                }
                btnAck.classList.add('hidden');
            } else {
                detailCard.classList.add('card-normal');
                statusText.innerText = 'Normal';
                statusText.className = 'text-xs font-semibold text-emerald-600 dark:text-emerald-400';
                statusDot.className = 'w-2.5 h-2.5 rounded-full bg-emerald-500 animate-pulse';
                btnAck.classList.add('hidden');
            }

            updateText('val-vin', dev.vin.toFixed(1));
            updateText('val-rssi', dev.rssi);
            updateText('val-update', new Date().toLocaleTimeString('th-TH', { hour12: false }));

            const battPercent = Math.min(100, Math.max(0, ((dev.vbat - 3.0) / 1.2) * 100));
            updateText('val-batt-percent', Math.round(battPercent));
            updateText('val-vbat', dev.vbat.toFixed(2) + 'V');
            updateText('val-ibat', (dev.ibat >= 0 ? '+' : '') + dev.ibat.toFixed(2) + 'A');
            
            const battBar = document.getElementById('bar-batt');
            battBar.style.width = battPercent + '%';
            battBar.className = `h-full transition-all duration-500 rounded-full ${battPercent < 20 ? 'bg-red-500' : battPercent < 50 ? 'bg-yellow-500' : 'bg-emerald-500'}`;

            document.getElementById('icon-charging').classList.toggle('hidden', dev.ibat <= 0);

            const txtPower = document.getElementById('txt-power-status');
            if (dev.vin < 4.0) {
                txtPower.innerText = 'à¹„à¸Ÿà¸Ÿà¹‰à¸²à¸”à¸±à¸š!';
                txtPower.className = 'text-xs text-red-500 font-semibold';
            } else {
                txtPower.innerText = 'DC Connected';
                txtPower.className = 'text-xs text-emerald-600 dark:text-emerald-400 font-medium';
            }

            const txtSignal = document.getElementById('txt-signal');
            if (dev.rssi > -70) {
                txtSignal.innerText = 'Excellent';
                txtSignal.className = 'text-xs text-emerald-600 dark:text-emerald-400 font-medium';
            } else if (dev.rssi > -85) {
                txtSignal.innerText = 'Good';
                txtSignal.className = 'text-xs text-blue-500 font-medium';
            } else if (dev.rssi > -100) {
                txtSignal.innerText = 'Weak';
                txtSignal.className = 'text-xs text-yellow-500 font-medium';
            } else {
                txtSignal.innerText = 'Poor';
                txtSignal.className = 'text-xs text-red-500 font-medium';
            }

            if (chart) {
                updateChartData(dev);
            } else {
                initChart(dev);
            }
        }

        function renderLogs() {
            const logList = document.getElementById('log-list');
            const logEmpty = document.getElementById('log-empty');
            
            // Show skeleton briefly
            showLogSkeleton();
            
            setTimeout(() => {
                hideLogSkeleton();
                
                // Mark as read
                unreadLogs = 0;
                saveData();
                updateBadges();
                
                // v3.2.3: à¸­à¸±à¸à¹€à¸”à¸• filter counts à¹à¸¥à¸° device dropdown
                updateLogFilterCounts();
                populateLogDeviceDropdown();
                
                // v3.2.3: Filter logs à¸•à¸²à¸¡ type à¹à¸¥à¸° device
                let filteredLogs = logs.filter(log => {
                    const matchType = logFilterType === 'all' || log.type === logFilterType;
                    const matchDevice = logFilterDevice === 'all' || log.dev === logFilterDevice;
                    return matchType && matchDevice;
                });
                
                // v3.2.3: à¹à¸ªà¸”à¸‡à¸ˆà¸³à¸™à¸§à¸™à¸—à¸µà¹ˆ filter à¹à¸¥à¹‰à¸§
                const filteredCountEl = document.getElementById('log-filtered-count');
                if (filteredCountEl) {
                    filteredCountEl.innerText = `à¹à¸ªà¸”à¸‡ ${filteredLogs.length} à¸£à¸²à¸¢à¸à¸²à¸£`;
                }
                
                if (filteredLogs.length === 0) {
                    logList.innerHTML = '';
                    logEmpty?.classList.remove('hidden');
                    // à¹à¸à¹‰à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡ empty state à¸•à¸²à¸¡ filter
                    const emptyText = logEmpty?.querySelector('p');
                    if (emptyText) {
                        emptyText.innerText = logs.length === 0 ? 'No logs yet' : 'à¹„à¸¡à¹ˆà¸à¸š log à¸•à¸²à¸¡ filter à¸—à¸µà¹ˆà¹€à¸¥à¸·à¸­à¸';
                    }
                    return;
                }
                
                logEmpty?.classList.add('hidden');
                
                // PERFORMANCE FIX: Build HTML string first
                const htmlParts = [];
                
                filteredLogs.forEach(log => {
                    const colorClass = log.type === 'crit' ? 'log-crit' : log.type === 'warn' ? 'log-warn' : 'log-info';
                    const iconClass = log.type === 'crit' ? 'text-red-500' : log.type === 'warn' ? 'text-yellow-500' : 'text-blue-500';
                    htmlParts.push(`
                        <div class="log-item p-3 rounded-r-xl bg-white dark:bg-slate-800/60 ${colorClass}" role="article">
                            <div class="flex items-start gap-3">
                                <i class="fa-solid ${log.type === 'crit' ? 'fa-circle-exclamation' : log.type === 'warn' ? 'fa-triangle-exclamation' : 'fa-circle-info'} ${iconClass} mt-0.5" aria-hidden="true"></i>
                                <div class="flex-1 min-w-0">
                                    <div class="flex justify-between items-start gap-2">
                                        <span class="text-sm font-semibold text-slate-800 dark:text-slate-100">${sanitizeHTML(log.dev)}</span>
                                        <span class="text-xs text-slate-500 dark:text-slate-400 font-mono shrink-0">${sanitizeHTML(log.t)}</span>
                                    </div>
                                    <p class="text-xs text-slate-600 dark:text-slate-300 mt-0.5">${sanitizeHTML(log.msg)}</p>
                                </div>
                            </div>
                        </div>
                    `);
                });
                
                logList.innerHTML = htmlParts.join('');
            }, 200);
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // v3.2.3: LOG FILTER FUNCTIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        /** v3.2.3: à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™ filter type à¹à¸¥à¸° render à¹ƒà¸«à¸¡à¹ˆ */
        function setLogFilter(type) {
            logFilterType = type;
            
            // à¸­à¸±à¸à¹€à¸”à¸• UI à¸‚à¸­à¸‡ filter buttons
            document.querySelectorAll('.log-filter-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-emerald-500', 'text-white');
                btn.classList.add('bg-slate-200', 'dark:bg-slate-800', 'text-slate-600', 'dark:text-slate-300');
                btn.setAttribute('aria-pressed', 'false');
            });
            
            const activeBtn = document.getElementById(`log-filter-${type}`);
            if (activeBtn) {
                activeBtn.classList.add('active', 'bg-emerald-500', 'text-white');
                activeBtn.classList.remove('bg-slate-200', 'dark:bg-slate-800', 'text-slate-600', 'dark:text-slate-300');
                activeBtn.setAttribute('aria-pressed', 'true');
            }
            
            renderLogs();
        }
        
        /** v3.2.3: à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™ filter device à¹à¸¥à¸° render à¹ƒà¸«à¸¡à¹ˆ */
        function setLogDeviceFilter(device) {
            logFilterDevice = device;
            renderLogs();
        }
        
        /** v3.2.3: à¸­à¸±à¸à¹€à¸”à¸• count à¹ƒà¸™ filter buttons */
        function updateLogFilterCounts() {
            const counts = {
                all: logs.length,
                crit: logs.filter(l => l.type === 'crit').length,
                warn: logs.filter(l => l.type === 'warn').length,
                info: logs.filter(l => l.type === 'info').length
            };
            
            const countAll = document.getElementById('log-count-all');
            const countCrit = document.getElementById('log-count-crit');
            const countWarn = document.getElementById('log-count-warn');
            const countInfo = document.getElementById('log-count-info');
            
            if (countAll) countAll.innerText = `(${counts.all})`;
            if (countCrit) countCrit.innerText = `(${counts.crit})`;
            if (countWarn) countWarn.innerText = `(${counts.warn})`;
            if (countInfo) countInfo.innerText = `(${counts.info})`;
        }
        
        /** v3.2.3: à¹€à¸•à¸´à¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ device à¹ƒà¸™ dropdown */
        function populateLogDeviceDropdown() {
            const dropdown = document.getElementById('log-device-filter');
            if (!dropdown) return;
            
            // à¹€à¸à¹‡à¸šà¸„à¹ˆà¸²à¸—à¸µà¹ˆà¹€à¸¥à¸·à¸­à¸à¹„à¸§à¹‰à¸à¹ˆà¸­à¸™
            const currentValue = dropdown.value;
            
            // à¸«à¸² unique device names à¸ˆà¸²à¸ logs
            const deviceNames = [...new Set(logs.map(l => l.dev))].sort();
            
            // à¸ªà¸£à¹‰à¸²à¸‡ options à¹ƒà¸«à¸¡à¹ˆ
            let optionsHTML = '<option value="all">à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</option>';
            deviceNames.forEach(name => {
                const count = logs.filter(l => l.dev === name).length;
                const selected = name === currentValue ? 'selected' : '';
                optionsHTML += `<option value="${sanitizeHTML(name)}" ${selected}>${sanitizeHTML(name)} (${count})</option>`;
            });
            
            dropdown.innerHTML = optionsHTML;
            
            // à¸–à¹‰à¸² device à¸—à¸µà¹ˆà¹€à¸¥à¸·à¸­à¸à¹„à¸§à¹‰à¹„à¸¡à¹ˆà¸¡à¸µà¹ƒà¸™ list à¹à¸¥à¹‰à¸§ à¹ƒà¸«à¹‰ reset à¹€à¸›à¹‡à¸™ 'all'
            if (currentValue !== 'all' && !deviceNames.includes(currentValue)) {
                dropdown.value = 'all';
                logFilterDevice = 'all';
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CHART FUNCTIONS (v3.3: ECharts â€” Better Realtime, Dark Theme, DataZoom)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        /**
         * v3.3: à¸ªà¸£à¹‰à¸²à¸‡ ECharts options object
         * Features: dual Y-axis, markLine (threshold), dataZoom, tooltip crosshair
         */
        function getChartOption(dev, historyData) {
            const isDark = document.documentElement.classList.contains('dark');
            
            // v3.3 R4: à¸ªà¸µà¸•à¸²à¸¡ theme â€” minLine à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹€à¸›à¹‡à¸™ cyan à¹„à¸¡à¹ˆà¹ƒà¸«à¹‰à¸‹à¹‰à¸³à¸à¸±à¸š Humidity
            const colors = {
                temp: '#10b981',           // emerald-500
                humi: '#3b82f6',           // blue-500
                minLine: '#06b6d4',        // cyan-500 (à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸ˆà¸²à¸ blue)
                maxLine: '#ef4444',        // red-500
                grid: isDark ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.06)',
                text: isDark ? '#94a3b8' : '#64748b',
                axisLine: isDark ? '#334155' : '#e2e8f0',
                tooltipBg: isDark ? 'rgba(15, 23, 42, 0.95)' : 'rgba(255, 255, 255, 0.95)',
                tooltipBorder: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'
            };
            
            return {
                // v3.3 R4: backgroundColor transparent à¹€à¸à¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¸à¸¥à¸¡à¸à¸¥à¸·à¸™à¸à¸±à¸š panel
                backgroundColor: 'transparent',
                
                // Animation
                animation: true,
                animationDuration: 300,
                
                // v3.3 R5: à¸›à¸£à¸±à¸š Grid â€” à¹€à¸à¸´à¹ˆà¸¡ top à¹€à¸›à¹‡à¸™ 30 à¹„à¸¡à¹ˆà¹ƒà¸«à¹‰à¸•à¸±à¸§à¹€à¸¥à¸‚ Y à¸–à¸¹à¸à¸•à¸±à¸”
                grid: {
                    left: 35,
                    right: 35,
                    top: 30,
                    bottom: 50,
                    containLabel: false
                },
                
                // Tooltip â€” crosshair style
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross',
                        crossStyle: { color: colors.text },
                        lineStyle: { color: colors.text, type: 'dashed' }
                    },
                    backgroundColor: colors.tooltipBg,
                    borderColor: colors.tooltipBorder,
                    borderWidth: 1,
                    textStyle: { color: isDark ? '#e2e8f0' : '#334155', fontSize: 12 },
                    // v3.3 R5: à¸à¸³à¸«à¸™à¸”à¸ªà¸µ marker à¸•à¸£à¸‡à¹† à¹„à¸¡à¹ˆà¹ƒà¸Šà¹‰ p.color
                    formatter: function(params) {
                        if (!params || params.length === 0) return '';
                        let result = `<div style="font-weight:600;margin-bottom:4px">${params[0].axisValue}</div>`;
                        params.forEach(p => {
                            const unit = p.seriesName === 'Temperature' ? 'Â°C' : '%';
                            const val = typeof p.value === 'number' ? p.value.toFixed(1) : '--';
                            // v3.3 R5: à¹ƒà¸Šà¹‰à¸ªà¸µà¸•à¸²à¸¡ seriesName à¹à¸—à¸™ p.color
                            const markerColor = p.seriesName === 'Temperature' ? '#10b981' : '#3b82f6';
                            result += `<div style="display:flex;align-items:center;gap:6px">
                                <span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${markerColor}"></span>
                                <span>${p.seriesName}:</span>
                                <span style="font-weight:600">${val}${unit}</span>
                            </div>`;
                        });
                        return result;
                    }
                },
                
                // v3.3 R5: à¸‹à¹ˆà¸­à¸™ Toolbox à¹€à¸à¸£à¸²à¸°à¸—à¸±à¸šà¹à¸à¸™ Y à¸—à¸±à¹‰à¸‡à¸ªà¸­à¸‡à¸”à¹‰à¸²à¸™
                toolbox: {
                    show: false
                },
                
                // X Axis â€” time labels
                xAxis: {
                    type: 'category',
                    data: historyData.labels,
                    axisLine: { lineStyle: { color: colors.axisLine } },
                    axisLabel: { 
                        color: colors.text, 
                        fontSize: 10,
                        interval: 'auto',
                        rotate: 0
                    },
                    axisTick: { show: false },
                    splitLine: { show: false }
                },
                
                // Y Axis â€” dual axis (temp à¸‹à¹‰à¸²à¸¢, humidity à¸‚à¸§à¸²)
                yAxis: [
                    {
                        type: 'value',
                        name: 'Â°C',
                        nameTextStyle: { color: colors.temp, fontSize: 10, padding: [0, 30, 0, 0] },
                        position: 'left',
                        axisLine: { show: true, lineStyle: { color: colors.temp } },
                        axisLabel: { color: colors.temp, fontSize: 10 },
                        splitLine: { lineStyle: { color: colors.grid, type: 'dashed' } }
                    },
                    {
                        type: 'value',
                        name: '%',
                        nameTextStyle: { color: colors.humi, fontSize: 10, padding: [0, 0, 0, 30] },
                        position: 'right',
                        min: 0,
                        max: 100,
                        axisLine: { show: true, lineStyle: { color: colors.humi } },
                        axisLabel: { color: colors.humi, fontSize: 10 },
                        splitLine: { show: false }
                    }
                ],
                
                // Data Series
                series: [
                    {
                        name: 'Temperature',
                        type: 'line',
                        data: historyData.temp,
                        yAxisIndex: 0,
                        smooth: true,
                        symbol: 'none',
                        // v3.3 R5: à¹€à¸à¸´à¹ˆà¸¡ itemStyle.color à¹€à¸à¸·à¹ˆà¸­à¹ƒà¸«à¹‰ tooltip/legend à¹ƒà¸Šà¹‰à¸ªà¸µà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡
                        itemStyle: { color: colors.temp },
                        lineStyle: { color: colors.temp, width: 2 },
                        areaStyle: { 
                            color: {
                                type: 'linear',
                                x: 0, y: 0, x2: 0, y2: 1,
                                colorStops: [
                                    { offset: 0, color: 'rgba(16, 185, 129, 0.25)' },
                                    { offset: 1, color: 'rgba(16, 185, 129, 0.02)' }
                                ]
                            }
                        },
                        // markLine à¸ªà¸³à¸«à¸£à¸±à¸š min/max threshold
                        markLine: {
                            silent: true,
                            symbol: 'none',
                            lineStyle: { type: 'dashed', width: 1 },
                            label: { 
                                fontSize: 9, 
                                position: 'insideStartTop',
                                formatter: '{b}'
                            },
                            data: [
                                { 
                                    name: 'Min', 
                                    yAxis: dev.min, 
                                    lineStyle: { color: colors.minLine },
                                    label: { color: colors.minLine }
                                },
                                { 
                                    name: 'Max', 
                                    yAxis: dev.max, 
                                    lineStyle: { color: colors.maxLine },
                                    label: { color: colors.maxLine }
                                }
                            ]
                        }
                    },
                    {
                        name: 'Humidity',
                        type: 'line',
                        data: historyData.humi,
                        yAxisIndex: 1,
                        smooth: true,
                        symbol: 'none',
                        // v3.3 R5: à¹€à¸à¸´à¹ˆà¸¡ itemStyle.color à¹€à¸à¸·à¹ˆà¸­à¹ƒà¸«à¹‰ tooltip/legend à¹ƒà¸Šà¹‰à¸ªà¸µà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡
                        itemStyle: { color: colors.humi },
                        lineStyle: { color: colors.humi, width: 1.5, type: 'dashed' }
                    }
                ],
                
                // DataZoom â€” touch-friendly pan/zoom
                dataZoom: [
                    {
                        type: 'inside',    // pinch zoom + pan
                        xAxisIndex: 0,
                        start: 0,
                        end: 100,
                        zoomOnMouseWheel: true,
                        moveOnMouseMove: true,
                        moveOnMouseWheel: false
                    },
                    {
                        type: 'slider',    // slider bar à¸”à¹‰à¸²à¸™à¸¥à¹ˆà¸²à¸‡
                        xAxisIndex: 0,
                        start: 0,
                        end: 100,
                        height: 20,
                        bottom: 5,
                        borderColor: colors.axisLine,
                        fillerColor: isDark ? 'rgba(16, 185, 129, 0.2)' : 'rgba(16, 185, 129, 0.15)',
                        handleStyle: { color: colors.temp, borderColor: colors.temp },
                        textStyle: { color: colors.text, fontSize: 9 },
                        brushSelect: false
                    }
                ]
            };
        }
        
        /**
         * v3.3: Dispose chart instance à¸­à¸¢à¹ˆà¸²à¸‡à¸›à¸¥à¸­à¸”à¸ à¸±à¸¢
         */
        function disposeChart() {
            if (chart) {
                // Cleanup ResizeObserver
                const chartDom = document.getElementById('mainChart');
                if (chartDom && chartDom._resizeObserver) {
                    chartDom._resizeObserver.disconnect();
                    chartDom._resizeObserver = null;
                }
                chart.dispose();
                chart = null;
            }
        }
        
        /**
         * v3.3: Initialize ECharts instance
         * v3.3 R4: à¹„à¸¡à¹ˆà¹ƒà¸Šà¹‰ built-in dark theme à¹€à¸à¸·à¹ˆà¸­à¹ƒà¸«à¹‰ backgroundColor transparent à¸—à¸³à¸‡à¸²à¸™
         */
        function initChart(dev) {
            disposeChart();
            
            const chartDom = document.getElementById('mainChart');
            if (!chartDom) return;
            
            const historyData = getHistoryData(dev, currentTimeRange);
            
            // v3.3 R4: à¹„à¸¡à¹ˆà¹ƒà¸ªà¹ˆ theme à¹€à¸à¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¹ƒà¸Šà¹‰ backgroundColor: 'transparent' à¹„à¸”à¹‰
            chart = echarts.init(chartDom, null, {
                renderer: 'canvas',
                useDirtyRect: true  // performance optimization
            });
            
            // Set option
            chart.setOption(getChartOption(dev, historyData));
            
            // Responsive resize
            const resizeObserver = new ResizeObserver(() => {
                chart?.resize();
            });
            resizeObserver.observe(chartDom);
            
            // à¹€à¸à¹‡à¸š observer à¹„à¸§à¹‰ cleanup à¸—à¸µà¸«à¸¥à¸±à¸‡
            chartDom._resizeObserver = resizeObserver;
        }
        
        /**
         * v3.3: Get history data à¸ªà¸³à¸«à¸£à¸±à¸š chart (à¹ƒà¸Šà¹‰à¹„à¸”à¹‰à¸à¸±à¸šà¸—à¸±à¹‰à¸‡ Chart.js à¹à¸¥à¸° ECharts)
         */
        function getHistoryData(dev, range) {
            let historySource;
            let sampleInterval = 1;
            
            switch(range) {
                case '24h':
                    historySource = dev.history24h || dev.history;
                    sampleInterval = Math.max(1, Math.floor(historySource.length / 48)); // Show ~48 points
                    break;
                case '7d':
                    historySource = dev.history7d || dev.history;
                    sampleInterval = Math.max(1, Math.floor(historySource.length / 42)); // Show ~42 points
                    break;
                default: // 1h
                    historySource = dev.history;
                    sampleInterval = 1;
            }
            
            const sampledHistory = historySource.filter((_, i) => i % sampleInterval === 0);
            
            return {
                labels: sampledHistory.map(x => x.t),
                temp: sampledHistory.map(x => x.v),
                humi: sampledHistory.map(x => x.h)
            };
        }
        
        /**
         * v3.3: Update chart data (ECharts version)
         * v3.3 R4: à¹€à¸à¸´à¹ˆà¸¡ markLine colors à¸„à¸£à¸šà¸–à¹‰à¸§à¸™ à¹„à¸¡à¹ˆà¹ƒà¸«à¹‰à¸ªà¸µà¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸«à¸¥à¸±à¸‡ 3s
         * v3.3 R5: à¹€à¸à¸´à¹ˆà¸¡ itemStyle.color
         */
        function updateChartData(dev) {
            if (!chart) return;
            
            const historyData = getHistoryData(dev, currentTimeRange);
            
            // v3.3 R4: à¸à¸³à¸«à¸™à¸”à¸ªà¸µ markLine à¹ƒà¸«à¹‰à¸„à¸£à¸š à¹„à¸¡à¹ˆà¹ƒà¸«à¹‰ ECharts reset
            const minLineColor = '#06b6d4';  // cyan-500
            const maxLineColor = '#ef4444';  // red-500
            
            // ECharts: à¹ƒà¸Šà¹‰ setOption à¸à¸±à¸š notMerge: false à¹€à¸à¸·à¹ˆà¸­ merge data
            chart.setOption({
                xAxis: { data: historyData.labels },
                series: [
                    { 
                        data: historyData.temp,
                        itemStyle: { color: '#10b981' },  // v3.3 R5
                        markLine: {
                            silent: true,
                            symbol: 'none',
                            lineStyle: { type: 'dashed', width: 1 },
                            label: { 
                                fontSize: 9, 
                                position: 'insideStartTop',
                                formatter: '{b}'
                            },
                            data: [
                                { 
                                    name: 'Min', 
                                    yAxis: dev.min,
                                    lineStyle: { color: minLineColor },
                                    label: { color: minLineColor }
                                },
                                { 
                                    name: 'Max', 
                                    yAxis: dev.max,
                                    lineStyle: { color: maxLineColor },
                                    label: { color: maxLineColor }
                                }
                            ]
                        }
                    },
                    { 
                        data: historyData.humi,
                        itemStyle: { color: '#3b82f6' }  // v3.3 R5
                    }
                ]
            });
        }

        /**
         * v3.3: Change time range à¹à¸¥à¸° update chart
         * v3.3 R4: à¹€à¸à¸´à¹ˆà¸¡ markLine colors à¸„à¸£à¸šà¸–à¹‰à¸§à¸™
         */
        function changeTimeRange(range) {
            currentTimeRange = range;
            
            // Update button UI
            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-white', 'dark:bg-slate-700', 'shadow', 'text-slate-800', 'dark:text-white');
                btn.classList.add('text-slate-500', 'dark:text-slate-400');
                btn.setAttribute('aria-pressed', 'false');
            });
            const activeBtn = document.getElementById(`btn-time-${range}`);
            if (activeBtn) {
                activeBtn.classList.add('active', 'bg-white', 'dark:bg-slate-700', 'shadow', 'text-slate-800', 'dark:text-white');
                activeBtn.classList.remove('text-slate-500', 'dark:text-slate-400');
                activeBtn.setAttribute('aria-pressed', 'true');
            }

            const dev = getDeviceById(selectedId); // v3.3: O(1) lookup
            if (!dev || !chart) return;

            document.getElementById('chart-loader')?.classList.remove('hidden');

            setTimeout(() => {
                const historyData = getHistoryData(dev, range);
                
                // v3.3 R4: à¸à¸³à¸«à¸™à¸”à¸ªà¸µ markLine à¹ƒà¸«à¹‰à¸„à¸£à¸š
                const minLineColor = '#06b6d4';  // cyan-500
                const maxLineColor = '#ef4444';  // red-500
                
                // ECharts: reset dataZoom à¹à¸¥à¸° update data
                chart.setOption({
                    xAxis: { data: historyData.labels },
                    series: [
                        { 
                            data: historyData.temp,
                            itemStyle: { color: '#10b981' },  // v3.3 R5
                            markLine: {
                                silent: true,
                                symbol: 'none',
                                lineStyle: { type: 'dashed', width: 1 },
                                label: { 
                                    fontSize: 9, 
                                    position: 'insideStartTop',
                                    formatter: '{b}'
                                },
                                data: [
                                    { 
                                        name: 'Min', 
                                        yAxis: dev.min,
                                        lineStyle: { color: minLineColor },
                                        label: { color: minLineColor }
                                    },
                                    { 
                                        name: 'Max', 
                                        yAxis: dev.max,
                                        lineStyle: { color: maxLineColor },
                                        label: { color: maxLineColor }
                                    }
                                ]
                            }
                        },
                        { 
                            data: historyData.humi,
                            itemStyle: { color: '#3b82f6' }  // v3.3 R5
                        }
                    ],
                    dataZoom: [
                        { start: 0, end: 100 },
                        { start: 0, end: 100 }
                    ]
                });

                document.getElementById('chart-loader')?.classList.add('hidden');
            }, 300);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DEVICE CRUD OPERATIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function selectDevice(id) {
            selectedId = id;
            // v3.2.2: à¸–à¹‰à¸² simEvent active â†’ à¹€à¸à¹‡à¸š simTargetId à¸”à¹‰à¸§à¸¢
            // à¸—à¸³à¹ƒà¸«à¹‰à¸ªà¸²à¸¡à¸²à¸£à¸–à¸à¸” sim à¸à¹ˆà¸­à¸™ à¹à¸¥à¹‰à¸§à¸„à¹ˆà¸­à¸¢à¹€à¸¥à¸·à¸­à¸ device à¹„à¸”à¹‰
            if (simEvent && simEvent !== 'reset') {
                simTargetId = id;
            }
            currentTimeRange = '1h'; // Reset time range when selecting new device
            prevDetailCache = {}; // v3.2: reset DOM cache à¹€à¸¡à¸·à¹ˆà¸­à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™ device
            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-detail').classList.remove('hidden');
            disposeChart(); // v3.3: cleanup chart à¸à¹ˆà¸­à¸™à¸ªà¸£à¹‰à¸²à¸‡à¹ƒà¸«à¸¡à¹ˆ
            renderDetail();
        }

        function openAddModal() {
            document.getElementById('add-name').value = '';
            document.getElementById('add-hw-id').value = '';
            document.getElementById('add-min').value = '2';
            document.getElementById('add-max').value = '8';
            document.getElementById('add-modal').classList.remove('hidden');
            document.getElementById('add-name').focus();
        }

        function closeAddModal() {
            document.getElementById('add-modal').classList.add('hidden');
        }

        function addDevice() {
            const name = document.getElementById('add-name').value.trim();
            const hwid = document.getElementById('add-hw-id').value.trim();
            const min = parseFloat(document.getElementById('add-min').value);
            const max = parseFloat(document.getElementById('add-max').value);
            // v3.4.0: à¸£à¸±à¸šà¸„à¹ˆà¸² humidity limits
            const humiMin = parseInt(document.getElementById('add-humi-min').value) || 30;
            const humiMax = parseInt(document.getElementById('add-humi-max').value) || 80;

            if (!name) {
                window.Toast?.fire({ icon: 'warning', title: 'à¸à¸£à¸¸à¸“à¸²à¹ƒà¸ªà¹ˆà¸Šà¸·à¹ˆà¸­à¸­à¸¸à¸›à¸à¸£à¸“à¹Œ' });
                return;
            }
            if (isNaN(min) || isNaN(max)) {
                window.Toast?.fire({ icon: 'warning', title: 'à¸„à¹ˆà¸²à¸­à¸¸à¸“à¸«à¸ à¸¹à¸¡à¸´à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡' });
                return;
            }
            if (min >= max) {
                window.Toast?.fire({ icon: 'error', title: 'Min à¸•à¹‰à¸­à¸‡à¸™à¹‰à¸­à¸¢à¸à¸§à¹ˆà¸² Max' });
                return;
            }
            // v3.4.0: à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š humidity limits
            if (humiMin >= humiMax) {
                window.Toast?.fire({ icon: 'error', title: 'Min Humidity à¸•à¹‰à¸­à¸‡à¸™à¹‰à¸­à¸¢à¸à¸§à¹ˆà¸² Max' });
                return;
            }

            const newDev = createDevice('d' + Date.now(), name, hwid || 'N/A', min, max, humiMin, humiMax);
            generateMockHistory(newDev);
            generateExtendedHistory(newDev);
            devices.push(newDev);
            
            // v3.3: Sync deviceMap à¸«à¸¥à¸±à¸‡à¹€à¸à¸´à¹ˆà¸¡ device
            syncDeviceMap();
            
            saveData();
            
            closeAddModal();
            renderList();
            addLog('System', `${siteSettings.displayName}: à¹€à¸à¸´à¹ˆà¸¡à¸­à¸¸à¸›à¸à¸£à¸“à¹Œà¹ƒà¸«à¸¡à¹ˆ ${name}`, 'info');
            window.Toast?.fire({ icon: 'success', title: 'à¹€à¸à¸´à¹ˆà¸¡à¸­à¸¸à¸›à¸à¸£à¸“à¹Œà¸ªà¸³à¹€à¸£à¹‡à¸ˆ!' });
        }

        function openSettings() {
            const dev = getDeviceById(selectedId); // v3.3: O(1) lookup
            if (!dev) return;

            document.getElementById('setting-name').value = dev.name;
            document.getElementById('setting-hwid').value = dev.hw_id || '';
            document.getElementById('setting-min').value = dev.min;
            document.getElementById('setting-max').value = dev.max;
            // v3.4.0: Humidity limits
            document.getElementById('setting-humi-min').value = dev.humi_min ?? 30;
            document.getElementById('setting-humi-max').value = dev.humi_max ?? 80;
            document.getElementById('settings-modal').classList.remove('hidden');
            document.getElementById('setting-name').focus();
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        function saveSettings() {
            const dev = getDeviceById(selectedId); // v3.3: O(1) lookup
            if (!dev) return;

            const name = document.getElementById('setting-name').value.trim();
            const hwid = document.getElementById('setting-hwid').value.trim();
            const min = parseFloat(document.getElementById('setting-min').value);
            const max = parseFloat(document.getElementById('setting-max').value);
            // v3.4.0: Humidity limits
            const humiMin = parseInt(document.getElementById('setting-humi-min').value) || 30;
            const humiMax = parseInt(document.getElementById('setting-humi-max').value) || 80;

            if (!name) {
                window.Toast?.fire({ icon: 'warning', title: 'à¸Šà¸·à¹ˆà¸­à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸§à¹ˆà¸²à¸‡à¹„à¸”à¹‰' });
                return;
            }
            if (min >= max) {
                window.Toast?.fire({ icon: 'error', title: 'Min à¸•à¹‰à¸­à¸‡à¸™à¹‰à¸­à¸¢à¸à¸§à¹ˆà¸² Max' });
                return;
            }
            // v3.4.0: à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š humidity limits
            if (humiMin >= humiMax) {
                window.Toast?.fire({ icon: 'error', title: 'Min Humidity à¸•à¹‰à¸­à¸‡à¸™à¹‰à¸­à¸¢à¸à¸§à¹ˆà¸² Max' });
                return;
            }

            dev.name = name;
            dev.hw_id = hwid || 'N/A';
            dev.min = min;
            dev.max = max;
            dev.humi_min = humiMin;  // v3.4.0
            dev.humi_max = humiMax;  // v3.4.0
            
            saveData();
            closeSettings();
            renderDetail();
            addLog(dev.name, `${siteSettings.displayName}: à¹à¸à¹‰à¹„à¸‚ device ${name}`, 'info');
            window.Toast?.fire({ icon: 'success', title: 'à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!' });
        }

        function deleteDevice() {
            const dev = getDeviceById(selectedId); // v3.3: O(1) lookup
            if (!dev) return;

            Swal.fire({
                title: 'à¸¥à¸šà¸­à¸¸à¸›à¸à¸£à¸“à¹Œ?',
                text: `à¸„à¸¸à¸“à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸¥à¸š "${dev.name}" à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#64748b',
                confirmButtonText: 'à¸¥à¸š',
                cancelButtonText: 'à¸¢à¸à¹€à¸¥à¸´à¸'
            }).then((result) => {
                if (result.isConfirmed) {
                    devices = devices.filter(d => d.id !== selectedId);
                    
                    // v3.3: Sync deviceMap à¸«à¸¥à¸±à¸‡à¸¥à¸š device
                    syncDeviceMap();
                    
                    saveData();
                    closeSettings();
                    switchTab('dashboard');
                    addLog('System', `${siteSettings.displayName}: à¸¥à¸šà¸­à¸¸à¸›à¸à¸£à¸“à¹Œ ${dev.name}`, 'warn');
                    window.Toast?.fire({ icon: 'success', title: 'à¸¥à¸šà¸ªà¸³à¹€à¸£à¹‡à¸ˆ' });
                }
            });
        }

        function acknowledgeAlert() {
            const dev = getDeviceById(selectedId); // v3.3: O(1) lookup
            if (dev) {
                dev.ack = true;
                saveData();
                renderDetail();
                addLog(dev.name, `${siteSettings.displayName}: à¸£à¸±à¸šà¸—à¸£à¸²à¸šà¹€à¸«à¸•à¸¸à¸à¸²à¸£à¸“à¹Œà¹à¸¥à¹‰à¸§`, 'info');
                window.Toast?.fire({ icon: 'info', title: 'à¸›à¸´à¸”à¹€à¸ªà¸µà¸¢à¸‡à¹€à¸•à¸·à¸­à¸™à¹à¸¥à¹‰à¸§' });
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // NAVIGATION & UI
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function switchTab(tab) {
            selectedId = null;
            
            ['view-dashboard', 'view-detail', 'view-logs', 'view-system'].forEach(id => {
                document.getElementById(id)?.classList.add('hidden');
            });

            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-emerald-600', 'dark:text-emerald-400');
                btn.classList.add('text-slate-400', 'dark:text-slate-400');
                btn.removeAttribute('aria-current');
            });

            if (tab === 'logs') {
                document.getElementById('view-logs')?.classList.remove('hidden');
                document.getElementById('nav-logs')?.classList.add('text-emerald-600', 'dark:text-emerald-400');
                document.getElementById('nav-logs')?.classList.remove('text-slate-400', 'dark:text-slate-400');
                document.getElementById('nav-logs')?.setAttribute('aria-current', 'page');
                renderLogs();
            } else if (tab === 'system') {
                document.getElementById('view-system')?.classList.remove('hidden');
                document.getElementById('nav-system')?.classList.add('text-emerald-600', 'dark:text-emerald-400');
                document.getElementById('nav-system')?.classList.remove('text-slate-400', 'dark:text-slate-400');
                document.getElementById('nav-system')?.setAttribute('aria-current', 'page');
                updateCounts();
            } else {
                document.getElementById('view-dashboard')?.classList.remove('hidden');
                document.getElementById('nav-dash')?.classList.add('text-emerald-600', 'dark:text-emerald-400');
                document.getElementById('nav-dash')?.classList.remove('text-slate-400', 'dark:text-slate-400');
                document.getElementById('nav-dash')?.setAttribute('aria-current', 'page');
                renderList();
            }

            if (chart) {
                disposeChart(); // v3.3: ECharts dispose
            }
        }

        function setFilter(type) {
            filterType = type;
            prevDashboardHash = ''; // v3.2: reset hash à¸šà¸±à¸‡à¸„à¸±à¸š re-render
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-emerald-500', 'text-white');
                btn.classList.add('bg-slate-200', 'dark:bg-slate-800', 'text-slate-600', 'dark:text-slate-300');
                btn.setAttribute('aria-pressed', 'false');
            });
            
            const activeBtn = document.getElementById(`filter-${type}`);
            if (activeBtn) {
                activeBtn.classList.add('active', 'bg-emerald-500', 'text-white');
                activeBtn.classList.remove('bg-slate-200', 'dark:bg-slate-800', 'text-slate-600', 'dark:text-slate-300');
                activeBtn.setAttribute('aria-pressed', 'true');
            }
            
            renderList();
        }

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.theme = isDark ? 'dark' : 'light';
            updateThemeUI();
            
            // Update button aria-pressed
            document.getElementById('btn-theme')?.setAttribute('aria-pressed', isDark.toString());
            document.getElementById('toggle-theme')?.setAttribute('aria-checked', isDark.toString());
            
            if (chart && selectedId) {
                const dev = getDeviceById(selectedId); // v3.3: O(1) lookup
                if (dev) initChart(dev);
            }
        }

        function updateThemeUI() {
            const isDark = document.documentElement.classList.contains('dark');
            
            const themeIcon = document.getElementById('theme-icon');
            if (themeIcon) {
                themeIcon.className = isDark ? 'fa-solid fa-moon text-lg' : 'fa-solid fa-sun text-lg';
            }
            
            const toggleThemeEl = document.getElementById('toggle-theme');
            if (toggleThemeEl) {
                toggleThemeEl.classList.toggle('active', isDark);
                toggleThemeEl.setAttribute('aria-checked', isDark.toString());
            }
        }

        function updateAmbientGlow() {
            const glow = document.getElementById('ambient-glow');
            if (!glow) return;

            const hasCritical = devices.some(d => d.status === 'critical' && !d.ack);
            const hasWarning = devices.some(d => d.status === 'warning' || (d.status === 'critical' && d.ack));

            glow.classList.remove('ambient-normal', 'ambient-warning', 'ambient-critical');
            
            if (hasCritical) {
                glow.classList.add('ambient-critical');
            } else if (hasWarning) {
                glow.classList.add('ambient-warning');
            } else {
                glow.classList.add('ambient-normal');
            }
        }

        function updateConnectionStatus() {
            const dot = document.getElementById('connection-dot');
            const text = document.getElementById('connection-text');
            const isOnline = navigator.onLine; // Use actual connection status
            
            // Header connection dot
            if (dot) {
                dot.classList.toggle('online', isOnline);
                dot.classList.toggle('offline', !isOnline);
            }
            if (text) {
                text.innerText = isOnline ? 'Online' : 'Offline';
                text.className = isOnline 
                    ? 'text-xs text-emerald-600 dark:text-emerald-400 font-medium'
                    : 'text-xs text-red-500 font-medium';
            }
            
            // v3.2.1: System tab â€” Internet connection status
            const connInternet = document.getElementById('conn-internet');
            if (connInternet) {
                if (isOnline) {
                    connInternet.innerHTML = '<i class="fa-solid fa-circle text-[8px] mr-1" aria-hidden="true"></i> Online';
                    connInternet.className = 'font-medium text-emerald-600 dark:text-emerald-400';
                } else {
                    connInternet.innerHTML = '<i class="fa-solid fa-circle text-[8px] mr-1" aria-hidden="true"></i> Offline';
                    connInternet.className = 'font-medium text-red-500';
                }
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // LOG FUNCTIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function addLog(device, message, type) {
            const timestamp = new Date().toLocaleString('th-TH');
            logs.unshift({ t: timestamp, dev: device, msg: message, type: type });
            if (logs.length > MAX_LOGS) logs.pop();
            unreadLogs++;
            saveData();
        }

        function clearLogs() {
            Swal.fire({
                title: 'à¸¥à¸š Log à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”?',
                text: 'à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸ˆà¸°à¸–à¸¹à¸à¸¥à¸š',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#64748b',
                confirmButtonText: 'à¸¥à¸šà¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”',
                cancelButtonText: 'à¸¢à¸à¹€à¸¥à¸´à¸'
            }).then((result) => {
                if (result.isConfirmed) {
                    logs = [];
                    unreadLogs = 0;
                    saveData();
                    renderLogs();
                    window.Toast?.fire({ icon: 'success', title: 'à¸¥à¸š Log à¸ªà¸³à¹€à¸£à¹‡à¸ˆ' });
                }
            });
        }

        function exportLogs() {
            if (logs.length === 0) {
                window.Toast?.fire({ icon: 'warning', title: 'à¹„à¸¡à¹ˆà¸¡à¸µ log à¹ƒà¸«à¹‰à¸ªà¹ˆà¸‡à¸­à¸­à¸' });
                return;
            }

            // v3.2.1: à¹€à¸à¸´à¹ˆà¸¡ header row à¹à¸ªà¸”à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆ + à¸§à¸±à¸™à¸—à¸µà¹ˆ export
            const exportDate = new Date().toLocaleString('th-TH');
            let csv = `"${APP_NAME.short} Log Export"\n`;
            csv += `"${siteSettings.hospital}","${siteSettings.unit}","Export: ${exportDate}"\n`;
            csv += `\n`;
            csv += "Date_Time,Device,Message,Type\n";
            csv += logs.map(l => `"${l.t}","${l.dev}","${l.msg}","${l.type}"`).join("\n");

            const link = document.createElement('a');
            link.href = encodeURI('data:text/csv;charset=utf-8,' + csv);
            link.download = `${APP_NAME.brand}_TempMon_Logs_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
            
            // v3.2.2: à¹€à¸à¸´à¹ˆà¸¡ log à¹€à¸¡à¸·à¹ˆà¸­ export logs
            addLog('System', `${siteSettings.displayName}: à¸ªà¹ˆà¸‡à¸­à¸­à¸à¸›à¸£à¸°à¸§à¸±à¸•à¸´ Log (${logs.length} records)`, 'info');
            window.Toast?.fire({ icon: 'success', title: 'à¸ªà¹ˆà¸‡à¸­à¸­à¸ Log à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!' });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // EXPORT FUNCTIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function exportCSV() {
            const dev = getDeviceById(selectedId); // v3.3: O(1) lookup
            if (!dev) return;

            // v3.2: à¹€à¸¥à¸·à¸­à¸ history source à¸•à¸²à¸¡ time range à¸—à¸µà¹ˆà¸à¸³à¸¥à¸±à¸‡à¸”à¸¹à¸­à¸¢à¸¹à¹ˆ
            let historySource;
            let rangeLabel;
            switch (currentTimeRange) {
                case '24h':
                    historySource = dev.history24h || dev.history;
                    rangeLabel = '24H';
                    break;
                case '7d':
                    historySource = dev.history7d || dev.history;
                    rangeLabel = '7D';
                    break;
                default: // '1h'
                    historySource = dev.history;
                    rangeLabel = '1H';
            }

            if (!historySource || historySource.length === 0) {
                window.Toast?.fire({ icon: 'warning', title: 'à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸™à¸Šà¹ˆà¸§à¸‡à¹€à¸§à¸¥à¸²à¸™à¸µà¹‰' });
                return;
            }

            let csv = "Time,Temperature,Humidity\n";
            csv += historySource.map(row => `${row.t},${row.v.toFixed(2)},${row.h.toFixed(1)}`).join("\n");

            const link = document.createElement('a');
            link.href = encodeURI('data:text/csv;charset=utf-8,' + csv);
            link.download = `${dev.name.replace(/\s+/g, '_')}_${rangeLabel}_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
            
            addLog(dev.name, `${siteSettings.displayName}: à¸ªà¹ˆà¸‡à¸­à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ CSV (${rangeLabel} â€” ${historySource.length} records)`, 'info');
            window.Toast?.fire({ icon: 'success', title: `à¸ªà¹ˆà¸‡à¸­à¸­à¸ ${rangeLabel} à¸ªà¸³à¹€à¸£à¹‡à¸ˆ! (${historySource.length} records)` });
        }

        function shareReport() {
            const dev = getDeviceById(selectedId); // v3.3: O(1) lookup
            if (!dev) return;

            const text = `ğŸ“Š à¸£à¸²à¸¢à¸‡à¸²à¸™ ${APP_NAME.short}\n\n` +
                        `à¸­à¸¸à¸›à¸à¸£à¸“à¹Œ: ${dev.name}\n` +
                        `HW ID: ${dev.hw_id}\n` +
                        `à¸­à¸¸à¸“à¸«à¸ à¸¹à¸¡à¸´: ${dev.temp.toFixed(1)}Â°C\n` +
                        `à¸„à¸§à¸²à¸¡à¸Šà¸·à¹‰à¸™: ${dev.humi.toFixed(1)}%\n` +
                        `à¸ªà¸–à¸²à¸™à¸°: ${dev.status.toUpperCase()}\n` +
                        `à¸‚à¸µà¸”à¸ˆà¸³à¸à¸±à¸”: ${dev.min}Â°C ~ ${dev.max}Â°C\n\n` +
                        `à¸§à¸±à¸™à¸—à¸µà¹ˆ: ${new Date().toLocaleString('th-TH')}`;

            if (navigator.share) {
                navigator.share({ title: `${APP_NAME.short} Report`, text: text }).catch(console.error);
            } else {
                navigator.clipboard.writeText(text).then(() => {
                    window.Toast?.fire({ icon: 'success', title: 'à¸„à¸±à¸”à¸¥à¸­à¸à¸£à¸²à¸¢à¸‡à¸²à¸™à¹à¸¥à¹‰à¸§!' });
                }).catch(() => {
                    window.Toast?.fire({ icon: 'error', title: 'à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸„à¸±à¸”à¸¥à¸­à¸à¹„à¸”à¹‰' });
                });
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // AUDIO SYSTEM
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function initAudio() {
            try {
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
            } catch (e) {
                console.warn('Web Audio API not supported:', e);
            }
        }

        function toggleAudio() {
            audioEnabled = !audioEnabled;
            
            const btn = document.getElementById('btn-audio');
            if (btn) {
                btn.innerHTML = audioEnabled 
                    ? '<i class="fa-solid fa-volume-high text-lg" aria-hidden="true"></i>' 
                    : '<i class="fa-solid fa-volume-xmark text-lg text-red-500" aria-hidden="true"></i>';
                btn.setAttribute('aria-pressed', audioEnabled.toString());
            }
            
            const toggleEl = document.getElementById('toggle-audio');
            if (toggleEl) {
                toggleEl.classList.toggle('active', audioEnabled);
                toggleEl.setAttribute('aria-checked', audioEnabled.toString());
            }
            
            window.Toast?.fire({ 
                icon: audioEnabled ? 'success' : 'info', 
                title: audioEnabled ? 'à¹€à¸›à¸´à¸”à¹€à¸ªà¸µà¸¢à¸‡à¹à¸¥à¹‰à¸§' : 'à¸›à¸´à¸”à¹€à¸ªà¸µà¸¢à¸‡à¹à¸¥à¹‰à¸§' 
            });
        }

        function playAlert() {
            if (!audioEnabled || !audioCtx) return;
            
            if (window.lastBeep && Date.now() - window.lastBeep < 1000) return;
            window.lastBeep = Date.now();

            try {
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();

                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(440, audioCtx.currentTime + 0.15);

                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);

                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);

                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.2);
            } catch (e) {
                console.warn('Error playing alert:', e);
            }
        }

        function testAudio() {
            if (!audioCtx) initAudio();
            
            const tempEnabled = audioEnabled;
            audioEnabled = true;
            playAlert();
            audioEnabled = tempEnabled;
            
            window.Toast?.fire({ icon: 'info', title: 'ğŸ”Š à¸—à¸”à¸ªà¸­à¸šà¹€à¸ªà¸µà¸¢à¸‡' });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SIMULATION & SYSTEM
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function setSimEvent(event) {
            simEvent = (simEvent === event) ? null : event;
            
            // v3.2.2: à¹€à¸à¹‡à¸š simTargetId à¹€à¸¡à¸·à¹ˆà¸­à¹€à¸›à¸´à¸” simulation (à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆ reset)
            // à¸—à¸³à¹ƒà¸«à¹‰ sim à¸„à¹‰à¸²à¸‡à¸­à¸¢à¸¹à¹ˆà¹à¸¡à¹‰à¸ˆà¸°à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸«à¸™à¹‰à¸²à¹„à¸›à¸”à¸¹ Logs/System
            if (simEvent && event !== 'reset') {
                simTargetId = selectedId;
            } else if (event === 'reset' || !simEvent) {
                simTargetId = null;
            }
            
            const eventNames = {
                'temp_high': 'ğŸ”¥ à¸ˆà¸³à¸¥à¸­à¸‡à¸­à¸¸à¸“à¸«à¸ à¸¹à¸¡à¸´à¸ªà¸¹à¸‡',
                'temp_low': 'ğŸ¥¶ à¸ˆà¸³à¸¥à¸­à¸‡à¸­à¸¸à¸“à¸«à¸ à¸¹à¸¡à¸´à¸•à¹ˆà¸³',
                'ac_off': 'âš¡ à¸ˆà¸³à¸¥à¸­à¸‡à¹„à¸Ÿà¸”à¸±à¸š',
                'batt_low': 'ğŸ”‹ à¸ˆà¸³à¸¥à¸­à¸‡à¹à¸šà¸•à¹€à¸•à¸­à¸£à¸µà¹ˆà¸•à¹ˆà¸³',
                'offline': 'ğŸ“¡ à¸ˆà¸³à¸¥à¸­à¸‡à¸‚à¸²à¸”à¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­',
                'rssi_low': 'ğŸ“¶ à¸ˆà¸³à¸¥à¸­à¸‡à¸ªà¸±à¸à¸à¸²à¸“à¸­à¹ˆà¸­à¸™',
                'humi_high': 'ğŸ’§ à¸ˆà¸³à¸¥à¸­à¸‡à¸„à¸§à¸²à¸¡à¸Šà¸·à¹‰à¸™à¸ªà¸¹à¸‡',  // v3.4.0
                'humi_low': 'ğŸœï¸ à¸ˆà¸³à¸¥à¸­à¸‡à¸„à¸§à¸²à¸¡à¸Šà¸·à¹‰à¸™à¸•à¹ˆà¸³',   // v3.4.0
                'reset': 'ğŸ”„ à¸£à¸µà¹€à¸‹à¹‡à¸•à¸à¸²à¸£à¸ˆà¸³à¸¥à¸­à¸‡'
            };

            if (simEvent) {
                window.Toast?.fire({ 
                    icon: event === 'reset' ? 'success' : 'warning', 
                    title: eventNames[event] || 'Simulation Active'
                });
            }
        }

        function factoryReset() {
            // v3.2.2: à¹ƒà¸Šà¹‰ Swal à¸–à¹‰à¸²à¸¡à¸µ, fallback à¹„à¸› window.confirm
            const doReset = () => {
                console.log('ğŸ”„ Factory Reset: Clearing localStorage...');
                isResetting = true; // v3.2.2: à¸›à¹‰à¸­à¸‡à¸à¸±à¸™ visibilitychange save à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸¥à¸±à¸š
                localStorage.removeItem(DB_KEY);
                localStorage.removeItem(SITE_SETTINGS_KEY);
                console.log('âœ… Factory Reset: Done, reloading...');
                window.Toast?.fire({ icon: 'success', title: 'à¸£à¸µà¹€à¸‹à¹‡à¸•à¸ªà¸³à¹€à¸£à¹‡à¸ˆ à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¹ƒà¸«à¸¡à¹ˆ...' });
                setTimeout(() => location.reload(), 500);
            };
            
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    title: 'à¸£à¸µà¹€à¸‹à¹‡à¸•à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”?',
                    text: 'à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸­à¸¸à¸›à¸à¸£à¸“à¹Œ, log à¹à¸¥à¸°à¸à¸²à¸£à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆà¸ˆà¸°à¸–à¸¹à¸à¸¥à¸š',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#ef4444',
                    cancelButtonColor: '#64748b',
                    confirmButtonText: 'à¸£à¸µà¹€à¸‹à¹‡à¸•',
                    cancelButtonText: 'à¸¢à¸à¹€à¸¥à¸´à¸'
                }).then((result) => {
                    if (result.isConfirmed) {
                        doReset();
                    }
                }).catch((err) => {
                    console.error('Swal error:', err);
                    if (confirm('à¸£à¸µà¹€à¸‹à¹‡à¸•à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”?')) doReset();
                });
            } else {
                // Fallback à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µ SweetAlert
                if (confirm('à¸£à¸µà¹€à¸‹à¹‡à¸•à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”? (à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸­à¸¸à¸›à¸à¸£à¸“à¹Œ, log à¹à¸¥à¸°à¸à¸²à¸£à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆà¸ˆà¸°à¸–à¸¹à¸à¸¥à¸š)')) {
                    doReset();
                }
            }
        }
        
        // Listen for online/offline events
        window.addEventListener('online', updateConnectionStatus);
        window.addEventListener('offline', updateConnectionStatus);
        
        // v3.2 Task #7: save à¹€à¸¡à¸·à¹ˆà¸­à¸›à¸´à¸”à¹à¸—à¹‡à¸š/à¸ªà¸¥à¸±à¸šà¹à¸­à¸›
        // v3.2.2: à¹€à¸à¸´à¹ˆà¸¡ check isResetting à¹€à¸à¸·à¹ˆà¸­à¸›à¹‰à¸­à¸‡à¸à¸±à¸™ save à¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡ factory reset
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden' && !isResetting) {
                saveData(); // à¸šà¸±à¸‡à¸„à¸±à¸š save à¸—à¸±à¸™à¸—à¸µ (à¹„à¸¡à¹ˆ throttle)
            }
        });
        
        // v3.2 Task #3: ESC key à¸›à¸´à¸” modal (v3.2.1: à¹€à¸à¸´à¹ˆà¸¡ site-settings-modal)
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const settingsModal = document.getElementById('settings-modal');
                const addModal = document.getElementById('add-modal');
                const siteModal = document.getElementById('site-settings-modal');
                if (settingsModal && !settingsModal.classList.contains('hidden')) {
                    closeSettings();
                } else if (addModal && !addModal.classList.contains('hidden')) {
                    closeAddModal();
                } else if (siteModal && !siteModal.classList.contains('hidden')) {
                    closeSiteSettingsModal();
                }
            }
        });
        
        // v3.2 Task #3: à¸„à¸¥à¸´à¸ backdrop à¸›à¸´à¸” modal (v3.2.1: à¹€à¸à¸´à¹ˆà¸¡ site-settings-modal)
        document.getElementById('settings-modal')?.addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeSettings();
        });
        document.getElementById('add-modal')?.addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeAddModal();
        });
        document.getElementById('site-settings-modal')?.addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeSiteSettingsModal();
        });
    </script>

</body>
</html>
